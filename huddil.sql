-- MySQL dump 10.13  Distrib 5.7.12, for Win64 (x86_64)
--
-- Host: localhost    Database: huddil
-- ------------------------------------------------------
-- Server version	5.7.21-0ubuntu0.16.04.1

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Current Database: `huddil`
--

CREATE DATABASE /*!32312 IF NOT EXISTS*/ `huddil` /*!40100 DEFAULT CHARACTER SET utf8 */;

USE `huddil`;

--
-- Table structure for table `amenity`
--

DROP TABLE IF EXISTS `amenity`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `amenity` (
  `id` tinyint(1) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  `icon` mediumtext NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name_UNIQUE` (`name`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `amenity`
--

LOCK TABLES `amenity` WRITE;
/*!40000 ALTER TABLE `amenity` DISABLE KEYS */;
INSERT INTO `amenity` VALUES (1,'Power Backup','<svg width=\"22\" height=\"22\" xmlns=\"http://www.w3.org/2000/svg\"><defs><style>.cls-1{fill:#fff;}</style></defs><title>battery_charging_full - material</title><g><title>background</title><rect fill=\"none\" id=\"canvas_background\" height=\"24\" width=\"24\" y=\"-1\" x=\"-1\"/></g><g><title>Layer 1</title><g stroke=\"null\" id=\"svg_3\"><path stroke=\"null\" id=\"svg_1\" d=\"m8.7957,2.182801l0,-2.180974l4.386246,0l0,2.180974c0.597727,0 1.14297,0 1.688214,0c1.030228,0.007775 1.652253,0.63466 1.652253,1.672663q0,8.209753 0,16.416591c0,1.069105 -0.657014,1.725146 -1.720287,1.726118q-3.813789,0 -7.625633,0c-1.048695,0 -1.697933,-0.644379 -1.698905,-1.690158q0,-8.232107 0,-16.465187c0,-1.049667 0.606474,-1.652253 1.652253,-1.660028c0.533581,-0.002916 1.065217,0 1.66586,0zm3.282152,3.521243l-0.090388,-0.024298l-4.29197,8.050359l2.206244,0l0,5.792604l0.105939,0.02527l4.288082,-8.0455l-2.217907,0l0,-5.798436z\"/><path stroke=\"null\" id=\"svg_2\" d=\"m12.077852,5.704044l0,5.798436l2.218879,0l-4.288082,8.0455l-0.105939,-0.02527l0,-5.792604l-2.207216,0l4.290998,-8.050359l0.09136,0.024298z\" class=\"cls-1\"/></g></g></svg>'),(2,'WiFi','<svg width=\"22\" height=\"22\" xmlns=\"http://www.w3.org/2000/svg\"><title>wifi_icon_shutterstock</title><g><title>background</title><rect fill=\"none\" id=\"canvas_background\" height=\"24\" width=\"24\" y=\"-1\" x=\"-1\"/></g><g><title>Layer 1</title><g stroke=\"null\" id=\"svg_5\"><path stroke=\"null\" id=\"svg_1\" d=\"m20.860108,9.632193c-0.19792,0.005163 -0.458945,-0.195625 -0.694727,-0.469844a12.058193,12.058193 0 0 0 -4.338747,-3.212612c-4.769581,-2.105408 -10.463361,-0.832984 -13.89225,3.092712c-0.193904,0.222014 -0.442308,0.436571 -0.709643,0.544423c-0.405019,0.162925 -0.860521,-0.04991 -1.093435,-0.414771c-0.242093,-0.38035 -0.215704,-0.835279 0.087199,-1.198419a13.986908,13.986908 0 0 1 3.26998,-2.855782c5.883095,-3.73294 13.677694,-2.561484 18.200018,2.731294c0.24783,0.290282 0.407887,0.597775 0.317819,0.993041c-0.105557,0.462387 -0.493365,0.7825 -1.146214,0.789958z\"/><path stroke=\"null\" id=\"svg_2\" d=\"m11.431666,6.972609c2.5982,0.061384 5.125837,1.196124 7.148061,3.442084c0.239225,0.265614 0.41764,0.554175 0.360271,0.927642c-0.063105,0.413624 -0.294872,0.705054 -0.697022,0.830116c-0.414771,0.129078 -0.754964,-0.009179 -1.068193,-0.303477c-0.562207,-0.527786 -1.097451,-1.105483 -1.730221,-1.534596c-3.3044,-2.240797 -7.75272,-1.663674 -10.422056,1.308566c-0.063679,0.071136 -0.12621,0.14342 -0.190462,0.213983c-0.394119,0.431408 -0.990746,0.486481 -1.413549,0.131947c-0.432555,-0.36314 -0.487629,-0.982715 -0.107852,-1.434202a9.954506,9.954506 0 0 1 2.765714,-2.294723c1.503043,-0.843311 3.210891,-1.289634 5.355309,-1.287339z\"/><path stroke=\"null\" id=\"svg_3\" d=\"m15.917275,13.766135c-0.053926,0.44575 -0.30233,0.822084 -0.683254,0.975257s-0.793974,0.052779 -1.108351,-0.240946c-0.333882,-0.312082 -0.65457,-0.653996 -1.037788,-0.892647c-1.676295,-1.043525 -3.786292,-0.706201 -5.122968,0.792827c-0.269056,0.30233 -0.583433,0.468123 -0.985583,0.397561c-0.787664,-0.137683 -1.104335,-1.046967 -0.570239,-1.663674c1.223087,-1.40896 2.777188,-2.132945 4.64165,-2.119176c1.820289,0.013195 3.337674,0.733164 4.532077,2.110571c0.150304,0.178415 0.223735,0.425097 0.334456,0.640228z\"/><path stroke=\"null\" id=\"svg_4\" d=\"m10.992227,15.042575a2.007882,2.007882 0 1 1 -2.000998,2.010751a1.995835,1.995835 0 0 1 2.000998,-2.010751z\"/></g></g></svg>'),(3,'Projector','<svg width=\"22\" height=\"22\" xmlns=\"http://www.w3.org/2000/svg\"><!-- Generator: Sketch 47.1 (45422) - http://www.bohemiancoding.com/sketch --><title>projector</title><desc>Created with Sketch.</desc><g><title>background</title><rect fill=\"none\" id=\"canvas_background\" height=\"24\" width=\"24\" y=\"-1\" x=\"-1\"/></g><g><title>Layer 1</title><g fill-rule=\"evenodd\" fill=\"none\" id=\"Page-1\"><g stroke=\"null\" fill=\"#000000\" fill-rule=\"nonzero\" id=\"Facility---Deactive-Page\"><g stroke=\"null\" id=\"Group-7\"><g stroke=\"null\" id=\"Group-26\"><g stroke=\"null\" id=\"projector\"><ellipse stroke=\"null\" ry=\"2.40739\" rx=\"2.063477\" cy=\"10.656087\" cx=\"16.507815\" id=\"Oval\"/><path stroke=\"null\" id=\"Shape\" d=\"m19.527693,6.527799c-0.762427,-0.634333 -1.730865,-1.030404 -2.79967,-1.030404c-1.060882,0 -2.020955,0.389921 -2.779861,1.014144l-11.307406,0c-1.452653,0 -2.640755,1.187338 -2.640755,2.637557l0,3.516742c0,1.450218 1.188102,2.637557 2.640755,2.637557l0,0.759614c0,0.241778 0.198094,0.439596 0.440202,0.439596l1.456182,0c0.241668,0 0.440202,-0.197819 0.440202,-0.439596l0,-0.760054l12.0553,0l0,0.759621c0,0.241771 0.198534,0.439589 0.440202,0.439589l1.456622,0c0.242108,0 0.440202,-0.197819 0.440202,-0.439589l0,-0.759621c1.452653,0 2.640755,-1.187338 2.640755,-2.637557l0,-3.516742c-0.00044,-1.395708 -1.104022,-2.536893 -2.482727,-2.620856zm-16.441013,6.137599c0,0.242218 -0.335432,0.439596 -0.744819,0.439596c-0.407626,0 -0.743498,-0.197378 -0.743498,-0.439596l0,-3.516742c0,-0.241778 0.336312,-0.439596 0.743498,-0.439596c0.409827,0 0.744819,0.197819 0.744819,0.439596l0,3.516742zm2.344942,0c0,0.242218 -0.333231,0.439596 -0.743058,0.439596c-0.4085,0 -0.743491,-0.197378 -0.743491,-0.439596l0,-3.516742c0,-0.241778 0.335432,-0.439596 0.743491,-0.439596c0.410267,0 0.743058,0.197819 0.743058,0.439596l0,3.516742zm2.346703,0c0,0.242218 -0.336312,0.439596 -0.743491,0.439596c-0.409827,0 -0.744819,-0.197378 -0.744819,-0.439596l0,-3.516742c0,-0.241778 0.335432,-0.439596 0.744819,-0.439596c0.407619,0 0.743491,0.197819 0.743491,0.439596l0,3.516742zm8.949698,0.304638c-1.700931,0 -3.081837,-1.378121 -3.081837,-3.077153c0,-1.699466 1.380906,-3.077146 3.081837,-3.077146c1.701371,0 3.081837,1.37768 3.081837,3.077146c0,1.699466 -1.380466,3.077153 -3.081837,3.077153z\"/></g></g></g></g></g></g></svg>'),(4,'Security','<svg width=\"22\" height=\"22\" xmlns=\"http://www.w3.org/2000/svg\"><!-- Generator: Sketch 47.1 (45422) - http://www.bohemiancoding.com/sketch --><title>policeman</title><desc>Created with Sketch.</desc><g><title>background</title><rect fill=\"none\" id=\"canvas_background\" height=\"24\" width=\"24\" y=\"-1\" x=\"-1\"/></g><g><title>Layer 1</title><g fill-rule=\"evenodd\" fill=\"none\" id=\"Page-1\"><g stroke=\"null\" fill=\"#000000\" fill-rule=\"nonzero\" id=\"Facility---Deactive-Page\"><g stroke=\"null\" id=\"Group-7\"><g stroke=\"null\" id=\"Group-25\"><g stroke=\"null\" id=\"policeman\"><path stroke=\"null\" id=\"Shape\" d=\"m17.277355,14.868001c-2.038036,-0.813971 -2.626027,-1.057888 -2.821871,-1.098792c-0.039389,0 -0.117415,0 -0.156859,0.040904l-1.842137,1.301961c-0.038994,0.040959 -0.07798,0.081449 -0.07798,0.16289c0,0.040546 0,0.121986 0.038985,0.162945l0.940694,0.97665l-1.058109,1.098801c-0.078576,0.081596 -0.078576,0.203582 0,0.285023l0.94029,1.26148l-1.29314,2.686263c-0.03904,0.081183 -0.03904,0.122087 0,0.203582c0.039389,0.040491 0.117415,0.081027 0.15685,0.081027l7.838187,0c0.117617,0 0.196092,-0.081027 0.196092,-0.203426c0.078283,-0.936113 0.352354,-5.656924 -2.861003,-6.959307z\"/><path stroke=\"null\" id=\"Shape\" d=\"m8.759337,19.034124l0.940584,-1.255743c0.078429,-0.080577 0.039242,-0.202582 0,-0.283214l-1.0582,-1.093395l0.940685,-0.972271c0.03904,-0.040289 0.078328,-0.121389 0.03904,-0.161678c0,-0.040702 -0.03904,-0.121747 -0.078227,-0.162082l-1.842036,-1.295986c-0.039233,-0.040546 -0.117516,-0.040546 -0.156758,-0.040546c-0.156749,0.040546 -0.744483,0.283627 -2.821706,1.093606c-3.213642,1.336366 -2.939469,6.03398 -2.860948,6.965494c0,0.121747 0.078429,0.202426 0.195853,0.202426l7.838242,0l0,0c0.078429,0 0.11747,-0.040344 0.156758,-0.080632c0.039242,-0.040702 0.039242,-0.121747 0,-0.202582l-1.293287,-2.713397z\"/><path stroke=\"null\" id=\"Shape\" d=\"m12.757107,18.377498l-1.061982,-1.273606l1.022841,-0.97441c0.039141,-0.037324 0.039141,-0.074592 0.039141,-0.149616c0,-0.075125 -0.039141,-0.112393 -0.039141,-0.150149l-1.141018,-1.086326c-0.078484,-0.074978 -0.196707,-0.074978 -0.275246,0l-1.141165,1.086326c-0.07853,0.074978 -0.07853,0.187463 0,0.262395l1.022988,0.973887l-1.062129,1.274129c-0.039343,0.037269 -0.039343,0.112292 -0.039343,0.18727l1.180315,2.472757c0.039389,0.074978 0.11792,0.112632 0.196753,0.112632c0.078484,0 0.157272,-0.037654 0.196716,-0.112632l1.180058,-2.472757c0,0.000101 0,-0.074877 -0.078787,-0.149901z\"/><path stroke=\"null\" id=\"Shape\" d=\"m14.51728,7.372136c-1.003702,-0.602394 -2.509292,-0.946505 -4.014734,-0.946505c-1.505645,0 -3.011234,0.344111 -4.014927,0.946505c-0.038756,0.043079 -0.077355,0.086113 -0.077355,0.129137c0,0.042978 0,0.129027 0.038655,0.172115c0.849478,1.463061 3.127143,1.506085 3.590239,1.506085l0,0l1.003546,0c0.463343,0 2.741248,-0.086223 3.590679,-1.506085c0.038407,-0.043033 0.038407,-0.129137 0.038407,-0.172115c-0.077254,-0.043024 -0.115716,-0.129137 -0.154509,-0.129137z\"/><path stroke=\"null\" id=\"Shape\" d=\"m10.944832,13.769209l0,0l0,0c2.572097,-0.040766 4.644905,-2.253606 4.644905,-4.998856c0,-0.082 0,-0.204867 0,-0.327891c0,-0.081899 -0.038196,-0.163899 -0.115065,-0.163899c-0.076777,-0.041124 -0.153655,0 -0.191842,0.041032c-1.113553,1.188182 -3.148109,1.31126 -3.762271,1.31126l-1.036574,0c-0.614116,0 -2.648875,-0.082 -3.762179,-1.31126c-0.038434,-0.041032 -0.115065,-0.08211 -0.191842,-0.041032c-0.076924,0.041032 -0.115111,0.082 -0.115111,0.163899c0,0.122968 0,0.204767 0,0.327891c-0.115313,2.74525 1.957789,4.958035 4.529978,4.998856z\"/><path stroke=\"null\" id=\"Shape\" d=\"m5.579604,5.428961c0.077098,0.039389 0.153995,0.078723 0.231194,0.039389c0.693344,-0.393441 2.850851,-1.062047 4.738582,-1.062047c1.926074,0 4.083874,0.66866 4.777356,1.062047c0.038333,0 0.077052,0.039334 0.077052,0.039334c0.038379,0 0.077098,0 0.115478,-0.039334c0.462388,-0.432775 0.808858,-0.747384 0.924722,-0.865404c0.076906,-0.078723 0.076906,-0.196689 0.038379,-0.275412c-0.038379,-0.039444 -0.077098,-0.078833 -0.115469,-0.157355c-0.192576,-0.196698 -0.462398,-0.5116 -0.57782,-1.022905l-0.077245,-0.275513c-0.077098,-0.707994 -0.115478,-0.983415 -0.808914,-1.062047l-0.192521,0c-0.73221,-0.078723 -1.888034,-0.196689 -2.81271,-1.022896c-0.770635,-0.707994 -1.078487,-0.786819 -1.309681,-0.786819c-0.231295,0 -0.539386,0.078824 -1.309874,0.786819c-0.92463,0.826208 -2.080362,0.944173 -2.812517,1.022896l-0.192677,0c-0.693335,0.078631 -0.770534,0.354052 -0.885957,1.022905l-0.077199,0.27532c-0.115469,0.511499 -0.38529,0.786819 -0.577912,1.022896c-0.03837,0.039343 -0.076896,0.117864 -0.115469,0.157254c-0.077098,0.078833 -0.038572,0.196698 0.038572,0.275522c0.154096,0.117864 0.462196,0.432775 0.92463,0.865349z\"/><path stroke=\"null\" id=\"Shape\" d=\"m15.398602,6.384011c0.038444,-0.041721 0.076493,-0.083496 0.114597,-0.166993l0.076538,-0.41728c0,-0.083386 -0.038049,-0.208613 -0.114642,-0.208613c-0.535549,-0.250168 -2.448037,-1.001389 -4.47492,-1.001389c-2.065473,0 -3.939766,0.751221 -4.475268,1.001389c-0.076346,0.04173 -0.114642,0.125226 -0.114642,0.208613l0.076346,0.41728c0,0.083496 0.038251,0.125217 0.11489,0.166993c0.038242,0 0.038242,0.04162 0.0763,0.04162c0.038297,0 0.076538,0 0.076538,-0.04162c1.109211,-0.584218 2.60093,-0.917993 4.283987,-0.917993c1.644604,0 3.174528,0.333775 4.283583,0.917993c-0.037902,0 0.038646,0 0.076694,0z\"/></g></g></g></g></g></g></svg>'),(5,'AC','<svg width=\"22\" height=\"22\" xmlns=\"http://www.w3.org/2000/svg\"><!-- Generator: Sketch 47.1 (45422) - http://www.bohemiancoding.com/sketch --><title>minisplit</title><desc>Created with Sketch.</desc><g><title>background</title><rect x=\"-1\" y=\"-1\" width=\"24\" height=\"24\" id=\"canvas_background\" fill=\"none\"/></g><g><title>Layer 1</title><g stroke=\"null\" id=\"Page-1\" fill=\"none\" fill-rule=\"evenodd\"><g stroke=\"null\" id=\"Facility---Deactive-Page\" fill-rule=\"nonzero\" fill=\"#000000\"><g stroke=\"null\" id=\"Group-7\"><g stroke=\"null\" id=\"Group-24\"><g stroke=\"null\" id=\"minisplit\"><path stroke=\"null\" d=\"m2.057255,12.294874l0.866116,0c0,0 0.105189,-0.483946 0.235764,-1.080993c0.129979,-0.596769 1.159832,-1.080993 2.299282,-1.080993l11.349761,0c1.139794,0 2.127336,0.484225 2.205922,1.080993l0.141892,1.080993l0.786753,0c1.139451,0 2.063687,-0.984739 2.063687,-2.198884l0,-4.104493c0,-1.013815 -0.647275,-1.858585 -1.523154,-2.113306c0.049574,0.207698 0.078592,0.42367 0.078592,0.64701l0,0.879556c0,1.455251 -1.110782,2.638662 -2.476408,2.638662l-14.171007,0c-1.365717,0 -2.476324,-1.183412 -2.476324,-2.638662l0,-0.879556c0,-0.22334 0.028759,-0.439312 0.078418,-0.64701c-0.875872,0.254624 -1.522979,1.099491 -1.522979,2.113306l0,4.104493c0,1.214514 0.923977,2.198884 2.063687,2.198884z\" id=\"Shape\"/><path stroke=\"null\" d=\"m2.940197,7.115377l14.177294,0c0.911423,0 1.651755,-0.757501 1.651755,-1.688963l0,-0.844349c0,-0.252144 -0.057285,-0.489009 -0.154841,-0.703874l-17.171121,0c-0.097206,0.214865 -0.154841,0.451639 -0.154841,0.703874l0,0.844439c0,0.931371 0.741199,1.688872 1.651755,1.688872zm-0.819396,-2.489493l15.588662,0c0.11415,0 0.206513,0.094623 0.206513,0.211155c0,0.116532 -0.092279,0.211155 -0.206513,0.211155l-15.588662,0c-0.113884,0 -0.206513,-0.094623 -0.206513,-0.211155c0,-0.116532 0.092195,-0.211155 0.206513,-0.211155zm0,1.319581l15.588662,0c0.11415,0 0.206513,0.094623 0.206513,0.211065c0,0.116532 -0.092279,0.211155 -0.206513,0.211155l-15.588662,0c-0.113884,0 -0.206513,-0.094623 -0.206513,-0.211155c0,-0.116532 0.092195,-0.211065 0.206513,-0.211065z\" id=\"Shape\"/><path stroke=\"null\" d=\"m17.369318,10.352563c-0.057823,-0.357495 -0.989828,-0.647437 -2.081977,-0.647437l-9.816701,0c-1.09132,0 -2.035814,0.289871 -2.108282,0.647437c-0.072707,0.357716 -0.131605,0.647437 -0.131605,0.647437l14.243617,0l-0.105053,-0.647437z\" id=\"Shape\"/><path stroke=\"null\" d=\"m4.64635,18.038011c0.064148,0.056295 0.143213,0.083798 0.222,0.083798c0.095128,0 0.189822,-0.040284 0.256812,-0.118267c0.052572,-0.061688 1.27718,-1.516175 0.3486,-2.69721c-0.515049,-0.655543 -0.134479,-1.036346 -0.051575,-1.107364c0.143861,-0.118559 0.167233,-0.332478 0.051225,-0.4799c-0.116869,-0.14814 -0.330413,-0.172633 -0.477116,-0.05465c-0.355702,0.286517 -0.825217,1.087546 -0.054203,2.068814c0.578064,0.735249 -0.321601,1.810441 -0.330413,1.820788c-0.122191,0.142896 -0.106918,0.35969 0.03467,0.483992z\" id=\"Shape\"/><path stroke=\"null\" d=\"m7.883484,18.038011c0.064155,0.056295 0.14322,0.083798 0.222006,0.083798c0.095199,0 0.189829,-0.040284 0.256819,-0.118267c0.052572,-0.061688 1.277206,-1.516175 0.348677,-2.69721c-0.515056,-0.655543 -0.134479,-1.036346 -0.051575,-1.107364c0.143932,-0.118559 0.167304,-0.332478 0.051219,-0.4799c-0.116862,-0.14814 -0.330348,-0.172633 -0.477122,-0.05465c-0.35578,0.286517 -0.82523,1.087546 -0.054203,2.068814c0.578071,0.735249 -0.321608,1.810441 -0.33042,1.820788c-0.122262,0.142896 -0.106989,0.35969 0.034599,0.483992z\" id=\"Shape\"/><path stroke=\"null\" d=\"m12.415816,18.038011c0.063934,0.056295 0.143213,0.083798 0.22178,0.083798c0.095121,0 0.189958,-0.040284 0.256942,-0.118267c0.052358,-0.061688 1.277109,-1.516175 0.348438,-2.69721c-0.514874,-0.655543 -0.13433,-1.036346 -0.051432,-1.107364c0.143854,-0.118559 0.167084,-0.332478 0.051076,-0.4799c-0.116785,-0.14814 -0.33018,-0.172633 -0.477083,-0.05465c-0.355754,0.286517 -0.825243,1.087546 -0.054061,2.068814c0.577818,0.735249 -0.321582,1.810441 -0.330536,1.820788c-0.122327,0.142896 -0.107054,0.35969 0.034877,0.483992z\" id=\"Shape\"/><path stroke=\"null\" d=\"m15.652975,18.038011c0.064006,0.056295 0.143284,0.083798 0.221857,0.083798c0.095121,0 0.189958,-0.040284 0.256877,-0.118267c0.052352,-0.061688 1.277135,-1.516175 0.348444,-2.69721c-0.514887,-0.655543 -0.134266,-1.036346 -0.051432,-1.107364c0.143925,-0.118559 0.167155,-0.332478 0.051076,-0.4799c-0.116713,-0.14814 -0.330186,-0.172633 -0.477096,-0.05465c-0.35576,0.286517 -0.825191,1.087546 -0.054061,2.068814c0.577902,0.735249 -0.321524,1.810441 -0.330543,1.820788c-0.122262,0.142896 -0.106989,0.35969 0.034877,0.483992z\" id=\"Shape\"/></g></g></g></g></g></g></svg>'),(6,'White Board','<svg width=\"22\" height=\"22\" xmlns=\"http://www.w3.org/2000/svg\"><!-- Generator: Sketch 47.1 (45422) - http://www.bohemiancoding.com/sketch --><title>white-board</title><desc>Created with Sketch.</desc><g><title>background</title><rect fill=\"none\" id=\"canvas_background\" height=\"24\" width=\"24\" y=\"-1\" x=\"-1\"/></g><g><title>Layer 1</title><g fill-rule=\"evenodd\" fill=\"none\" id=\"Page-1\"><g stroke=\"null\" fill=\"#000000\" fill-rule=\"nonzero\" id=\"Facility---Deactive-Page\"><g stroke=\"null\" id=\"Group-7\"><g stroke=\"null\" id=\"white-board\"><path stroke=\"null\" id=\"Shape\" d=\"m21.017714,2.499644l-1.335689,0l-7.680278,0l0,-1.020059c0,-0.56335 -0.448535,-1.020059 -1.001786,-1.020059c-0.55326,0 -1.001795,0.456709 -1.001795,1.020059l0,1.020059l-7.680278,0l-1.335689,0c-0.55326,0 -1.001786,0.456709 -1.001786,1.020011c0,0.56335 0.448526,1.020059 1.001786,1.020059l0.333951,0l0,11.900521c0,0.56334 0.448526,1.02005 1.001786,1.02005l7.680278,0l0,2.04007l-2.337484,0c-0.55325,0 -1.001786,0.456709 -1.001786,1.020059c0,0.56335 0.448535,1.020059 1.001786,1.020059l6.67854,0c0.55325,0 1.001786,-0.456709 1.001786,-1.020059c0,-0.56335 -0.448535,-1.020059 -1.001786,-1.020059l-2.337484,0l0,-2.04007l7.680278,0c0.55326,0 1.001786,-0.456709 1.001786,-1.02005l0,-11.900521l0.333951,0c0.55326,0 1.001786,-0.456709 1.001786,-1.020059c-0.000086,-0.563302 -0.448612,-1.020011 -1.001872,-1.020011zm-2.337484,12.920532l-15.360546,0l0,-10.880462l15.360594,0l0,10.880462l-0.000048,0z\"/></g></g></g></g></g></svg>'),(7,'Car Parking','<svg width=\"22\" height=\"22\" xmlns=\"http://www.w3.org/2000/svg\"><!-- Generator: Sketch 47.1 (45422) - http://www.bohemiancoding.com/sketch --><title>sedan-car-front</title><desc>Created with Sketch.</desc><g><title>background</title><rect fill=\"none\" id=\"canvas_background\" height=\"24\" width=\"24\" y=\"-1\" x=\"-1\"/></g><g><title>Layer 1</title><g fill-rule=\"evenodd\" fill=\"none\" id=\"Page-1\"><g stroke=\"null\" fill=\"#000000\" fill-rule=\"nonzero\" id=\"Facility---Deactive-Page\"><g stroke=\"null\" id=\"Group-7\"><g stroke=\"null\" id=\"sedan-car-front\"><path stroke=\"null\" id=\"Shape\" d=\"m20.589088,8.449791c-0.014784,-0.01672 -0.027326,-0.033001 -0.044799,-0.049275l-0.76916,-0.72901c0.637907,-0.14211 1.324642,-0.666973 1.324642,-1.205484c0,-0.627379 -0.88653,-0.849994 -1.643148,-0.849994c-0.791109,0 -0.882948,0.532342 -0.892355,0.908511l-1.984497,-1.879057c-0.403174,-0.392003 -1.167858,-0.700414 -1.739464,-0.700414l-3.865075,0l-0.000894,0l-3.865969,0c-0.571159,0 -1.335397,0.30841 -1.739017,0.700414l-1.98405,1.879057c-0.010308,-0.376169 -0.10214,-0.908511 -0.892355,-0.908511c-0.757519,0 -1.643595,0.222614 -1.643595,0.849994c0,0.538511 0.687182,1.063374 1.325089,1.205484l-0.76916,0.72901c-0.017473,0.016273 -0.029568,0.032555 -0.044799,0.049275c-0.822919,0.690733 -1.360481,1.971885 -1.360481,2.901513l0,2.762492c0,0.670493 0.269232,1.278957 0.704208,1.73255l0,1.071299c0,0.626494 0.53398,1.137286 1.1907,1.137286l1.43977,0c0.65672,0 1.190253,-0.509907 1.190253,-1.137286l0,-0.2741l6.449406,0l0.000894,0l6.44896,0l0,0.2741c0,0.627379 0.533078,1.137286 1.1907,1.137286l1.439324,0c0.657167,0 1.190253,-0.510793 1.190253,-1.137286l0,-1.071299c0.435423,-0.453593 0.704208,-1.062057 0.704208,-1.73255l0,-2.762492c0.000894,-0.929628 -0.536669,-2.21078 -1.359587,-2.901513zm-14.490891,-2.969272c0.279085,-0.228337 0.766926,-0.401684 1.010172,-0.401684l3.865969,0l0.000894,0l3.865969,0c0.243246,0 0.731087,0.173347 1.010172,0.401684l2.602251,2.476955l-7.478392,0l-0.000894,0l-7.477945,0l2.601804,-2.476955zm-5.205395,5.452827c0,-0.680174 0.542046,-1.232316 1.211308,-1.232316c0.668815,0 2.854457,1.260034 2.854457,1.940208c0,0.680174 -2.185641,0.522668 -2.854457,0.522668c-0.669262,0 -1.211308,-0.549948 -1.211308,-1.23056zm3.632576,4.499l-0.230704,0l-0.230704,0l-1.368539,0.002203c-0.379877,-0.116148 -0.647768,-0.251657 -0.837256,-0.397287c-0.095869,-0.073473 -0.169334,-0.150019 -0.226675,-0.226134c-0.057788,-0.076993 -0.099898,-0.152669 -0.127224,-0.228337c-0.170228,-0.472516 0.181429,-0.906755 0.181429,-0.906755l2.335707,0l1.557141,1.755432l-1.053176,0.000878l0,0zm9.807828,0.000878l-3.357975,0l-0.000894,0l-3.357975,0c-0.700171,0 -1.268649,-0.558304 -1.268649,-1.245517l4.626624,0l0.000894,0l4.626624,0c0,0.688091 -0.568471,1.245517 -1.268649,1.245517zm0.294763,-2.095511l-3.652738,0l-0.000894,0l-3.652738,0c-0.761548,0 -1.379741,-0.92215 -1.379741,-2.059444l5.032478,0l0.000894,0l5.032478,0c0,1.137733 -0.618192,2.059444 -1.379741,2.059444zm5.817771,1.245956c-0.027773,0.075676 -0.069883,0.151344 -0.127671,0.227898c-0.056894,0.076115 -0.130359,0.152669 -0.226675,0.226142c-0.189041,0.145622 -0.457371,0.282009 -0.837248,0.397279l-1.368547,-0.002203l-0.230704,0l-0.230704,0l-1.054069,0l1.558035,-1.755424l2.335261,0c0,-0.000447 0.352104,0.432914 0.182323,0.906308zm-0.600281,-2.419763c-0.668369,0 -2.85401,0.156627 -2.85401,-0.522668c0,-0.679296 2.185641,-1.940208 2.85401,-1.940208c0.66927,0 1.211308,0.552142 1.211308,1.232316c0,0.679735 -0.542038,1.23056 -1.211308,1.23056z\"/></g></g></g></g></g></svg>'),(8,'2 Parking','<svg width=\"22\" height=\"22\" xmlns=\"http://www.w3.org/2000/svg\"><!-- Generator: Sketch 47.1 (45422) - http://www.bohemiancoding.com/sketch --><title>vespa</title><desc>Created with Sketch.</desc><g><title>background</title><rect fill=\"none\" id=\"canvas_background\" height=\"24\" width=\"24\" y=\"-1\" x=\"-1\"/></g><g><title>Layer 1</title><g fill-rule=\"evenodd\" fill=\"none\" id=\"Page-1\"><g stroke=\"null\" fill=\"#000000\" fill-rule=\"nonzero\" id=\"Facility---Deactive-Page\"><g stroke=\"null\" id=\"Group-7\"><g stroke=\"null\" id=\"vespa\"><path stroke=\"null\" id=\"Shape\" d=\"m10.877925,9.109131l8.258052,0c0.095413,0 0.183717,-0.061552 0.224824,-0.157797c0.2502,-0.583068 0.475024,-1.185726 0.234468,-1.577416c-0.230406,-0.378832 -0.79272,-0.53383 -1.943223,-0.53383c-0.731819,0 -1.656991,0.06435 -2.634434,0.132618c-1.214959,0.084492 -2.590793,0.180737 -3.9443,0.180737c-0.089824,0 -0.172546,0.052604 -0.216701,0.138215c-0.021314,0.04141 -0.210613,0.431988 -0.233953,1.363105c-0.002541,0.080022 0.001014,0.148282 0.007102,0.209841c0.014212,0.138767 0.120781,0.244527 0.248165,0.244527z\"/><path stroke=\"null\" id=\"Shape\" d=\"m21.209852,12.420965l0.143298,-0.051636c0.079454,-0.029868 0.138427,-0.099218 0.15549,-0.185782l0.150611,-0.760349c0.017547,-0.086564 -0.011217,-0.176668 -0.075067,-0.235897l-0.795942,-0.737567c-0.042892,-0.039481 -0.09797,-0.062263 -0.154514,-0.063276l-0.968004,-0.020247c-0.19302,-0.171608 -0.75842,-0.675804 -1.013339,-0.897021c-0.042892,-0.037462 -0.097478,-0.057709 -0.153531,-0.057709l-7.327314,0c-0.077987,0 -0.150611,0.038975 -0.195448,0.105291c-0.044844,0.06581 -0.056053,0.150347 -0.030224,0.226791c0.060931,0.178188 0.185222,0.330055 0.356792,0.541144c0.183263,0.224764 0.434771,0.532544 0.727705,1.019027c0.2091,0.348275 0.248097,0.704659 0.116009,1.061541c-0.208124,0.558873 -0.783274,0.994219 -1.120083,1.093444c-0.268564,0.079976 -0.727712,0.127059 -1.228286,0.127059c-0.792531,0 -1.616753,-0.115925 -2.320096,-0.327022c-1.305297,-0.392317 -1.553878,-3.438757 -1.41496,-3.965735c0.077011,-0.294113 0.420151,-1.270104 0.752082,-2.213701c0.093583,-0.266779 0.174489,-0.496104 0.245654,-0.699599c0.058488,0.042522 0.100897,0.071377 0.103816,0.073404c0.039973,0.026321 0.083841,0.038975 0.128193,0.038975c0.079447,0 0.15695,-0.041002 0.202278,-0.115419c0.071165,-0.116432 0.038014,-0.269812 -0.0736,-0.343722c-0.000976,-0.000507 -0.087245,-0.058216 -0.191069,-0.141233c0.050206,-0.1463 0.092607,-0.270326 0.127702,-0.374604c0.004387,0.000499 0.008774,0.001513 0.012676,0.002526c0.024854,0.07897 0.08335,0.14478 0.166691,0.166041c0.347043,0.088084 0.671175,0.20907 0.674586,0.21059c0.026805,0.01012 0.054102,0.015187 0.081398,0.015187c0.098454,0 0.190093,-0.063276 0.225671,-0.164521c0.044844,-0.129086 -0.019499,-0.272353 -0.143789,-0.318415c-0.014129,-0.00506 -0.350446,-0.131113 -0.72381,-0.225777c-0.077011,-0.020247 -0.152071,0.005068 -0.208616,0.054676c0.060931,-0.192369 0.078479,-0.274373 0.078479,-0.320949c0,-0.464201 -1.66842,-1.103057 -2.188008,-1.121784c-0.153047,0 -0.287087,0.066317 -0.387984,0.191348c-0.373847,0.463195 -0.174005,1.767728 -0.130137,2.024886c0.018031,0.107825 0.101872,0.189836 0.206664,0.203503l0.628275,0.080491c-0.211051,0.697065 -1.147863,2.860143 -1.347214,3.182612c-0.047279,0.07087 -0.362638,0.129086 -0.514226,0.156927c-0.324125,0.059736 -0.630711,0.115925 -0.747203,0.357896c-0.118928,0.247545 -0.10967,0.668717 -0.093583,0.900061c-0.03607,-0.001014 -0.071165,-0.007594 -0.107235,-0.007594c-1.109842,0 -2.143648,0.621135 -2.697839,1.616874c-0.121855,0.21919 -0.142322,0.430286 -0.061415,0.628721c0.084809,0.206037 0.289038,0.382704 0.562481,0.541152c-0.364098,0.474328 -0.583439,1.072176 -0.583439,1.724193c0,1.526763 1.195627,2.769533 2.665671,2.769533c1.470045,0 2.665671,-1.24277 2.665671,-2.769533c0,-0.07391 -0.005363,-0.147821 -0.010717,-0.221731c0.238832,0.091125 0.549804,0.242485 0.637049,0.290067c0.087245,0.048089 0.159385,-0.00506 0.174497,-0.079477c0.015596,-0.074916 0.045328,-0.276392 0.052634,-0.420159c0.708214,0.597847 1.468093,0.640369 2.586716,0.640369l6.18091,0c0.221769,1.447793 1.428612,2.55945 2.884029,2.55945c1.612374,0 2.924494,-1.361736 2.924494,-3.037325c0,-0.089604 -0.005854,-0.177681 -0.012676,-0.264245c0.849076,-0.124533 0.987503,-0.270833 1.053796,-0.342209c0.09114,-0.096177 0.106743,-0.199956 0.1043,-0.267792c-0.019007,-0.550765 -0.491308,-1.409824 -0.756953,-1.851751zm-17.016633,2.994297c0,0.839818 -0.658007,1.523723 -1.467118,1.523723c-0.80911,0 -1.467118,-0.683905 -1.467118,-1.523723c0,-0.506223 0.241267,-0.951697 0.607808,-1.229609c0.440618,0.136173 0.924136,0.262725 1.420814,0.39029c0.255895,0.06581 0.514218,0.133647 0.767186,0.200969c0.086761,0.196416 0.138427,0.410039 0.138427,0.63835zm15.428636,-0.269313c0,0.988652 -0.7745,1.792529 -1.72594,1.792529c-0.951432,0 -1.725448,-0.803876 -1.725448,-1.792529c1.262896,-0.009621 2.629117,-0.09061 3.437252,-0.14478c0.003903,0.048603 0.014136,0.096185 0.014136,0.14478z\"/></g></g></g></g></g></svg>'),(9,'Leased Line','<svg width=\"22\" height=\"22\" xmlns=\"http://www.w3.org/2000/svg\"><!-- Generator: Sketch 47.1 (45422) - http://www.bohemiancoding.com/sketch --><title>modem</title><desc>Created with Sketch.</desc><g><title>background</title><rect fill=\"none\" id=\"canvas_background\" height=\"24\" width=\"24\" y=\"-1\" x=\"-1\"/></g><g><title>Layer 1</title><g fill-rule=\"evenodd\" fill=\"none\" id=\"Page-1\"><g stroke=\"null\" fill=\"#000000\" fill-rule=\"nonzero\" id=\"Facility---Deactive-Page\"><g stroke=\"null\" id=\"Group-7\"><g stroke=\"null\" id=\"modem\"><path stroke=\"null\" id=\"Shape\" d=\"m7.895056,6.628879c-1.756243,-1.352262 -1.756243,-3.432671 0,-4.784933c0.501782,-0.416084 0.501782,-1.04021 0.125443,-1.456294c-0.501782,-0.416084 -1.254461,-0.416084 -1.756243,-0.104021c-2.759807,2.18443 -2.759807,5.721133 0,7.801542c0.501782,0.520094 1.254461,0.416073 1.756243,0c0.501782,-0.416084 0.501782,-1.04021 -0.125443,-1.456294z\"/><path stroke=\"null\" id=\"Shape\" d=\"m15.735746,0.363215c-0.501782,-0.41868 -1.254461,-0.41868 -1.756243,0.10467c-0.501782,0.41868 -0.501782,1.046701 0.125443,1.465382c1.6308,1.256041 1.6308,3.349454 0,4.710166c-0.501782,0.41868 -0.627225,1.046701 -0.125443,1.465382c0.501782,0.41868 1.254461,0.41868 1.756243,0.10467c2.759807,-2.198073 2.759807,-5.756867 0,-7.85027z\"/><path stroke=\"null\" id=\"Shape\" d=\"m20.894296,14.312234l-8.794929,0l0,-8.067829c0.65962,-0.331558 1.099366,-1.105188 1.099366,-1.878817c0,-1.2157 -0.98943,-2.210365 -2.198732,-2.210365c-1.209303,0 -2.198732,0.994665 -2.198732,2.210365c0,0.773629 0.439746,1.547258 1.099366,1.878817l0,8.067829l-8.794929,0c-0.65962,0 -1.099366,0.552594 -1.099366,1.105188l0,4.420729c0,0.552594 0.439746,1.105177 1.099366,1.105177l1.099366,0l0,1.105188l3.298098,0l0,-1.105188l10.993661,0l0,1.105188l3.298098,0l0,-1.105188l1.099366,0c0.549683,0 1.099366,-0.552583 1.099366,-1.105177l0,-4.420729c0,-0.552594 -0.549683,-1.105188 -1.099366,-1.105188zm-17.589858,4.420729c-0.549683,0 -1.099366,-0.552583 -1.099366,-1.105177c0,-0.552594 0.549683,-1.105188 1.099366,-1.105188c0.65962,0 1.099366,0.552594 1.099366,1.105188c0,0.663106 -0.549683,1.105177 -1.099366,1.105177zm4.397464,0c-0.65962,0 -1.099366,-0.552583 -1.099366,-1.105177c0,-0.552594 0.439746,-1.105188 1.099366,-1.105188c0.549683,0 1.099366,0.552594 1.099366,1.105188c0,0.663106 -0.549683,1.105177 -1.099366,1.105177zm10.993661,0l-7.695563,0l0,-2.210365l7.695563,0l0,2.210365z\"/></g></g></g></g></g></svg>'),(10,'Print/Scan','<svg width=\"22\" height=\"22\" xmlns=\"http://www.w3.org/2000/svg\"><!-- Generator: Sketch 47.1 (45422) - http://www.bohemiancoding.com/sketch --><title>printer-tool</title><desc>Created with Sketch.</desc><g><title>background</title><rect x=\"-1\" y=\"-1\" width=\"24\" height=\"24\" id=\"canvas_background\" fill=\"none\"/></g><g><title>Layer 1</title><g id=\"Page-1\" fill=\"none\" fill-rule=\"evenodd\"><g id=\"Facility---Deactive-Page\" fill-rule=\"nonzero\" fill=\"#000000\" stroke=\"null\"><g id=\"Group-7\" stroke=\"null\"><g id=\"printer-tool\" stroke=\"null\"><path d=\"m5.959666,1.530226l10.9971,0l0,3.05473l1.37471,0l0,-3.05473c0,-0.84272 -0.61476,-1.52744 -1.37471,-1.52744l-10.99711,0c-0.7584,0 -1.3747,0.68472 -1.3747,1.52744l0,3.05473l1.3747,0l0,-3.05473l0.00001,0z\" id=\"Shape\" stroke=\"null\"/><path d=\"m20.622726,5.501386l-19.24524,0c-0.7584,0 -1.3747,0.61608 -1.3747,1.37458l0,6.87329c0,0.75991 0.61625,1.37471 1.3747,1.37471l2.7493,0l0,5.49858c0,0.7599 0.61625,1.37467 1.3747,1.37467l10.99715,0c0.75995,0 1.37471,-0.61477 1.37471,-1.37467l0,-5.49858l2.74938,0c0.75968,0 1.37449,-0.6148 1.37449,-1.37471l0,-6.87329c0,-0.7585 -0.61486,-1.37458 -1.37449,-1.37458zm-4.12413,15.12115l-10.99715,0l0,-9.62257l10.99715,0l0,9.62257zm2.74937,-10.99715c-0.7599,0 -1.37467,-0.61485 -1.37467,-1.37471c0,-0.75841 0.61477,-1.37471 1.37467,-1.37471c0.75996,0 1.37471,0.61626 1.37471,1.37471c0.00005,0.75981 -0.61475,1.37471 -1.37471,1.37471z\" id=\"Shape\" stroke=\"null\"/><rect id=\"Rectangle-path\" x=\"7.334257\" y=\"12.832865\" width=\"5.498608\" height=\"0.916435\" stroke=\"null\"/><rect id=\"Rectangle-path\" x=\"7.334257\" y=\"14.665734\" width=\"8.247911\" height=\"0.916435\" stroke=\"null\"/><rect id=\"Rectangle-path\" x=\"7.334257\" y=\"17.415038\" width=\"8.247911\" height=\"0.916435\" stroke=\"null\"/></g></g></g></g></g></svg>'),(12,'Explore','<svg fill=\"#000000\" height=\"24\" viewBox=\"0 0 24 24\" width=\"24\" xmlns=\"http://www.w3.org/2000/svg\">    <path d=\"M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.19 12.19L6 18l3.81-8.19L18 6l-3.81 8.19z\"/>    <path d=\"M0 0h24v24H0z\" fill=\"none\"/></svg>'),(13,'Event Seat','<svg fill=\"#000000\" height=\"24\" viewBox=\"0 0 24 24\" width=\"24\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">    <defs>        <path d=\"M0 0h24v24H0V0z\" id=\"a\"/>    </defs>    <clipPath id=\"b\">        <use overflow=\"visible\" xlink:href=\"#a\"/>    </clipPath>    <path clip-path=\"url(#b)\" d=\"M4 18v3h3v-3h10v3h3v-6H4zm15-8h3v3h-3zM2 10h3v3H2zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z\"/></svg>'),(14,'Explore 2','<svg fill=\"#000000\" height=\"24\" viewBox=\"0 0 24 24\" width=\"24\" xmlns=\"http://www.w3.org/2000/svg\">    <path d=\"M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.19 12.19L6 18l3.81-8.19L18 6l-3.81 8.19z\"/>    <path d=\"M0 0h24v24H0z\" fill=\"none\"/></svg>');
/*!40000 ALTER TABLE `amenity` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `bank_details`
--

DROP TABLE IF EXISTS `bank_details`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `bank_details` (
  `userId` int(11) NOT NULL,
  `bankName` varchar(128) NOT NULL,
  `accountNo` int(18) NOT NULL,
  `ifscCode` int(11) NOT NULL,
  `branchName` varchar(45) NOT NULL,
  `nameAsInBank` varchar(45) NOT NULL,
  PRIMARY KEY (`userId`),
  CONSTRAINT `bank_details_userId_user_pref` FOREIGN KEY (`userId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `booking`
--

DROP TABLE IF EXISTS `booking`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `booking` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `fromTime` timestamp NULL DEFAULT NULL,
  `toTime` timestamp NULL DEFAULT NULL,
  `seats` int(11) NOT NULL DEFAULT '0',
  `price` double NOT NULL,
  `totalPrice` double NOT NULL,
  `cancellationPolicyId` int(11) NOT NULL,
  `paymentMethod` varchar(20) DEFAULT NULL,
  `paymentId` varchar(45) DEFAULT NULL,
  `userId` int(11) NOT NULL,
  `facilityId` int(11) NOT NULL,
  `bookedTime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `status` int(11) NOT NULL DEFAULT '0',
  `approvedTime` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `booking_facility_idx` (`facilityId`),
  KEY `booking_user_pref_idx` (`userId`),
  KEY `booking_cancellationId_idx` (`cancellationPolicyId`),
  KEY `booking_status_idx` (`status`),
  CONSTRAINT `booking_cancellationId` FOREIGN KEY (`cancellationPolicyId`) REFERENCES `facility_cancellation_charges` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `booking_facility` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `booking_status` FOREIGN KEY (`status`) REFERENCES `booking_status` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `booking_user_pref` FOREIGN KEY (`userId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `booking_history`
--

DROP TABLE IF EXISTS `booking_history`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `booking_history` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `fromDateTime` timestamp NULL DEFAULT NULL,
  `toDateTime` timestamp NULL DEFAULT NULL,
  `bookedTime` timestamp NULL DEFAULT NULL,
  `price` double NOT NULL,
  `paymentMethod` varchar(10) NOT NULL,
  `userId` int(11) NOT NULL,
  `facilityId` int(11) NOT NULL,
  `bookingId` int(11) NOT NULL,
  `paymentId` varchar(45) DEFAULT NULL,
  `seats` int(11) NOT NULL,
  `approvedTime` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `paymentId_UNIQUE` (`paymentId`),
  KEY `bookingHistory_user_idx` (`userId`),
  KEY `bookingHistory_facility_idx` (`facilityId`),
  KEY `booking_history_bookingId` (`bookingId`),
  CONSTRAINT `bookingHistory_facility` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `bookingHistory_user` FOREIGN KEY (`userId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `booking_status`
--

DROP TABLE IF EXISTS `booking_status`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `booking_status` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `booking_status`
--

LOCK TABLES `booking_status` WRITE;
/*!40000 ALTER TABLE `booking_status` DISABLE KEYS */;
INSERT INTO `booking_status` VALUES (0,'inprogress'),(1,'pending'),(2,'cancelled'),(3,'confirmed'),(4,'denied'),(5,'completed');
/*!40000 ALTER TABLE `booking_status` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `cancellation`
--

DROP TABLE IF EXISTS `cancellation`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `cancellation` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `bookedFrom` timestamp NULL DEFAULT NULL,
  `bookedTo` timestamp NULL DEFAULT NULL,
  `bookedTime` timestamp NULL DEFAULT NULL,
  `seats` int(11) DEFAULT '0',
  `price` double NOT NULL,
  `totalPrice` double NOT NULL,
  `refundAmount` double NOT NULL,
  `paymentId` varchar(45) DEFAULT NULL,
  `refundId` varchar(45) DEFAULT NULL,
  `paymentMethod` varchar(10) NOT NULL,
  `cancellationPolicyId` int(11) NOT NULL,
  `facilityId` int(11) NOT NULL,
  `bookedUserId` int(11) NOT NULL,
  `cancelledUserId` int(11) NOT NULL,
  `cancelledDateTime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `bookingId` int(11) NOT NULL,
  `bookedStatus` int(11) NOT NULL,
  `approvedTime` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `cancellation_facility_idx` (`facilityId`),
  KEY `cancellation_bookedUser_idx` (`bookedUserId`),
  KEY `cancellation_cancelledUser_idx` (`cancelledUserId`),
  CONSTRAINT `cancellation_bookedUser` FOREIGN KEY (`bookedUserId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `cancellation_cancelledUser` FOREIGN KEY (`cancelledUserId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `cancellation_facility` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `city`
--

DROP TABLE IF EXISTS `city`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `city` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  `taxId` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name_UNIQUE` (`name`),
  KEY `city_tax_idx` (`taxId`),
  CONSTRAINT `city_tax` FOREIGN KEY (`taxId`) REFERENCES `tax` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `city`
--

LOCK TABLES `city` WRITE;
/*!40000 ALTER TABLE `city` DISABLE KEYS */;
INSERT INTO `city` VALUES (1,'Bangalore',1),(2,'Delhi',1);
/*!40000 ALTER TABLE `city` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `city_locality`
--

DROP TABLE IF EXISTS `city_locality`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `city_locality` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(128) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `events`
--

DROP TABLE IF EXISTS `events`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `events` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `comments` varchar(128) NOT NULL,
  `forUserId` int(11) NOT NULL,
  `status` tinyint(1) NOT NULL DEFAULT '0',
  `dateTime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `events_user_pref_idx` (`forUserId`),
  CONSTRAINT `events_user_pref` FOREIGN KEY (`forUserId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `facility`
--

DROP TABLE IF EXISTS `facility`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `title` varchar(45) NOT NULL,
  `description` varchar(21000) NOT NULL,
  `capacity` int(11) NOT NULL,
  `latitude` double NOT NULL,
  `longtitude` double NOT NULL,
  `costPerHour` double NOT NULL DEFAULT '0',
  `costPerDay` double NOT NULL,
  `costPerMonth` double NOT NULL,
  `averageRating` double NOT NULL DEFAULT '0',
  `size` int(11) NOT NULL,
  `status` int(11) NOT NULL DEFAULT '0',
  `cancellationPolicyId` int(11) NOT NULL,
  `contactNo` varchar(45) NOT NULL,
  `alternateContactNo` varchar(45) DEFAULT NULL,
  `emailId` varchar(45) NOT NULL,
  `alternateEmailId` varchar(45) DEFAULT NULL,
  `thumbnail` longtext NOT NULL,
  `typeName` varchar(45) NOT NULL,
  `cityName` varchar(45) NOT NULL,
  `localityName` varchar(45) NOT NULL,
  `locationId` int(11) NOT NULL,
  `spUserId` int(11) NOT NULL,
  `advUserId` int(11) DEFAULT NULL,
  `paymnetType` tinyint(1) NOT NULL COMMENT '1 - Online Only\n2 - Offline Only\n3 - Both Online and Offline',
  `dateTime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `facility_facility_type_idx` (`typeName`),
  KEY `facility_city_idx` (`cityName`),
  KEY `facility_locality_idx` (`localityName`),
  KEY `facility_location_idx` (`locationId`),
  KEY `facility_sp_idx` (`spUserId`),
  KEY `facility_advisor_idx` (`advUserId`),
  KEY `facility_cancellationId_idx` (`cancellationPolicyId`),
  KEY `facility_status_idx` (`status`),
  CONSTRAINT `facility_advisor` FOREIGN KEY (`advUserId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `facility_cancellationId` FOREIGN KEY (`cancellationPolicyId`) REFERENCES `facility_cancellation_charges` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `facility_city` FOREIGN KEY (`cityName`) REFERENCES `city` (`name`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `facility_facility_type` FOREIGN KEY (`typeName`) REFERENCES `facility_type` (`name`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `facility_locality` FOREIGN KEY (`localityName`) REFERENCES `locality` (`name`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `facility_location` FOREIGN KEY (`locationId`) REFERENCES `location` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `facility_sp` FOREIGN KEY (`spUserId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `facility_status` FOREIGN KEY (`status`) REFERENCES `status` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `facility_additional_cost`
--

DROP TABLE IF EXISTS `facility_additional_cost`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility_additional_cost` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  `description` varchar(128) DEFAULT NULL,
  `price` double NOT NULL,
  `facilityId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `facility_additional_cost_idx` (`facilityId`),
  CONSTRAINT `facility_additional_cost` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `facility_amenity`
--

DROP TABLE IF EXISTS `facility_amenity`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility_amenity` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `facilityId` int(11) NOT NULL,
  `amenityId` tinyint(1) NOT NULL,
  `description` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `facility_amenity_facilitidy_idx` (`facilityId`),
  KEY `facility_amenity_amenityId_idx` (`amenityId`),
  CONSTRAINT `facility_amenity_amenityId` FOREIGN KEY (`amenityId`) REFERENCES `amenity` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `facility_amenity_facilitidy` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB  DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `facility_cancellation_charges`
--

DROP TABLE IF EXISTS `facility_cancellation_charges`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility_cancellation_charges` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `duration1` int(11) NOT NULL,
  `percentage1` double NOT NULL,
  `duration2` int(11) DEFAULT NULL,
  `percentage2` double DEFAULT NULL,
  `duration3` int(11) DEFAULT NULL,
  `percentage3` double DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `cancellation_id_idx` (`duration1`,`percentage1`,`duration2`,`percentage2`,`duration3`,`percentage3`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `facility_history`
--

DROP TABLE IF EXISTS `facility_history`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility_history` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `oldStatus` int(11) NOT NULL,
  `comments` varchar(128) DEFAULT NULL,
  `facilityId` int(11) NOT NULL,
  `userId` int(11) NOT NULL,
  `dateTime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `facility_history_facility_idx` (`facilityId`),
  KEY `facility_history_user_pref_idx` (`userId`),
  CONSTRAINT `facility_history_facility` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `facility_history_user_pref` FOREIGN KEY (`userId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `facility_offers`
--

DROP TABLE IF EXISTS `facility_offers`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility_offers` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `title` varchar(45) DEFAULT NULL,
  `description` varchar(128) DEFAULT NULL,
  `startDate` date NOT NULL,
  `endDate` date NOT NULL,
  `price` double NOT NULL,
  `facilityId` int(11) NOT NULL,
  `code` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `offers_facility_idx` (`facilityId`),
  CONSTRAINT `offers_facility` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `facility_photo`
--

DROP TABLE IF EXISTS `facility_photo`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility_photo` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `imgPath` varchar(255) NOT NULL,
  `facilityId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `facility_photo_facilityId_idx` (`facilityId`),
  CONSTRAINT `facility_photo_facilityId` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='	';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `facility_terms_conditions`
--

DROP TABLE IF EXISTS `facility_terms_conditions`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility_terms_conditions` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `description` varchar(400) NOT NULL,
  `loacationId` int(11) NOT NULL,
  `status` int(11) NOT NULL,
  `createdDate` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `facility_terms_locationId_idx` (`loacationId`),
  CONSTRAINT `facility_terms_locationId` FOREIGN KEY (`loacationId`) REFERENCES `location` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `facility_timing`
--

DROP TABLE IF EXISTS `facility_timing`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility_timing` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `weekDay` tinyint(1) NOT NULL,
  `openingTime` time NOT NULL,
  `closingTime` time NOT NULL,
  `facilityId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `facility_weekday` (`weekDay`,`facilityId`),
  KEY `facility_timing_facility_idx` (`facilityId`),
  CONSTRAINT `facility_timing_facility` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `facility_type`
--

DROP TABLE IF EXISTS `facility_type`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility_type` (
  `id` tinyint(1) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name_UNIQUE` (`name`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `facility_type`
--

LOCK TABLES `facility_type` WRITE;
/*!40000 ALTER TABLE `facility_type` DISABLE KEYS */;
INSERT INTO `facility_type` VALUES (3,'Co-Working Space'),(4,'Conference Room'),(1,'Meeting Room'),(2,'Training Room'),(5,'Private Room');
/*!40000 ALTER TABLE `facility_type` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `facility_under_maintenance`
--

DROP TABLE IF EXISTS `facility_under_maintenance`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `facility_under_maintenance` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `fromDateTime` date NOT NULL,
  `toDateTime` date NOT NULL,
  `reason` varchar(128) DEFAULT NULL,
  `facilityId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `facility_under_mintenance_facility_idx` (`facilityId`),
  CONSTRAINT `facility_under_mintenance_facility` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `favorites`
--

DROP TABLE IF EXISTS `favorites`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `favorites` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `facilityId` int(11) NOT NULL,
  `userId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `favorities_userId_facilityId_idx` (`facilityId`,`userId`),
  KEY `favorites_facility_idx` (`facilityId`),
  KEY `favorites_user_pref_idx` (`userId`),
  CONSTRAINT `favorites_facility` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `favorites_user_pref` FOREIGN KEY (`userId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `least_cost`
--

DROP TABLE IF EXISTS `least_cost`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `least_cost` (
  `id` int(11) NOT NULL,
  `typeName` varchar(45) DEFAULT NULL,
  `cost` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `typeName_UNIQUE` (`typeName`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `least_cost`
--

LOCK TABLES `least_cost` WRITE;
/*!40000 ALTER TABLE `least_cost` DISABLE KEYS */;
INSERT INTO `least_cost` VALUES (1,'Meeting Room','0'),(2,'Training Room','0'),(3,'Co-Working Space','0'),(4,'Conference Room','0');
/*!40000 ALTER TABLE `least_cost` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `locality`
--

DROP TABLE IF EXISTS `locality`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `locality` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  `cityId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name_UNIQUE` (`name`,`cityId`),
  KEY `locality_cityId_city_idx` (`cityId`),
  CONSTRAINT `locality_cityId_city` FOREIGN KEY (`cityId`) REFERENCES `city` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=29 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `locality`
--

LOCK TABLES `locality` WRITE;
/*!40000 ALTER TABLE `locality` DISABLE KEYS */;
INSERT INTO `locality` VALUES (4,'Banashankari',1),(5,'Bannerghatta Road',1),(6,'BIA Road',1),(7,'Brookefield',1),(1,'BTM Layout',1),(8,'Cunningham Road',1),(9,'Electronic City',1),(10,'Hebbal',1),(11,'Hosur Road',1),(12,'HSR Layout',1),(13,'Indiranagar',1),(14,'Jayanagar',1),(2,'JJ Nagar',2),(3,'JP Nagar',1),(15,'Koramangala',1),(16,'Mahadevapura',1),(17,'Marathahalli',1),(18,'MG Road',1),(19,'Mysore Road',1),(20,'Old Airport Road',1),(21,'Residency Road',1),(22,'Richmond Road',1),(23,'Sarjapur Road',1),(24,'Vasanth Nagar',1),(25,'West of Chord Road',1),(26,'Whitefield',1),(27,'Yelahanka',1),(28,'Yeshwanthpur',1);
/*!40000 ALTER TABLE `locality` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `location`
--

DROP TABLE IF EXISTS `location`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `location` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(128) NOT NULL,
  `address` varchar(20000) NOT NULL,
  `landmark` varchar(128) DEFAULT NULL,
  `nearBy` varchar(128) DEFAULT NULL,
  `cityId` int(11) DEFAULT NULL,
  `localityId` int(11) DEFAULT NULL,
  `multiTenantId` int(11) DEFAULT NULL,
  `userId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `location_city_idx` (`cityId`),
  KEY `location_locality_idx` (`localityId`),
  KEY `location_multi_tenant_idx` (`multiTenantId`),
  KEY `location_userId_idx` (`userId`),
  CONSTRAINT `location_city` FOREIGN KEY (`cityId`) REFERENCES `city` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `location_locality` FOREIGN KEY (`localityId`) REFERENCES `locality` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `location_multi_tenant` FOREIGN KEY (`multiTenantId`) REFERENCES `multi_tenant` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `location_userId` FOREIGN KEY (`userId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `meeting`
--

DROP TABLE IF EXISTS `meeting`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `meeting` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `title` varchar(45) NOT NULL,
  `description` varchar(128) DEFAULT NULL,
  `participandsId` varchar(21000) NOT NULL,
  `userId` int(11) NOT NULL,
  `bookingId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `bookingId_UNIQUE` (`bookingId`),
  KEY `meeting_user_pref_idx` (`userId`),
  KEY `meeting_booking_idx` (`bookingId`),
  CONSTRAINT `meeting_booking` FOREIGN KEY (`bookingId`) REFERENCES `booking` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `meeting_user_pref` FOREIGN KEY (`userId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `multi_tenant`
--

DROP TABLE IF EXISTS `multi_tenant`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `multi_tenant` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `title` varchar(45) DEFAULT NULL,
  `emailId` varchar(45) DEFAULT NULL,
  `description` varchar(21000) DEFAULT NULL,
  `userId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `multi_tenant_userId_idx` (`userId`),
  CONSTRAINT `multi_tenant_userId` FOREIGN KEY (`userId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `muti_tenant_user`
--

DROP TABLE IF EXISTS `muti_tenant_user`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `muti_tenant_user` (
  `userId` int(11) NOT NULL,
  `muti_tenant_id` int(11) NOT NULL,
  PRIMARY KEY (`userId`),
  KEY `muti_tenant_user_multi_tenant_idx` (`muti_tenant_id`),
  CONSTRAINT `muti_tenant_user_multi_tenant` FOREIGN KEY (`muti_tenant_id`) REFERENCES `multi_tenant` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `participants`
--

DROP TABLE IF EXISTS `participants`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `participants` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  `emailId` varchar(45) DEFAULT NULL,
  `phoneNo` varchar(45) DEFAULT NULL,
  `participantTeamId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `participants_participant_team_idx` (`participantTeamId`),
  CONSTRAINT `participants_participant_team` FOREIGN KEY (`participantTeamId`) REFERENCES `participants_team` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `participants_team`
--

DROP TABLE IF EXISTS `participants_team`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `participants_team` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  `userId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `participants_team_userId_teamname` (`name`,`userId`),
  KEY `particiapnts_team_user_pref_idx` (`userId`),
  CONSTRAINT `particiapnts_team_user_pref` FOREIGN KEY (`userId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `review`
--

DROP TABLE IF EXISTS `review`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `review` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `comments` varchar(128) DEFAULT NULL,
  `dateTime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `rating` double NOT NULL DEFAULT '0',
  `parentId` int(11) DEFAULT NULL,
  `facilityId` int(11) NOT NULL,
  `userId` int(11) NOT NULL,
  `bookingId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `review_facility_idx` (`facilityId`),
  KEY `review_user_idx` (`userId`),
  KEY `review_review_idx` (`parentId`),
  KEY `review_booking_history_bookingId_idx` (`bookingId`),
  CONSTRAINT `review_booking_history_bookingId` FOREIGN KEY (`bookingId`) REFERENCES `booking_history` (`bookingId`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `review_facility` FOREIGN KEY (`facilityId`) REFERENCES `facility` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `review_review` FOREIGN KEY (`parentId`) REFERENCES `review` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `review_user` FOREIGN KEY (`userId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `sp_commission`
--

DROP TABLE IF EXISTS `sp_commission`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `sp_commission` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `spUserId` int(11) NOT NULL,
  `month` mediumtext NOT NULL,
  `year` varchar(45) NOT NULL,
  `commission` double NOT NULL,
  PRIMARY KEY (`id`),
  KEY `sp_userId_idx` (`spUserId`),
  CONSTRAINT `sp_userId` FOREIGN KEY (`spUserId`) REFERENCES `user_pref` (`userId`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `status`
--

DROP TABLE IF EXISTS `status`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `status` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name_UNIQUE` (`name`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `status`
--

LOCK TABLES `status` WRITE;
/*!40000 ALTER TABLE `status` DISABLE KEYS */;
INSERT INTO `status` VALUES (7,'Approved and Not Verified'),(8,'Approved and Verified'),(13,'Blocked by admin'),(11,'Blocked by advisor'),(9,'Deactivated by SP'),(1,'Pending For Approval'),(2,'Pending For Approval With Verify Request'),(6,'Reject Verify Request'),(3,'Rejected'),(4,'Rejected With Verify Request'),(12,'Verified And Blocked'),(14,'Verified And Blocked by admin'),(10,'Verified And Deactivated by SP'),(5,'Verify request'),(-1,'Saved'),(-2,'Save With Request');
/*!40000 ALTER TABLE `status` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tax`
--

DROP TABLE IF EXISTS `tax`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tax` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `state` varchar(45) NOT NULL,
  `SGST` double NOT NULL,
  `CGST` double NOT NULL,
  `IGST` double DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tax`
--

LOCK TABLES `tax` WRITE;
/*!40000 ALTER TABLE `tax` DISABLE KEYS */;
INSERT INTO `tax` VALUES (1,'Karnataka',0,0,0),(2,'Delhi',0,0,0);
/*!40000 ALTER TABLE `tax` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `user_pref`
--

DROP TABLE IF EXISTS `user_pref`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `user_pref` (
  `userId` int(11) NOT NULL,
  `sessionId` varchar(128) DEFAULT NULL,
  `userType` tinyint(1) DEFAULT NULL,
  `lastCity` varchar(45) DEFAULT NULL,
  `emailId` varchar(45) NOT NULL,
  `mobileNo` varchar(45) NOT NULL DEFAULT '0000000000',
  `displayName` varchar(45) NOT NULL,
  `comments` mediumtext,
  `blockedFacilities` tinytext,
  `mobileNoVerified` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`userId`),
  UNIQUE KEY `emailId_UNIQUE` (`emailId`),
  UNIQUE KEY `sessionId_UNIQUE` (`sessionId`),
  KEY `user_pref_city_idx` (`lastCity`),
  KEY `user_pref_user_type_idx` (`userType`),
  CONSTRAINT `user_pref_city` FOREIGN KEY (`lastCity`) REFERENCES `city` (`name`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `user_pref_user_type` FOREIGN KEY (`userType`) REFERENCES `user_type` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `huddil`.`user_pref_AFTER_INSERT` AFTER INSERT ON `user_pref` FOR EACH ROW
BEGIN
	IF(NEW.userType = 7) THEN
		INSERT INTO `huddil`.`sp_commission`
			(`spUserId`, `month`, `year`, `commission`)
			VALUES(NEW.userId, MONTH(CURDATE()), YEAR(CURDATE()), 0.1);
    END IF;
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Dumping data for table `user_pref`
--

LOCK TABLES `user_pref` WRITE;
/*!40000 ALTER TABLE `user_pref` DISABLE KEYS */;
INSERT INTO `user_pref` VALUES (1,NULL,5,NULL,'admin@huddil.com','+910000000001','admin','Blocked by the admin.',NULL, 0),(2,NULL,6,NULL,'advisor@huddil.com','+910000000002','advisor','Activated by the admin.',NULL, 0);
/*!40000 ALTER TABLE `user_pref` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `user_type`
--

DROP TABLE IF EXISTS `user_type`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `user_type` (
  `id` tinyint(1) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name_UNIQUE` (`name`)
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `user_type`
--

LOCK TABLES `user_type` WRITE;
/*!40000 ALTER TABLE `user_type` DISABLE KEYS */;
INSERT INTO `user_type` VALUES (5,'Administrator'),(6,'Advisor'),(8,'Consumer'),(7,'Service Provider');
/*!40000 ALTER TABLE `user_type` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Dumping events for database 'huddil'
--

--
-- Dumping routines for database 'huddil'
--
/*!50003 DROP FUNCTION IF EXISTS `getClosedDays` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `getClosedDays`(p_startDay DATE, p_endDay DATE, p_fId INT) RETURNS int(11)
BEGIN

    DECLARE v_closedDays VARCHAR(45);
   DECLARE v_closed INT;
    DECLARE v_nextDay DATE;
   SET v_nextDay = p_startDay;
   
   SELECT GROUP_CONCAT(weekDay) INTO v_closedDays FROM facility_timing WHERE facilityId = p_fId AND openingTime = '00:00:00' AND closingTime = '00:00:00';
   SET v_closed = 0;
   WHILE v_nextDay <= p_endDay DO
        IF(FIND_IN_SET(DAYOFWEEK(v_nextDay), v_closedDays)) THEN
            SET v_closed = v_closed + 1;
       END IF;
       SET v_nextDay = DATE_ADD(v_nextDay, INTERVAL 1 DAY);
   END WHILE;
    RETURN v_closed;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `adminFacility` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `adminFacility`(IN p_sessionId VARCHAR(90), IN p_search VARCHAR(90), IN p_searchType VARCHAR(50), IN p_facilityType INT, IN p_pageNo INT, INOUT p_count INT, OUT p_result INT)
BEGIN

DECLARE v_lowerBound INT;
DECLARE v_totalRecords INT;
DECLARE v_userType INT;

    SELECT userType INTO v_userType FROM user_pref WHERE sessionId = p_sessionId;
	 SET p_result = 0;
    IF(v_userType IS NULL) THEN
		SET p_result = -1;
	ELSEIF(v_userType <> (SELECT id FROM user_type WHERE name = 'Administrator')) THEN
		SET p_result = -2;
	ELSE

	SET v_lowerBound = (p_pageNo - 1) * p_count;
	SET v_totalRecords = 0;




SET @query = "SELECT DISTINCT f.id, f.title, f.description,f.capacity, f.latitude, f.longtitude, f.costPerHour, f.costPerDay, 
    f.costPerMonth, f.averageRating, f.size, f.status, f.contactNo, f.alternateContactNo, f.emailid, f.alternateEmailId, f.thumbnail, f.typeName, f.cityName as city, 
    f.localityName as locality, lo.name as locationName, lo.landmark, lo.address, lo.nearBy, GROUP_CONCAT(DISTINCT am.id) as Amenities, 
    GROUP_CONCAT(DISTINCT ph.imgPath) as imgPath FROM huddil.facility f 
		JOIN huddil.facility_photo ph ON ph.facilityId = f.id 
        JOIN huddil.facility_amenity a ON a.facilityId = f.id 
        JOIN huddil.amenity am ON am.id = a.amenityId 
        JOIN huddil.city c ON c.name = f.cityName 
        JOIN huddil.locality l ON l.name = f.localityName 
        JOIN huddil.location lo ON lo.id = f.locationId 
        JOIN huddil.facility_type t ON t.name = f.typeName";
SET @queryOne = "SELECT COUNT(DISTINCT f.id) INTO @v_totalRecords FROM huddil.facility f 
		JOIN huddil.facility_photo ph ON ph.facilityId = f.id 
        JOIN huddil.facility_amenity a ON a.facilityId = f.id 
        JOIN huddil.amenity am ON am.id = a.amenityId 
        JOIN huddil.city c ON c.name = f.cityName 
        JOIN huddil.locality l ON l.name = f.localityName 
        JOIN huddil.location lo ON lo.id = f.locationId 
        JOIN huddil.facility_type t ON t.name = f.typeName";

IF (p_searchType = 'locality')THEN
	
    SET @query = CONCAT(@query , ' WHERE f.localityName LIKE ''%', p_search ,'%'' AND t.id = ',p_facilityType,' AND f.status > -1 group by f.id LIMIT v_lowerBound, p_count');
	SET @queryOne = CONCAT(@queryOne , ' WHERE f.localityName LIKE ''%', p_search ,'%'' AND t.id = ',p_facilityType, ' AND f.status > -1');

ELSEIF (p_searchType = 'city')THEN

	SET @query = CONCAT(@query, ' WHERE f.cityName LIKE ''%', p_search ,'%'' AND t.id = ',p_facilityType,' AND f.status > -1 group by f.id LIMIT v_lowerBound, p_count');
    SET @queryOne = CONCAT(@queryOne, ' WHERE f.cityName LIKE ''%', p_search ,'%'' AND t.id = ',p_facilityType, '  AND f.status > -1 ');

ELSEIF(p_searchType = 'service provider')THEN
	
    SET @query = CONCAT(@query, ' JOIN huddil.user_pref p ON p.userId = f.spUserId WHERE p.displayName LIKE ''%', p_search ,'%'' AND t.id = ',p_facilityType,' AND f.status > -1 group by f.id LIMIT v_lowerBound, p_count');
    SET @queryOne = CONCAT(@queryOne, ' JOIN huddil.user_pref p ON p.userId = f.spUserId WHERE p.displayName LIKE ''%', p_search ,'%'' AND t.id = ',p_facilityType, ' AND f.status > -1');
			
END IF;

	SET @query = REPLACE(@query, 'v_lowerBound', v_lowerBound);
    SET @query = REPLACE(@query, 'p_count', p_count);

	PREPARE stmt FROM @query;
    EXECUTE stmt;
    
    PREPARE stmt FROm @queryOne;
    EXECUTE stmt;
	
    SET p_count = @v_totalRecords;
END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `booking` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `booking`(IN v_sessionId VARCHAR(128), IN v_cityId INT, IN v_localityId INT, IN v_month INT, IN v_status INT, IN v_type INT, IN v_pageNo INT, INOUT v_count INT)
BEGIN

	DECLARE v_userType INT;
    DECLARE v_userId INT;
    DECLARE LowerBound INT;
    DECLARE v_totalRecords INT;
    
    SET v_totalRecords = 0;

	SET LowerBound = (v_pageNo - 1) * v_count;


	SELECT p.userType, p.userId INTO v_userType, v_userId FROM huddil.user_pref p WHERE p.sessionId = v_sessionId;
    IF(v_userId IS NULL)THEN
		SET v_count = -1;
	ELSEIF(v_userType != 6 AND v_userType !=7)THEN
        SET v_count = -2;
	ELSE	
		SET @query = "SELECT DISTINCT b.id as bookingId, b.fromTime as bookedFrom, b.toTime as bookedTo, b.bookedTime, b.approvedTime, b.totalPrice, IF(b.paymentMethod = 'offline', 'Offline', 'Online') AS paymentMethod, b.status, f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM huddil.booking b JOIN huddil.facility f ON f.id = b.facilityId JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName";
		SET @queryOne= "SELECT COUNT(DISTINCT b.id) INTO @v_totalRecords FROM huddil.booking b JOIN huddil.facility f ON f.id = b.facilityId JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName";
		
		IF(v_userType = 7)THEN
			SET @query = CONCAT(@query,' JOIN huddil.user_pref p ON p.userId = b.userId AND f.spUserId = v_userId');
			SET @queryOne = CONCAT(@queryOne,' JOIN huddil.user_pref p ON p.userId = b.userId AND f.spUserId = v_userId');
		ELSEIF(v_userType = 6)THEN
			SET @query = CONCAT(@query,' JOIN huddil.user_pref p ON p.userId = b.userId');
			SET @queryOne = CONCAT(@queryOne,' JOIN huddil.user_pref p ON p.userId = b.userId');

		END IF;
        
        
		SET @query = CONCAT(@query,' WHERE month(b.fromTime) = v_month AND t.id = v_type AND c.id = v_cityId AND l.id = v_localityId AND b.status = v_status order by b.bookedTime desc LIMIT LowerBound, v_count');
		SET @queryOne = CONCAT(@queryOne,' WHERE month(b.fromTime) = v_month AND t.id = v_type AND c.id = v_cityId AND l.id = v_localityId AND b.status = v_status');

		IF(v_month = 0 && v_status = 0 && v_type = 0 && v_cityId =0 && v_localityId = 0)THEN
			SET@query = REPLACE(@query, 'AND t.id= v_type AND c.id = v_cityId AND  l.id = v_localityId  AND b.status = v_status','');
			SET@queryOne = REPLACE(@queryOne, 'AND t.id= v_type AND c.id = v_cityId AND  l.id = v_localityId  AND b.status = v_status','');
		END IF;
		IF(v_cityId = 0)THEN
			SET @query = REPLACE(@query, ' AND c.id = v_cityId','');
			SET @queryOne = REPLACE(@queryOne, ' AND c.id = v_cityId','');
		END IF;
		IF(v_localityId = 0)THEN
			SET @query = REPLACE(@query, ' AND l.id = v_localityId','');
			SET @queryOne = REPLACE(@queryOne, ' AND l.id = v_localityId','');
		END IF;
		IF(v_status = 0)THEN
			SET @query = REPLACE(@query, ' AND b.status = v_status',' AND (b.status = 1 OR b.status = 2 OR b.status = 3)');
			SET @queryOne = REPLACE(@queryOne, ' AND b.status = v_status',' AND (b.status = 1 OR b.status = 2 OR b.status = 3)');
		END IF;
		IF(v_type = 0)THEN
			SET @query = REPLACE(@query, ' AND t.id = v_type','');
			SET @queryOne = REPLACE(@queryOne, ' AND t.id = v_type','');
		END IF;
		IF(v_month =0)THEN
			/*SET v_month = MONTH(now());
			SET @query = REPLACE(@query, "v_month", v_month);
			SET @queryOne = REPLACE(@queryOne, "v_month", v_month);*/
            SET @query = REPLACE(@query, 'month(b.fromTime) = v_month AND ', '');
			SET @queryOne = REPLACE(@queryOne, 'month(b.fromTime) = v_month AND ', '');
		ELSE
			SET @query = REPLACE(@query, "v_month", v_month);
			SET @queryOne = REPLACE(@queryOne, "v_month", v_month);
		END IF;
		
        IF(v_status = 5)THEN
			
            IF(v_month = 0 && v_type = 0 && v_cityId =0 && v_localityId = 0)THEN
				SET @query = REPLACE(@query, ' WHERE','');
                SET @query = REPLACE(@query, 'b.status = v_status', '');
                SET @queryOne = REPLACE(@queryOne, ' WHERE','');
                SET @queryOne = REPLACE(@queryOne, 'b.status = v_status', '');
			ELSE
				SET @query = REPLACE(@query, ' AND b.status = v_status', '');
                SET @queryOne = REPLACE(@queryOne, ' AND b.status = v_status', '');
			END IF;
            SET @query = REPLACE(@query, 'SELECT DISTINCT b.id as bookingId, b.fromTime as bookedFrom, b.toTime as bookedTo', 'SELECT DISTINCT b.bookingId, b.fromDateTime as bookedFrom, b.toDateTime as bookedTo');
            SET @query = REPLACE(@query, 'huddil.booking', 'huddil.booking_history');
			SET @query = REPLACE(@query, 'b.totalPrice', 'b.price as totalPrice');
            SET @query = REPLACE(@query, ', b.status', ',5 as status');
            SET @query = REPLACE(@query, 'b.fromTime', 'b.bookedTime');
            SET @queryOne = REPLACE(@queryOne, 'huddil.booking', 'huddil.booking_history');
			SET @queryOne = REPLACE(@queryOne, 'b.totalPrice', 'b.price');
            SET @queryOne = REPLACE(@queryOne, ', b.status', '');
            SET @queryOne = REPLACE(@queryOne, 'b.fromTime', 'b.bookedTime');            
        END IF;


		SET @query = REPLACE(@query, "v_cityId", v_cityId);
		SET @query = REPLACE(@query, "v_localityId", v_localityId);
		SET @query = REPLACE(@query, "v_type", v_type );
		SET @query = REPLACE(@query, "v_status", v_status);
		SET @query = REPLACE(@query, "LowerBound", LowerBound);
		SET @query = REPLACE(@query, "v_count", v_count);
		SET @query = REPLACE(@query, "v_userId", v_userId);
		
		SET @queryOne = REPLACE(@queryOne, "v_cityId", v_cityId);
		SET @queryOne = REPLACE(@queryOne, "v_localityId", v_localityId);
		SET @queryOne = REPLACE(@queryOne, "v_type", v_type );
		SET @queryOne = REPLACE(@queryOne, "v_status", v_status);
		SET @queryOne = REPLACE(@queryOne, "v_userId", v_userId);

		PREPARE stmt FROM @query;
		EXECUTE stmt;
		PREPARE stmt FROM @queryOne;
		
		EXECUTE stmt;
		
		
		SET v_count = @v_totalRecords;
	END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `bookingHistory` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`%` PROCEDURE `bookingHistory`(IN v_bookingId INT)
BEGIN

DECLARE v_toTime TIMESTAMP;

SELECT b.toTime INTO v_toTime FROM huddil.booking b WHERE b.id = v_bookingId;

SELECT TIMESTAMPDIFF(SECOND, now(), v_toTime)  % 3600;

IF ((TIMESTAMPDIFF(SECOND, now(), v_toTime) % 3600) < 0)THEN
	
    INSERT INTO huddil.booking_history(`fromDateTime`, `toDateTime`, `bookedTime`, `price`, `paymentMethod`, `userId`, `facilityId`, `bookingId`, `approvedTime`)
    SELECT fromTime, toTime, bookedTime, totalPrice, paymentMethod, userId, facilityId, id, approvedTime FROM huddil.booking
	WHERE id = v_bookingId;
    /*DELETE b.* FROM huddil.booking b WHERE b.id = v_bookingId; */
END IF; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `bookingReport` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `bookingReport`(IN v_sessionId VARCHAR(255), IN v_month INT, IN v_year INT, IN v_type INT, IN v_selection INT, OUT v_result INT)
BEGIN

    DECLARE v_userType INT;
   SELECT userType INTO v_userType FROM user_pref WHERE sessionId = v_sessionId;
   SET v_result = 0;
   IF(v_userType IS NULL) THEN
        SET v_result = -1;
    ELSEIF(v_userType <> (SELECT id FROM user_type WHERE name = 'service provider')) THEN
        SET v_result = -2;
    ELSE
        IF(v_selection = 1)THEN
            SET @query = "SELECT SUM(price) as sum, date FROM (
							SELECT SUM(b.totalPrice) AS price, cast(b.bookedTime  as date) as date
							FROM huddil.booking b
							JOIN huddil.facility f ON b.facilityId = f.id 
							JOIN huddil.user_pref p ON p.userId = f.spUserId
							JOIN huddil.facility_type t ON t.name = f.typeName
							WHERE p.sessionId = 'v_sessionId' AND b.status =3 AND MONTH(b.bookedTime) = v_month AND YEAR(b.bookedTime) = v_year AND t.id = v_type group by date UNION
							SELECT SUM(b.price), cast(b.bookedTime  as date) as date
							FROM huddil.booking_history b
							JOIN huddil.facility f ON b.facilityId = f.id 
							JOIN huddil.user_pref p ON p.userId = f.spUserId
							JOIN huddil.facility_type t ON t.name = f.typeName
							WHERE p.sessionId = 'v_sessionId' AND MONTH(b.bookedTime) = v_month AND YEAR(b.bookedTime) = v_year AND t.id = v_type group by date) AS temp GROUP by date;";
            
        ELSEIF(v_selection  = 0)THEN
            SET @query = "SELECT SUM(c.totalPrice) AS sum, cast(c.bookedTime  as date) as date
            FROM huddil.cancellation c
            JOIN huddil.facility f ON c.facilityId = f.id 
            JOIN huddil.user_pref p ON p.userId = f.spUserId
            JOIN huddil.facility_type t ON t.name = f.typeName
            WHERE p.sessionId = 'v_sessionId' AND MONTH(c.bookedTime) = v_month AND YEAR(c.bookedTime) = v_year AND t.id = v_type group by date";
        END IF;
        IF(v_month = 0)THEN
            SET v_month = MONTH(now());
            SET @query = REPLACE(@query, "v_month",v_month);
        ELSE
            SET @query = REPLACE(@query, "v_month",v_month);
        END IF;
       
       IF(v_year = 0)THEN
            SET v_year = YEAR(now());
            SET @query = REPLACE(@query, "v_year",v_year);
        ELSE
            SET @query = REPLACE(@query, "v_year",v_year);
        END IF;
        IF(v_type =0)THEN
            SET @query = REPLACE(@query, 'AND t.id = v_type','');
        ELSE
            SET @query = REPLACE(@query, "v_type",v_type);
        END IF;

        IF(v_sessionId IS NOT NULL)THEN
            SET @query = REPLACE(@query, 'v_sessionId', v_sessionId);
        END IF;

        PREPARE stmt FROM @query;
        EXECUTE stmt;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `bookingsPagination` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `bookingsPagination`(IN v_sessionId VARCHAR(100), IN v_operation INT, IN v_search VARCHAR(100), IN v_pageNo INT, INOUT v_count INT)
BEGIN


/*v_operation = 1 -> get booking by consumer*/
/*v_operation = 2 -> get bookinghistory by consumer*/
/*v_operation = 3 -> get bookingcancellation by consumer*/
/*v_operation = 4 -> get booking based on emailid search by advisor*/

DECLARE v_lowerBound INT;

SET v_lowerBound = (v_pageNo - 1) * v_count;

    IF(v_operation = 1)THEN
	
        SELECT b.id as bookingId, b.bookedTime, b.facilityId as facilityId, CAST(0 AS SIGNED) AS bookingId, 
        IF(b.paymentMethod = 'offline', 'Offline', 'Online') AS paymentMethod, f.title, f.typeName as typeName, f.cityName, 
        f.localityName, lo.name as locationName, lo.address, lo.landmark, b.fromTime as bookedFrom, b.toTime as bookedTo, b.totalPrice, 
        CONCAT(UCASE(LEFT(s.name,1)),LCASE(SUBSTRING(s.name,2))) as status, b.seats, k.displayName, k.mobileNo, k.emailId FROM huddil.booking b 
            JOIN huddil.facility f ON b.facilityId = f.id 
            JOIN huddil.location lo ON f.locationId = lo.id 
            JOIN huddil.user_pref p ON b.userId = p.userId
            JOIN huddil.user_pref k on f.spUserId = k.userId
            JOIN huddil.booking_status s ON b.status = s.id 
                WHERE p.sessionId = v_sessionId AND (b.status = 1 OR b.status = 3 OR b.status =5) order by b.id desc LIMIT v_lowerBound, v_count;

        IF(v_pageNo = 1) THEN
            SELECT COUNT(DISTINCT b.id) INTO v_count FROM huddil.booking b 
                JOIN huddil.facility f ON b.facilityId = f.id 
                JOIN huddil.location lo ON f.locationId = lo.id 
                JOIN huddil.user_pref p ON b.userId = p.userId 
                JOIN huddil.booking_status s ON b.status = s.id 
                    WHERE p.sessionId = v_sessionId AND (b.status = 1 OR b.status = 3 OR b.status =5);
		ELSE
			SET v_count =0;
        END IF;
    ELSEIF(v_operation = 2)THEN
    
       
        SELECT b.bookingId, b.bookedTime, b.facilityId as facilityId, 
        IF(b.paymentMethod = 'offline', 'Offline', 'Online') AS paymentMethod, f.title, f.typeName as typeName, f.cityName, 
        f.localityName, lo.name as locationName, lo.address, lo.landmark, b.fromDateTime as bookedFrom, b.toDateTime as bookedTo, 
        b.price as totalPrice, 'Completed' as status, b.seats, k.displayName, k.mobileNo, k.emailId  FROM huddil.booking_history b 
            JOIN huddil.facility f ON b.facilityId = f.id 
            JOIN huddil.location lo ON f.locationId = lo.id 
            JOIN huddil.user_pref p ON b.userId = p.userId
            JOIN huddil.user_pref k ON f.spUserId = k.userId
                WHERE p.sessionId = v_sessionId order by b.bookedTime desc LIMIT v_lowerBound, v_count;
        
        IF(v_pageNo = 1)THEN
        
            SELECT COUNT(DISTINCT b.bookingId) INTO v_count FROM huddil.booking_history b 
                JOIN huddil.facility f ON b.facilityId = f.id 
                JOIN huddil.location lo ON f.locationId = lo.id 
                JOIN huddil.user_pref p ON b.userId = p.userId 
                    WHERE p.sessionId = v_sessionId;
		ELSE
			SET v_count =0;
        END IF;
	
	ELSEIF(v_operation =3)THEN
        
        SELECT b.bookingId, b.bookedTime, b.facilityId as facilityId, 
        IF(b.paymentMethod = 'offline', 'Offline', 'Online') AS paymentMethod, f.title, f.typeName as typeName, f.cityName, 
        f.localityName, lo.name as name, lo.address, lo.landmark, b.bookedFrom, b.bookedTo, 
        b.totalPrice, b.refundAmount, IF(b.refundId != 'null', 'Refund', 'No Refund') as cancelledStatus,  IF(b.refundId != 'null', b.refundId, null) as refundId, b.seats, p.displayName, p.mobileNo, p.emailId, b.cancelledDateTime as cancelledDate, IF(b.bookedStatus = 4, 'Denied', 'Cancelled') as status FROM huddil.cancellation b 
            JOIN huddil.facility f ON b.facilityId = f.id 
            JOIN huddil.location lo ON f.locationId = lo.id 
            JOIN huddil.user_pref p ON b.bookedUserId = p.userId 
                WHERE p.sessionId = v_sessionId order by b.id desc LIMIT v_lowerBound, v_count;
          
        IF(v_pageNo = 1)THEN
            SELECT COUNT(DISTINCT b.bookingId) INTO v_count FROM huddil.cancellation b 
                JOIN huddil.facility f ON b.facilityId = f.id 
                JOIN huddil.location lo ON f.locationId = lo.id 
                JOIN huddil.user_pref p ON b.bookedUserId = p.userId 
                    WHERE p.sessionId = v_sessionId;
		ELSE
			SET v_count =0;
        END IF;
   
	ELSEIF(v_operation =5)THEN
    
		SELECT b.bookingId, b.bookedTime, b.facilityId as facilityId,
		IF(b.paymentMethod = 'offline', 'Offline', 'Online') AS paymentMode, f.title, f.typeName as typeName, f.cityName,
		f.localityName, lo.name as locationName, lo.address, lo.landmark, b.bookedFrom as fromTime, b.bookedTo as toTime,
		b.totalPrice, b.refundAmount, IF(b.refundId != 'null', 'Refund', 'No Refund') as status FROM huddil.cancellation b 
			JOIN huddil.facility f ON b.facilityId = f.id
			JOIN huddil.location lo ON f.locationId = lo.id
			JOIN huddil.user_pref p ON f.spUserId = p.userId 
				WHERE p.sessionId = v_sessionId LIMIT v_lowerBound, v_count;
    
		IF(v_pageNo = 1)THEN
			SELECT COUNT(DISTINCT b.bookingId) INTO v_count FROM huddil.cancellation b 
				JOIN huddil.facility f ON b.facilityId = f.id 
				JOIN huddil.location lo ON f.locationId = lo.id 
				JOIN huddil.user_pref p ON f.spUserId = p.userId 
					WHERE p.sessionId = v_sessionId;
		ELSE
			SET v_count =0;
		END IF;


    ELSEIF(v_operation =4)THEN
		SET @query = "SELECT DISTINCT b.id as bookingId, b.fromTime as bookedFrom, b.toTime as bookedTo, b.bookedTime, b.approvedTime, b.totalPrice, b.paymentMethod, b.status, f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats 
					FROM huddil.booking b 
						JOIN huddil.facility f ON f.id = b.facilityId 
						JOIN huddil.location lo ON lo.id = f.locationId 
						JOIN huddil.user_pref p ON b.userId = p.userId"; 
		SET @query = CONCAT(@query, ' WHERE b.status > 0 AND p.emailId LIKE ''%',v_search,'%'' order by b.bookedTime desc LIMIT v_lowerBound, v_count');
        SET @query = REPLACE(@query, 'v_lowerBound', v_lowerBound);
		SET @query = REPLACE(@query, 'v_count', v_count);
    
		PREPARE stmt FROM @query;
		EXECUTE stmt;
	
		IF(v_pageNo = 1)THEN
			SET @queryOne = "SELECT DISTINCT COUNT(b.id) INTO @v_count FROM huddil.booking b 
								JOIN huddil.facility f ON f.id = b.facilityId 
								JOIN huddil.location lo ON lo.id = f.locationId 
								JOIN huddil.user_pref p ON b.userId = p.userId"; 
			SET @queryOne = CONCAT(@queryOne, ' WHERE b.status > 0 AND p.emailId LIKE ''%',v_search,'%''');
		
			PREPARE  stmt FROM @queryOne;
			EXECUTE stmt;
			SET v_count = @v_count;
        ELSE
			SET v_count =0;
		END IF;
    
    END IF;
   
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `boookingReport` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `boookingReport`(IN v_sessionId VARCHAR(255), IN v_month INT, IN v_type INT)
BEGIN

SET @query = "SELECT SUM(b.price) AS Sum, cast(b.fromTime  as date) as Date
FROM huddil.booking b
JOIN huddil.facility f ON b.facilityId = f.id 
JOIN huddil.user_pref p ON p.userId = f.spUserId
JOIN huddil.facility_type t ON t.name = f.typeName
WHERE p.sessionId = v_sessionId AND MONTH(b.fromTime) = v_month AND t.id = v_type group by month(b.fromTime)/*,(b.fromTime)*/";

IF(v_month =0)THEN
	SET @query = REPLACE(@query, 'AND MONTH(b.fromTime) = v_month','');
ELSE
	SET @query = REPLACE(@query, "v_month",v_month);
END IF;

IF(v_type =0)THEN
	SET @query = REPLACE(@query, 'AND t.id = v_type','');
ELSE
    SET @query = REPLACE(@query, "v_type",v_type);
END IF;

IF(v_sessionId IS NOT NULL)THEN
	SET @query = REPLACE(@query, "v_sessionId", '\'v_sessionId\'');
END IF;

PREPARE stmt FROM @query;
SELECT @query;
EXECUTE stmt;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `calendar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `calendar`(IN v_startdate DATE, IN v_facilityId INT)
BEGIN

    DECLARE v_type VARCHAR(50);
    DECLARE bIds MEDIUMTEXT;

   SELECT f.typeName INTO v_type FROM facility f WHERE f.id = v_facilityId;

   IF(v_type != 'Co-Working Space')THEN

       SELECT b.id as bookingId, v_type as roomType, b.fromTime, b.toTime, CAST(b.seats AS unsigned) as bookedSeats, CAST(0 AS unsigned) AS remainingSeats, IF(b.userId = f.spUserId, 'y', 'n') AS bookedBySp
           FROM huddil.booking b JOIN facility f ON b.facilityId = f.id 
            WHERE b.facilityId = v_facilityId AND DATE_FORMAT(v_startDate, '%Y%m') BETWEEN DATE_FORMAT(CAST(b.fromTime AS DATE), '%Y%m') AND DATE_FORMAT(CAST(b.toTime AS DATE), '%Y%m');
   ELSE
        SELECT GROUP_CONCAT(b.id) INTO bIds
            FROM booking b JOIN facility f ON b.facilityId = f.id
           WHERE b.facilityId = v_facilityId AND DATE_FORMAT(v_startDate, '%Y%m') BETWEEN DATE_FORMAT(CAST(b.fromTime AS DATE), '%Y%m') AND DATE_FORMAT(CAST(b.toTime AS DATE), '%Y%m') ;
        IF(bIds <> '') THEN
            SELECT b.id as bookingId, v_type as roomType, b.fromTime, b.toTime, CAST(SUM(b.seats) as unsigned) as bookedSeats, CAST(f.capacity - SUM(b.seats) AS unsigned) as remainingSeats, IF(b.userId = f.spUserId, 'y', 'n') AS bookedBySp
                FROM booking b JOIN facility f ON b.facilityId = f.id 
                WHERE FIND_IN_SET(b.id, bIds) group by b.id;
        ELSE
            SELECT id as bookingId, '' as roomType, fromTime, toTime, CAST(0 AS unsigned) AS  bookedSeats, CAST(0 AS unsigned) AS remainingSeats, 'n' AS bookedBySp FROM booking WHERE 1 = 2;
        END IF;
   END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `cancellationDetails` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `cancellationDetails`(IN v_sessionId VARCHAR(128), IN v_cityId INT, IN v_localityId INT, IN v_month INT, IN v_status INT, IN v_type INT, IN v_pageNo INT, INOUT v_count INT)
BEGIN

	DECLARE v_userType INT;
    DECLARE v_userId INT;
    DECLARE LowerBound INT;
    DECLARE v_totalRecords INT;
    
    SET v_totalRecords = 0;

	SET LowerBound = (v_pageNo - 1) * v_count;


	SELECT p.userType, p.userId INTO v_userType, v_userId FROM huddil.user_pref p WHERE p.sessionId = v_sessionId;
    IF(v_userId IS NULL)THEN
		SET v_count = -1;
	ELSEIF(v_userType != 6 AND v_userType !=7)THEN
        SET v_count = -2;
	ELSE	
     
		SET @query = "SELECT DISTINCT b.bookingId,b.bookedFrom, b.bookedTo, b.bookedTime, b.approvedTime, b.totalPrice, IF(b.paymentMethod = 'offline', 'Offline', 'Online') AS paymentMethod, IF(bookedStatus = 4, 4, 2) as status, f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM huddil.cancellation b JOIN huddil.facility f ON f.id = b.facilityId JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName";
		SET @queryOne= "SELECT COUNT(DISTINCT b.bookingId) INTO @v_totalRecords FROM huddil.cancellation b JOIN huddil.facility f ON f.id = b.facilityId JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName";
		
		IF(v_userType = 7)THEN
			SET @query = CONCAT(@query,' JOIN huddil.user_pref p ON p.userId = b.bookedUserId AND f.spUserId = v_userId');
			SET @queryOne = CONCAT(@queryOne,' JOIN huddil.user_pref p ON p.userId = b.bookedUserId AND f.spUserId = v_userId');
		ELSEIF(v_userType = 6)THEN
			SET @query = CONCAT(@query,' JOIN huddil.user_pref p ON p.userId = b.bookedUserId');
			SET @queryOne = CONCAT(@queryOne,' JOIN huddil.user_pref p ON p.userId = b.bookedUserId');

		END IF;

		SET @query = CONCAT(@query,' WHERE month(b.bookedTime) = v_month AND t.id = v_type AND c.id = v_cityId AND l.id = v_localityId AND b.bookedStatus = v_status order by b.bookingId desc LIMIT LowerBound, v_count');
		SET @queryOne = CONCAT(@queryOne,' WHERE month(b.bookedTime) = v_month AND t.id = v_type AND c.id = v_cityId AND l.id = v_localityId AND b.bookedStatus = v_status');

		IF(v_month = 0 && v_status = 0 && v_type = 0 && v_cityId =0 && v_localityId = 0)THEN
			SET@query = REPLACE(@query, 'AND t.id= v_type AND c.id = v_cityId AND  l.id = v_localityId  AND b.bookedStatus = v_status','');
			SET@queryOne = REPLACE(@queryOne, 'AND t.id= v_type AND c.id = v_cityId AND  l.id = v_localityId  AND b.bookedStatus = v_status','');
		END IF;
		IF(v_cityId = 0)THEN
			SET @query = REPLACE(@query, ' AND c.id = v_cityId','');
			SET @queryOne = REPLACE(@queryOne, ' AND c.id = v_cityId','');
		END IF;
		IF(v_localityId = 0)THEN
			SET @query = REPLACE(@query, ' AND l.id = v_localityId','');
			SET @queryOne = REPLACE(@queryOne, ' AND l.id = v_localityId','');
		END IF;
		IF(v_status = 2)THEN
			SET @query = REPLACE(@query, ' AND b.bookedStatus = v_status',' AND (b.bookedStatus = 1 OR b.bookedStatus = 2 OR b.bookedStatus = 3)');
			SET @queryOne = REPLACE(@queryOne, ' AND b.bookedStatus = v_status',' AND (b.bookedStatus = 1 OR b.bookedStatus = 2 OR b.bookedStatus = 3)');
		ELSEIF(v_status = 4)THEN
			SET @query = REPLACE(@query, 'v_status', v_status);
			SET @queryOne = REPLACE(@queryOne, 'v_status', v_status);
		END IF;
		IF(v_type = 0)THEN
			SET @query = REPLACE(@query, ' AND t.id = v_type','');
			SET @queryOne = REPLACE(@queryOne, ' AND t.id = v_type','');
		END IF;
		IF(v_month =0)THEN
			/*SET v_month = MONTH(now());
			SET @query = REPLACE(@query, "v_month", v_month);
			SET @queryOne = REPLACE(@queryOne, "v_month", v_month);*/
            SET @query = REPLACE(@query, 'month(b.bookedTime) = v_month AND ', '');
			SET @queryOne = REPLACE(@queryOne, 'month(b.bookedTime) = v_month AND ', '');
		ELSE
			SET @query = REPLACE(@query, "v_month", v_month);
			SET @queryOne = REPLACE(@queryOne, "v_month", v_month);
		END IF;
		
		SET @query = REPLACE(@query, "v_cityId", v_cityId);
		SET @query = REPLACE(@query, "v_localityId", v_localityId);
		SET @query = REPLACE(@query, "v_type", v_type );
		SET @query = REPLACE(@query, "v_status", v_status);
		SET @query = REPLACE(@query, "LowerBound", LowerBound);
		SET @query = REPLACE(@query, "v_count", v_count);
		SET @query = REPLACE(@query, "v_userId", v_userId);
		
		SET @queryOne = REPLACE(@queryOne, "v_cityId", v_cityId);
		SET @queryOne = REPLACE(@queryOne, "v_localityId", v_localityId);
		SET @queryOne = REPLACE(@queryOne, "v_type", v_type );
		SET @queryOne = REPLACE(@queryOne, "v_status", v_status);
		SET @queryOne = REPLACE(@queryOne, "v_userId", v_userId);

		PREPARE stmt FROM @query;
		EXECUTE stmt;
		PREPARE stmt FROM @queryOne;
		
		EXECUTE stmt;
		
		
		SET v_count = @v_totalRecords;
	END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `cancellationPolicyId` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `cancellationPolicyId`(IN v_duration1 INT, IN v_percentage1 DOUBLE, IN v_duration2 INT, IN v_percentage2 DOUBLE, IN v_duration3 INT, IN v_percentage3 DOUBLE, OUT v_cancellationPolicyId INT)
BEGIN

DECLARE v_id INT;

INSERT IGNORE INTO `facility_cancellation_charges`(`duration1`,`percentage1`,`duration2`,`percentage2`,`duration3`,`percentage3`)VALUES(v_duration1, v_percentage1, v_duration2, v_percentage2, v_duration3, v_percentage3);

SET v_cancellationPolicyId = ROW_COUNT();

IF(v_cancellationPolicyId = 1) THEN
	SET v_cancellationPolicyId = LAST_INSERT_ID();
ELSE
	SELECT id INTO v_id FROM `facility_cancellation_charges` WHERE duration1 = v_duration1 AND percentage1 = v_percentage1 AND duration2 = v_duration2 AND percentage2 = v_percentage2 AND duration3 = v_duration3 AND percentage3 = v_percentage3;
    SET v_cancellationPolicyId = v_id;
END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `createBooking` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `createBooking`(IN p_fromDateTime TIMESTAMP, IN p_toDateTime TIMESTAMP, IN p_capacity INT, IN p_fId INT, IN p_sessionId VARCHAR(128), IN p_operation INT, 
			IN p_paymentMethod VARCHAR(45), IN p_paymentId VARCHAR(45), INOUT p_book INT, OUT p_result INT, OUT p_cost DOUBLE, OUT p_cgst DOUBLE, OUT p_sgst DOUBLE, OUT p_cgstCost DOUBLE, 
            OUT p_sgstCost DOUBLE, OUT p_offer DOUBLE, OUT p_totalCost DOUBLE)
BEGIN

	/*
		Input parameters - p_operation
		0 - perform calculation only
        1 - create a booking entry and return the bookingId
        2 - Confirrm the booking and update the payment details for the booking
        
		Output parameters - p_result values after the procedure execution
        -2 - p_capacity cannot be zero for co-working space
		0 - fromTime is after toTime
		1 - invalid sessionId
        2 - invalid userType
        3 - invalid facilityId
        4 - facility is not available for booking
        5 - required facility is under maintenance for the specified time
        6 - fromTime is before the facility openingTime or after the facility closing time
        7 - endTime is after the facility closingTime or before the facility opening time
        8 - co-wprking space enough seats are not available
        9 - co-working space enough seats are available
        10 - booking already exist for the specified facility at the specified time
        11 - specified facility is available for booking for the specified time
        12 - Unable to confirm the booking as the given bookingId is invalid
        13 - Unable to confirm booking as the bookingId and the userId does not match
        14 - Booking confirmed
        15 - Duplicate payment id
        16 - facility is closedon the selected dates
    */
    DECLARE v_userId INT;
    DECLARE v_userType INT;
    DECLARE v_minute INT;
    DECLARE v_hour INT;
    DECLARE v_day INT;
    DECLARE v_month INT;
    DECLARE v_nextDate DATE;
    DECLARE v_fromDate DATE;
    DECLARE v_fromDateTime TIMESTAMP;
    DECLARE v_toDate DATE;
    DECLARE v_fromTime TIME;
    DECLARE v_toTime TIME;
    DECLARE v_costPerHour DOUBLE;
    DECLARE v_costPerDay DOUBLE;
    DECLARE v_costPerMonth DOUBLE;
    DECLARE v_approverd INT;
    DECLARE v_verified INT;
    DECLARE v_pendingVerification INT;
    DECLARE v_verificationRejected INT;
	DECLARE v_status INT;
	DECLARE v_capacity INT;
    DECLARE v_confirmedId INT;
    DECLARE v_closedDays INT;
    DECLARE v_startWeekDay INT;
    DECLARE v_endWeekDay INT;

    SELECT userId, userType INTO v_userId, v_userType FROM user_pref WHERE sessionId = p_sessionId;
    SELECT CAST(p_fromDateTime AS TIME), CAST(p_toDateTime AS TIME), CAST(p_fromDateTime AS DATE), CAST(p_toDateTime AS DATE)
		INTO v_fromTime, v_toTime, v_fromDate, v_toDate;
	SELECT id INTO v_approverd FROM status WHERE name = 'Approved and Not Verified';
	SELECT id INTO v_verified FROM status WHERE name = 'Approved and Verified';
	SELECT id INTO v_pendingVerification FROM status WHERE name = 'Verify request';
	SELECT id INTO v_verificationRejected FROM status WHERE name = 'Reject Verify Request';
    SELECT id INTO v_confirmedId FROM booking_status WHERE name = 'confirmed';
    SELECT costPerHour, costPerDay, costPerMonth, status, CGST, SGST INTO v_costPerHour, v_costPerDay, v_costPerMonth, v_status, p_cgst, p_sgst
		FROM facility f 
		JOIN location l ON f.locationId = l.id
		JOIN city c ON c.id = l.cityId
		JOIN tax t ON t.id = c.taxId
		WHERE f.id = p_fId;
	IF(v_costPerHour = 0 AND v_costPerDay = 0 AND v_costPerMonth = 0) THEN
		SET p_result = 17;
	ELSEIF(v_costPerHour = 0 AND v_costPerDay = 0 AND v_costPerMonth <> 0) THEN
		SET v_costPerHour = v_costPerMonth;
		SET v_costPerDay = v_costPerMonth;
	ELSEIF(v_costPerHour = 0 AND v_costPerDay <> 0 AND v_costPerMonth = 0) THEN
		SET v_costPerHour = v_costPerDay;
	ELSEIF(v_costPerHour = 0 AND v_costPerDay <> 0 AND v_costPerMonth <> 0) THEN
		SET v_costPerHour = v_costPerDay;
    END IF;

   	SELECT TIMESTAMPDIFF(MINUTE, p_fromDateTime, p_toDateTime) % 60, TIMESTAMPDIFF(HOUR, p_fromDateTime, p_toDateTime) 
		INTO v_minute, v_hour;
	SELECT DATE_ADD(p_fromDateTime, INTERVAL 1 SECOND), DATE_SUB(p_toDateTime, INTERVAL 1 SECOND) INTO p_fromDateTime, p_toDateTime;
    SET v_startWeekDay = DAYOFWEEK(p_fromDateTime);
    SET v_endWeekDay = DAYOFWEEK(p_toDateTime);

	IF(v_costPerHour = 0 AND v_costPerDay = 0 AND v_costPerMonth = 0) THEN
		SET p_result = 17;
    ELSEIF(p_fromDateTime < NOW() OR p_toDateTime < NOW()) THEN
		SET p_result = -1;
    ELSEIF(p_fromDateTime > p_toDateTime) THEN
		SET p_result = 0;
    ELSEIF(p_sessionId <> '0' AND v_userId IS NULL) THEN
		SET p_result = 1;
	ELSEIF(p_sessionId <> '0' AND v_userType <> (SELECT id FROM user_type WHERE name = 'consumer') AND v_userType <> (SELECT id FROM user_type WHERE name = 'service provider')) THEN
		SET p_result = 2;
	ELSEIF((SELECT id FROM facility WHERE id = p_fId) IS NULL) THEN
		SET p_result = 3;
	ELSEIF(v_status <> v_approverd AND v_status <> v_verified AND v_status <> v_pendingVerification AND v_status <> v_verificationRejected) THEN
		SET p_result = 4;
	ELSEIF((SELECT id FROM facility_under_maintenance WHERE 
			(p_fromDateTime BETWEEN fromDateTime AND toDateTime OR 
			p_toDateTime BETWEEN fromDateTime AND toDateTime OR 
			fromDateTime BETWEEN p_fromDateTime AND p_toDateTime) AND facilityId = p_fId) IS NOT NULL) THEN
		SET p_result = 5;
	ELSEIF((SELECT openingTime FROM facility_timing WHERE facilityId = p_fId AND weekDay = v_startWeekDay) = '00:00:00' OR (SELECT closingTime FROM facility_timing WHERE facilityId = p_fId AND weekDay = v_endWeekDay) = '00:00:00') THEN
		SET p_result = 16;
	ELSEIF(v_fromTime <> '00:00:00' AND (SELECT id FROM facility_timing WHERE (v_fromTime >= openingTime AND v_fromTime < closingTime) AND facilityId = p_fId AND weekDay = v_startWeekDay) IS NULL) THEN
		SET p_result = 6;
    ELSEIF(v_fromTime <> '00:00:00' AND (SELECT id FROM facility_timing WHERE (v_toTime <= closingTime AND v_toTime >= openingTime) AND facilityId = p_fId AND weekDay = v_endWeekDay) IS NULL) THEN
		SET p_result = 7;
	ELSEIF((SELECT typeName FROM facility WHERE id = p_fId) = 'Co-Working Space') THEN
        IF(p_capacity = 0) THEN
			SET p_result = -2;
        ELSE
			SELECT SUM(seats) INTO v_capacity FROM booking WHERE 
					(p_fromDateTime BETWEEN fromTime AND toTime OR 
					p_toDateTime BETWEEN fromTime AND toTime OR 
					fromTime BETWEEN p_fromDateTime AND p_toDateTime) AND facilityId = p_fId;
			IF(v_capacity IS NULL) THEN
				SET v_capacity = 0;
			END IF;
			IF(((SELECT capacity FROM facility WHERE id = p_fId) - v_capacity) < p_capacity) THEN
				SET p_result = 8;
			ELSE
				SET p_result = 9;
			END IF;
        END IF;
	ELSE
		IF(p_operation <> 2 AND (SELECT count(id) FROM booking WHERE 
			(p_fromDateTime BETWEEN fromTime AND toTime OR 
			p_toDateTime BETWEEN fromTime AND toTime OR 
			fromTime BETWEEN p_fromDateTime AND p_toDateTime) AND facilityId = p_fId) <> 0) THEN
			SET p_result = 10;
		ELSE
			SET p_result = 11;
		END IF;
	END IF;
    IF(p_result = 9 || p_result = 11) THEN
		IF(v_costPerMonth = 0 AND v_costPerDay = 0) THEN
			CALL huddil.getTotalWorkingHours(DATE_SUB(p_fromDateTime, INTERVAL 1 SECOND), DATE_ADD(p_toDateTime, INTERVAL 1 SECOND), p_fId, v_hour, v_minute);
        ELSE
			SET v_nextDate = v_fromDate;
            SET v_hour = 0;
			SELECT DATEDIFF(v_toDate, v_fromDate) + 1 INTO v_day;
			IF(v_costPerMonth <> 0) THEN
				SET v_month = 0;
				WHILE DATEDIFF(v_toDate, v_nextDate) > 0 DO
					IF(DAY(LAST_DAY(v_nextDate)) <= v_day) THEN
						SET v_day = v_day - DAY(LAST_DAY(v_nextDate));
						SET v_month = v_month + 1;
					END IF;
					SET v_nextDate = DATE_ADD(v_nextDate, INTERVAL 1 MONTH);
				END WHILE;
			END IF;
            IF((v_day > 0 AND v_costPerDay = 0) OR (v_fromDate = v_toDate)) THEN
				IF(v_fromDate <> v_toDate AND v_day > 2) THEN
					SET v_fromDateTime = DATE_SUB(p_toDateTime, INTERVAL (v_day - 1) DAY);
					SELECT openingTime INTO v_fromTime FROM facility_timing WHERE facilityId = p_fId AND weekDay = DAYOFWEEK(v_fromDateTime);
					SET v_fromDateTime = CONCAT(CAST(v_fromDateTime AS DATE), ' ',v_fromTime);
				ELSE
					SET v_fromDateTime = DATE_SUB(p_fromDateTime, INTERVAL 1 SECOND);
                END IF;
				CALL huddil.getTotalWorkingHours(v_fromDateTime, DATE_ADD(p_toDateTime, INTERVAL 1 SECOND), p_fId, v_hour, v_minute);
                IF(v_minute <> 0) THEN
					SET v_hour = v_hour + 1; 
                END IF;
                SET v_day = 0;
            END IF;
			IF(v_day > 0) THEN
				SET v_closedDays = huddil.getClosedDays(DATE_SUB(v_toDate, INTERVAL (v_day - 1) DAY), v_toDate, p_fId);
				SET v_day = v_day - v_closedDays;
			END IF;
		END IF;
    END IF;
    IF(p_result = 9) THEN
		IF(v_fromDate = v_toDate) THEN
			SET p_cost = v_costPerDay * p_capacity;
		ELSE
			IF(v_costPerMonth = 0) THEN
				SET p_cost = v_day * v_costPerDay;
            ELSE
				IF(v_month <> 0) THEN
					SET p_cost = v_day * v_costPerDay;
					IF(p_cost > v_costPerMonth) THEN
						SET p_cost = (v_month + 1) * v_costPerMonth;
					ELSE
						SET p_cost = p_cost + (v_month * v_costPerMonth);
					END IF;
				ELSE
					SET p_cost = v_day * v_costPerDay;
					IF(p_cost > v_costPerMonth) THEN
						SET p_cost = v_costPerMonth;
					END IF;
				END IF;
            END IF;
            SET p_cost = p_cost * p_capacity;
		END IF;
    ELSEIF(p_result = 11) THEN
		IF(v_costPerMonth = 0 AND v_costPerDay = 0) THEN
			SET p_cost = v_hour * v_costPerHour;
        ELSE
			IF(v_fromDate = v_toDate) THEN
				IF(v_costPerHour = v_costPerDay AND v_costPerDay = v_costPerMonth) THEN
					SET p_cost = v_costPerMonth;
                ELSE
					IF(v_fromTime = v_toTime AND v_fromTime = 0) THEN
						SET p_cost = v_costPerDay;
					ELSE
						IF(v_minute > 0) THEN
							SET v_hour = v_hour + 1;
						END IF;
						SET p_cost = v_hour * v_costPerHour;
						IF(p_cost > v_costPerDay AND v_costPerDay <> 0) THEN
							SET p_cost = v_costPerDay;
						END IF;
					END IF;
				END IF;
			ELSE
				IF(v_costPerMonth = 0) THEN
					SET p_cost = v_day * v_costPerDay;
				ELSE
					IF(v_month <> 0) THEN
						SET p_cost = v_day * v_costPerDay;
						IF(p_cost > v_costPerMonth) THEN
							SET p_cost = (v_month + 1) * v_costPerMonth;
						ELSE
							SET p_cost = p_cost + (v_month * v_costPerMonth);
						END IF;
					ELSE
						SET p_cost = v_day * v_costPerDay;
						IF(p_cost > v_costPerMonth) THEN
							SET p_cost = v_costPerMonth;
						END IF;
					END IF;
				END IF;
                IF(v_costPerDay = 0 AND v_hour <> 0 AND v_costPerHour <> 0) THEN
					SET p_cost = p_cost + (v_hour * v_costPerHour);
                END IF;
			END IF;
        END IF;
    END IF;
    IF(v_userType = (SELECT id FROM user_type WHERE name = 'service provider')) THEN
		SET p_cost = 0;
		SET p_cgst = 0;
		SET p_sgst = 0;
		SET p_cgstCost = 0;
		SET p_sgstCost = 0;
		SET p_offer = 0;
		SET p_totalCost = 0;   
    ELSE
		SET p_cgstCost = p_cost * p_cgst / 100;
		SET p_sgstCost = p_cost * p_sgst / 100;
		SET p_totalCost = p_cost + p_cgstCost + p_sgstCost;
		SELECT price INTO p_offer FROM facility_offers WHERE facilityId = p_fId AND startDate <= v_fromDate AND endDate >= v_toDate;
		IF(p_offer IS NULL) THEN
			SET p_offer = 0;
		ELSE
			SET p_offer = p_cost * p_offer / 100;
		END IF;
		SET p_totalCost = TRUNCATE(p_totalCost - p_offer, 2);
    END IF;
	IF((p_result = 9 OR p_result = 11) AND p_operation = 1) THEN
		INSERT INTO `booking` (`fromTime`, `toTime`, `seats`, `price`, `totalPrice`, `userId`, `facilityId`, `status`, `cancellationPolicyId`)
			SELECT DATE_SUB(p_fromDateTime, INTERVAL 1 SECOND), DATE_ADD(p_toDateTime, INTERVAL 1 SECOND), p_capacity, p_cost, p_totalCost, v_userId, p_fId, 0, cancellationPolicyId from facility WHERE id = p_fId;
		SET p_book = LAST_INSERT_ID();
        IF(p_paymentMethod = 'offline') THEN
			UPDATE booking SET paymentMethod = p_paymentMethod, status = 3 WHERE id = p_book;
        END IF;
	ELSEIF(((p_result = 9 OR p_result = 11) AND p_operation = 2)) THEN
		IF((SELECT id FROM booking WHERE id = p_book) IS NULL) THEN
			SET p_result = 12;
		ELSEIF((SELECT userId FROM booking WHERE id = p_book) <> v_userId) THEN
			SET p_result = 13;
        ELSE
			IF((SELECT id FROM booking WHERE paymentId = p_paymentId) IS NULL) THEN
				UPDATE booking SET paymentMethod = p_paymentMethod, paymentId = p_paymentId, status = 3 WHERE id = p_book;
				SET p_result = 14;
			ELSE
                SET p_result = 15;
            END IF;
        END If;
	END IF;
    IF(p_book <> 0 AND (SELECT typeName FROM facility WHERE id = p_fId) = 'Co-Working Space' AND v_userType <> (SELECT id FROM user_type WHERE name = 'service provider')) THEN
		UPDATE booking SET status = 1 WHERE id = p_book;
    END IF;
    IF(p_result = 9 || p_result = 11 || p_result = 14) THEN
		SELECT f.title, f.typeName, f.cityName, f.localityName, l.address, 
			s.displayName AS spName, s.emailId AS spEmailId, s.mobileNo AS spMobileNo, s.mobileNoVerified AS spMobileVerified,
			IF(c.displayName IS NULL, '', c.displayName) AS cName, IF(c.emailId IS NULL, '', c.emailId) AS cEmailId, IF(c.mobileNo IS NULL, '', c.mobileNo) AS cMobileNo, IF(c.mobileNoVerified IS NULL, false, true) AS cMobileVerified
		FROM facility f 
		JOIN location l ON f.locationId = l.id
		JOIN user_pref s ON s.userId = f.spUserId
		LEFT JOIN user_pref c ON c.userId = v_userId
		WHERE f.id = p_fId;
	END IF;
    SET p_cost = TRUNCATE(p_cost, 2);
    SET p_cgst = TRUNCATE(p_cgst, 2);
    SET p_sgst = TRUNCATE(p_sgst, 2);
    SET p_cgstCost = TRUNCATE(p_cgstCost, 2);
    SET p_sgstCost = TRUNCATE(p_sgstCost, 2);
    SET p_offer = TRUNCATE(p_offer, 2);
    SET p_totalCost = TRUNCATE(p_totalCost, 2);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `deactivateFacities` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `deactivateFacities`(IN p_sessionId VARCHAR(128), IN p_userId INT, IN p_status BOOLEAN, OUT p_result INT)
BEGIN
	
	DECLARE v_userId INT;
    DECLARE v_userType INT;
    DECLARE v_advisorUserType INT;
    DECLARE v_adminUserType INT;
	DECLARE v_approverd INT;
    DECLARE v_verified INT;
	DECLARE v_pending INT;
	DECLARE v_pendingRejected INT;
	DECLARE v_approverdBlocked INT;
    DECLARE v_verifiedBlocked INT;
    DECLARE v_blockedFacilities TINYTEXT;
    
    SELECT id INTO v_advisorUserType FROM user_type WHERE name = 'advisor';
    SELECT id INTO v_adminUserType FROM user_type WHERE name = 'administrator';
    SELECT id INTO v_approverd from status WHERE name = 'Approved and Not Verified';
	SELECT id INTO v_verified from status WHERE name = 'Approved and Verified';
	SELECT id INTO v_pending from status WHERE name = 'Verify request';
	SELECT id INTO v_pendingRejected from status WHERE name = 'Reject Verify Request';
    
    SELECT userId, userType INTO v_userId, v_userType FROM user_pref WHERE sessionId = p_sessionId;
    IF(v_userId IS NULL) THEN
		SET p_result = -1;
	ELSEIF(v_userType <> v_advisorUserType AND v_userType <> v_adminUserType) THEN
		SET p_result = -2;
	ELSE
		SET p_result = 1;
        IF(v_userType = v_advisorUserType) THEN
			SELECT id INTO v_approverdBlocked from status WHERE name = 'Blocked by advisor';
			SELECT id INTO v_verifiedBlocked from status WHERE name = 'verified and blocked';
		ELSE
			SELECT id INTO v_approverdBlocked from status WHERE name = 'Blocked by admin';
			SELECT id INTO v_verifiedBlocked from status WHERE name = 'Verified And Blocked by admin';
        END IF;
		IF(p_status = TRUE) THEN
			INSERT INTO `huddil`.`facility_history`(`oldStatus`, `comments`, `facilityId`, `userId`)
				SELECT status, '', id, v_userId FROM facility WHERE spUserId = p_userId AND (status = v_approverd OR status = v_verified);
			SELECT GROUP_CONCAT(id) INTO v_blockedFacilities FROM facility WHERE spUserId = p_userId AND (status = v_approverd OR status = v_verified OR status = v_pending OR status = v_pendingRejected);
            UPDATE user_pref SET blockedFacilities = v_blockedFacilities WHERE userId = p_userId;
			UPDATE facility SET status = IF(status = v_pending, v_approverdBlocked,
										 IF(status = v_pendingRejected, v_approverdBlocked,
                                         IF(status = v_approverd, v_approverdBlocked, 
										 IF(status = v_verified , v_verifiedBlocked, 
                                         status))))
				WHERE spUserId = p_userId;
		ELSE
			INSERT INTO `huddil`.`facility_history`(`oldStatus`, `comments`, `facilityId`, `userId`)
				SELECT status, '', id, v_userId FROM facility WHERE spUserId = p_userId AND (status = v_approverdBlocked OR status = v_verifiedBlocked);
			SELECT blockedFacilities INTO v_blockedFacilities FROM user_pref WHERE userId = p_userId;
            UPDATE facility SET status = IF(status = v_approverdBlocked, v_approverd, IF(status = v_verifiedBlocked, v_verified, status)) 
				WHERE spUserId = p_userId AND FIND_IN_SET(id, v_blockedFacilities);
            UPDATE user_pref SET blockedFacilities = NULL WHERE userId = p_userId;
		END IF;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `facility_offers` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `facility_offers`(IN v_sessionId VARCHAR(250), IN v_startDate DATE, IN v_endDate DATE, IN v_price DOUBLE, IN v_facilityId INT, OUT v_result INT)
BEGIN

DECLARE p_status INT;
DECLARE p_userType INT;
DECLARE p_userId INT;
DECLARE p_spUserId INT;
DECLARE p_id INT;

    SELECT userType, userId INTO p_userType, p_userId FROM user_pref u WHERE u.sessionId = v_sessionId;
    SELECT status, spUserId INTO p_status, p_spUserId FROM facility f WHERE id = v_facilityId;    
   
IF(p_status = 5  OR p_status = 7 OR p_status = 8)THEN
    IF(p_userType IS NOT NULL)THEN
        IF(p_userType = 7 && p_spUserId = p_userId) THEN
            SELECT id INTO p_id FROM facility_offers WHERE endDate >= v_startDate AND  startDate <= v_endDate AND facilityId = p_facilityId;
                IF(p_id IS NOT NULL)THEN
                    SET v_result = 3;
                ELSE
                    INSERT INTO `huddil`.`facility_offers`(`startDate`, `endDate`, `price`, `facilityId`) VALUES(v_startDate, v_endDate, v_price, v_facilityId);
                    SET v_result =1;
                END IF;
        ELSE 
            SET v_result = -2;
        END IF;
    ELSE
        SET v_result = -1;
    END IF;
ELSE
    SET v_result = 2;
END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `filterFacilities` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `filterFacilities`(IN v_sessionId VARCHAR(255), IN v_cityId INT, IN v_localityId INT, IN v_locationId INT, IN v_type INT, IN v_search VARCHAR(100), IN v_status INT, IN v_pageNo INT, INOUT v_count INT, OUT v_flag INT)
BEGIN

DECLARE v_city INT;
DECLARE v_locality INT;
DECLARE v_userType INT;
DECLARE v_location INT;
DECLARE v_lowerBound INT;
DECLARE v_totalRecords INT;

SET v_totalRecords = 0;
SET v_lowerBound = (v_pageNo - 1) * v_count;


a_Block:BEGIN
SET v_flag =0;
SELECT p.userType INTO v_userType FROM huddil.user_pref p WHERE p.sessionId = v_sessionId;
IF(v_userType IS NOT NULL)THEN
	IF(v_userType = 7 || v_userType =6)THEN
		
		SET @queryOne = "SELECT COUNT(DISTINCT f.id) INTO @v_totalRecords FROM huddil.facility f JOIN huddil.facility_photo ph ON ph.facilityId = f.id JOIN huddil.user_pref p ON p.userId = f.spUserId JOIN huddil.facility_amenity a ON a.facilityId = f.id JOIN huddil.amenity am ON am.id = a.amenityId";
		SET @query = "SELECT DISTINCT f.id, f.title, f.description,f.capacity, f.latitude, f.longtitude, f.costPerHour, f.costPerDay, f.costPerMonth, f.averageRating, f.size, f.status, f.contactNo, f.alternateContactNo, f.emailId, f.alternateEmailId, f.thumbnail, f.typeName, f.cityName as city, f.localityName as locality, lo.name as locationName, lo.landmark, lo.address, lo.nearBy, GROUP_CONCAT(DISTINCT am.id) as Amenities, GROUP_CONCAT(DISTINCT ph.imgPath) as imgPath FROM huddil.facility f JOIN huddil.facility_photo ph ON ph.facilityId = f.id JOIN huddil.user_pref p ON p.userId = f.spUserId JOIN huddil.facility_amenity a ON a.facilityId = f.id JOIN huddil.amenity am ON am.id = a.amenityId";

		IF(v_userType = 6)THEN
			SET @queryOne = REPLACE(@queryOne, ' ON p.userId = f.spUserId','');
			SET @query = REPLACE(@query, ' ON p.userId = f.spUserId','');
		END IF;
		
		IF(v_cityId != 0 OR v_localityId != 0 OR v_locationId != 0)THEN
			SET @queryOne = CONCAT(@queryOne," JOIN huddil.city c ON c.name = f.cityName");
			SET @query = CONCAT(@query," JOIN huddil.city c ON c.name = f.cityName");
			IF(v_cityId !=0)THEN
				SELECT c.id INTO v_city FROM huddil.city c WHERE c.id = v_cityId;
					IF(v_city IS NULL)THEN 
						LEAVE a_Block;
					END IF;
			END IF;
		END IF;
		IF(v_localityId !=0 OR v_locationId != 0)THEN
			IF(v_localityId !=0)THEN
				SELECT l.cityId,l.id INTO v_city,v_locality FROM huddil.locality l WHERE l.id = v_localityId;
				IF(v_locality IS NULL)THEN
					LEAVE a_Block;
				END IF;
				IF(v_cityId !=0)THEN
					IF(v_city != v_cityId)THEN
						LEAVE a_Block;
					 END IF;   
				ELSE
					SET v_cityId = v_city;
				END IF;
			END IF;
			SET @queryOne = CONCAT(@queryOne, " JOIN huddil.locality l ON l.name = f.localityName");
			SET @query = CONCAT(@query, " JOIN huddil.locality l ON l.name = f.localityName");
		END IF;
		IF(v_locationId != 0)THEN
			
			SET @queryOne = CONCAT(@queryOne, " JOIN huddil.location lo ON lo.id = f.locationId");
			SET @query = CONCAT(@query, " JOIN huddil.location lo ON lo.id = f.locationId");
			SELECT lo.cityId, lo.localityId INTO v_city, v_locality FROM huddil.location lo WHERE lo.id = v_locationId;	
			IF(v_cityId !=0)THEN
				IF(v_city != v_cityId)THEN
					LEAVE a_Block;
				END IF;    
			END IF;
			IF(v_localityId !=0)THEN
				IF(v_locality != v_localityId)THEN
					LEAVE a_Block;
				END IF;
			END IF;
					SET v_cityId = v_city;
					SET v_localityId = v_locality;
		ELSEIF(v_locationId =0)THEN
				SET @queryOne = CONCAT(@queryOne, " JOIN huddil.location lo ON lo.id = f.locationId");
				SET @query = CONCAT(@query, " JOIN huddil.location lo ON lo.id = f.locationId");
		END IF;
		IF(v_type != 0)THEN
			
			SET @queryOne = CONCAT(@queryOne, " JOIN huddil.facility_type t ON f.typeName = t.name");
			SET @query = CONCAT(@query, " JOIN huddil.facility_type t ON f.typeName = t.name");
		END IF;
			
			SET @queryOne = CONCAT(@queryOne, ' WHERE c.id = v_cityId AND l.id = v_localityId AND lo.id = v_locationId AND t.id = v_type AND p.sessionId = \'', v_sessionId, '\'','_join AND f.status = v_status');
			SET @query = CONCAT(@query, ' WHERE c.id = v_cityId AND l.id = v_localityId AND lo.id = v_locationId AND t.id = v_type AND p.sessionId = \'', v_sessionId, '\'','_join AND f.status = v_status group by f.id order by f.dateTime desc LIMIT v_lowerBound, v_count');
		IF(v_cityId = 0 && v_localityId = 0 && v_locationId = 0)THEN
			SET @queryOne = REPLACE(@queryOne, 'c.id = v_cityId AND l.id = v_localityId AND lo.id = v_locationId AND', '');
			SET @query = REPLACE(@query, 'c.id = v_cityId AND l.id = v_localityId AND lo.id = v_locationId AND', '');
		ELSEIF((v_cityId =0 && v_localityId !=0 && v_locationId =0) OR (v_cityId != 0 && v_localityId !=0 && v_locationId =0))THEN
			SET @queryOne = REPLACE(@queryOne, ' lo.id = v_locationId AND','');
			SET @query = REPLACE(@query, ' lo.id = v_locationId AND','');
		ELSEIF(v_cityId != 0 && v_localityId =0 && v_locationId = 0)THEN
			SET @queryOne = REPLACE(@queryOne, 'AND l.id = v_localityId AND lo.id = v_locationId',''); 
			SET @query = REPLACE(@query, 'AND l.id = v_localityId AND lo.id = v_locationId',''); 
		END IF;
		IF(v_type = 0)THEN
			SET @queryOne = REPLACE(@queryOne, 't.id = v_type AND', '');
			SET @query = REPLACE(@query, 't.id = v_type AND', '');
		ELSE
			SET @queryOne = REPLACE(@queryOne, "v_type", v_type);
			SET @query = REPLACE(@query, "v_type", v_type);
		END IF;
		IF(v_search <> "null") THEN
			SET @queryOne = REPLACE(@queryOne, '_join', CONCAT(' AND f.title like ''%', v_search, '%'''));
			SET @query = REPLACE(@query, '_join', CONCAT(' AND f.title like ''%', v_search, '%'''));
		ELSE
			SET @queryOne = REPLACE(@queryOne, '_join','');
			SET @query = REPLACE(@query, '_join','');
		END IF;
		IF(v_status = 0)THEN
			SET @queryOne = REPLACE(@queryOne, ' AND f.status = v_status', ' AND f.status > -1');
			SET @query = REPLACE(@query, ' AND f.status = v_status', ' AND f.status > -1');
		ELSEIF(v_status = -1 OR v_status = -2)THEN
			SET @queryOne = REPLACE(@queryOne, ' AND f.status = v_status', ' AND (f.status = -1 OR f.status = -2)');
			SET @query = REPLACE(@query, ' AND f.status = v_status', ' AND (f.status = -1 OR f.status = -2)');
		ELSEIF(v_status = 1)THEN
			SET @queryOne = REPLACE(@queryOne, ' AND f.status = v_status', ' AND (f.status = 1 OR  f.status = 2)');
			SET @query = REPLACE(@query, ' AND f.status = v_status', ' AND (f.status = 1 OR  f.status = 2)');
		ELSEIF(v_status = 2)THEN
			SET @queryOne = REPLACE(@queryOne, ' AND f.status = v_status', ' AND (f.status = 3 OR  f.status = 4)');
			SET @query = REPLACE(@query, ' AND f.status = v_status', ' AND (f.status = 3 OR  f.status = 4)');
		ELSEIF(v_status = 3)THEN
			SET @queryOne = REPLACE(@queryOne, ' AND f.status = v_status', ' AND (f.status = 5 OR  f.status = 6 OR f.status = 7 OR f.status = 8)');
			SET @query = REPLACE(@query, ' AND f.status = v_status', ' AND (f.status = 5 OR  f.status = 6 OR f.status = 7 OR f.status = 8)');
		ELSEIF(v_status = 4)THEN
			SET @queryOne = REPLACE(@queryOne, ' AND f.status = v_status', ' AND (f.status = 9 OR  f.status = 10 OR f.status = 11 OR f.status = 12 OR f.status = 13 OR f.status = 14)');
			SET @query = REPLACE(@query, ' AND f.status = v_status', ' AND (f.status = 9 OR  f.status = 10 OR f.status = 11 OR f.status = 12 OR f.status = 13 OR f.status = 14)');
		ELSEIF(v_status = 5)THEN
			SET @queryOne = REPLACE(@queryOne, ' AND f.status = v_status', ' AND f.status = 5');
			SET @query = REPLACE(@query, ' AND f.status = v_status', ' AND f.status = 5');
        ELSEIF(v_status = 6)THEN
			SET @queryOne = REPLACE(@queryOne, ' AND f.status = v_status', ' AND f.status = 8');
			SET @query = REPLACE(@query, ' AND f.status = v_status', ' AND f.status = 8');
		ELSE
			SET @queryOne = REPLACE(@queryOne, ' AND f.status = v_status', '');
			SET @query = REPLACE(@query, ' AND f.status = v_status', '');
		END IF;
		
		SET @query = REPLACE(@query, "v_cityId", v_cityId);
		SET @query = REPLACE(@query, "v_localityId", v_localityId);
		SET @query = REPLACE(@query, "v_locationId", v_locationId);
		SET @query = REPLACE(@query, "v_lowerBound", v_lowerBound);
		SET @query = REPLACE(@query, "v_count", v_count);
		
		SET @queryOne = REPLACE(@queryOne, "v_cityId", v_cityId);
		SET @queryOne = REPLACE(@queryOne, "v_localityId", v_localityId);
		SET @queryOne = REPLACE(@queryOne, "v_locationId", v_locationId);

		PREPARE stmt FROM @query;
		EXECUTE stmt;
		PREPARE stmt FROM @queryOne;
		EXECUTE stmt;
		SET v_flag = 1;
		SET v_count = @v_totalRecords;
		
	ELSE
		SET v_flag = -2;
	END IF;
ELSE
	SET v_flag = -1;
END IF;
END a_Block;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `getBlockedTimings` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `getBlockedTimings`(IN p_sessionId VARCHAR(128), IN p_status INT, IN p_fId INT, 
IN p_pageNo INT, INOUT p_count INT)
BEGIN

	DECLARE v_userType INT;
    DECLARE v_userId INT;
    DECLARE v_lowerBound INT;
    DECLARE v_totalRecords INT;
    
    SET v_totalRecords = 0;
	SET v_lowerBound = (P_pageNo - 1) * p_count;
    
	SELECT p.userType, p.userId INTO v_userType, v_userId FROM huddil.user_pref p WHERE p.sessionId = p_sessionId;
    
    IF(v_userId IS NULL) THEN
		SET p_count = -1;
    ELSEIF(v_userType <> (SELECT id FROM user_type WHERE name = 'Service Provider')) THEN
		SET p_count = -2;
	ELSE
		IF(p_status = 0) THEN
			SELECT DISTINCT b.id AS bookingId, b.fromTime AS bookedFrom, b.toTime AS bookedTo, b.bookedTime, b.totalPrice, '' AS paymentMethod, 
            b.status, '' AS title, '' AS typeName, '' AS name, '' AS address, '' AS displayName, '' AS emailId, '' AS mobileNo, b.seats 
            FROM huddil.booking b 
            JOIN huddil.facility f ON f.id = b.facilityId 
            JOIN huddil.user_pref p ON p.userId = f.spUserId AND b.userId = f.spUserId
            WHERE p.sessionId = p_sessionId AND f.id = p_fId LIMIT v_lowerBound, p_count;
            IF(p_pageNo = 1) THEN
				SELECT COUNT(DISTINCT b.id) INTO p_count FROM huddil.booking b 
				JOIN huddil.facility f ON f.id = b.facilityId 
				JOIN huddil.user_pref p ON p.userId = f.spUserId AND b.userId = f.spUserId
				WHERE p.sessionId = p_sessionId AND f.id = p_fId;
            END IF;
		ELSEIF(p_status = 1) THEN
			SELECT DISTINCT b.id AS bookingId, b.fromDateTime AS bookedFrom, b.toDateTime AS bookedTo, b.bookedTime, b.price, '' AS paymentMethod, 
            5 AS status, '' AS title, '' AS typeName, '' AS name, '' AS address, '' AS displayName, '' AS emailId, '' AS mobileNo, b.seats 
            FROM huddil.booking_history b 
            JOIN huddil.facility f ON f.id = b.facilityId 
            JOIN huddil.user_pref p ON p.userId = f.spUserId AND b.userId = f.spUserId
            WHERE p.sessionId = p_sessionId AND f.id = p_fId LIMIT v_lowerBound, p_count;
            IF(p_pageNo = 1) THEN
				SELECT COUNT(DISTINCT b.id) INTO p_count FROM huddil.booking_history b 
				JOIN huddil.facility f ON f.id = b.facilityId 
				JOIN huddil.user_pref p ON p.userId = f.spUserId AND b.userId = f.spUserId
                WHERE p.sessionId = p_sessionId AND f.id = p_fId LIMIT v_lowerBound, p_count;
            END If;
        END IF;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `getBookingAndCancellation` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `getBookingAndCancellation`(IN v_sessionId VARCHAR(128), IN v_cityId INT, IN v_localityId INT, IN v_month INT, IN v_type INT, IN v_pageNo INT, INOUT v_count INT)
BEGIN

	DECLARE v_userType INT;
    DECLARE v_userId INT;
    DECLARE LowerBound INT;
    DECLARE v_totalRecords INT;
    
    SET v_totalRecords = 0;

	SET LowerBound = (v_pageNo - 1) * v_count;


	SELECT p.userType, p.userId INTO v_userType, v_userId FROM huddil.user_pref p WHERE p.sessionId = v_sessionId;
    IF(v_userId IS NULL)THEN
		SET v_count = -1;
	ELSEIF(v_userType != 6 AND v_userType !=7)THEN
        SET v_count = -2;
	ELSE
   		SET @queryBooking = "SELECT DISTINCT b.id as bookingId, b.fromTime as bookedFrom, b.toTime as bookedTo, b.bookedTime, b.approvedTime, b.totalPrice, IF(b.paymentMethod = 'offline', 'Offline', 'Online') AS paymentMethod, b.status, f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM huddil.booking b JOIN huddil.facility f ON f.id = b.facilityId JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName";
		SET @queryBookingCount = "SELECT COUNT(DISTINCT b.id) AS count FROM huddil.booking b JOIN huddil.facility f ON f.id = b.facilityId JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName";
		SET @queryCancellation = "SELECT DISTINCT b.bookingId, b.bookedFrom, b.bookedTo, b.bookedTime, b.approvedTime, b.totalPrice, IF(b.paymentMethod = 'offline', 'Offline', 'Online') AS paymentMethod, IF(b.bookedStatus = 4, 4, 2) as status, f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM huddil.cancellation b JOIN huddil.facility f ON f.id = b.facilityId JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName";
		SET @queryCancellationCount = "SELECT COUNT(DISTINCT b.bookingId) AS count FROM huddil.cancellation b JOIN huddil.facility f ON f.id = b.facilityId JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName";
		SET @queryCompleted = "SELECT DISTINCT b.bookingId AS id, b.fromDateTime as bookedFrom, b.toDateTime as bookedTo, b.bookedTime, b.approvedTime, b.price, IF(b.paymentMethod = 'offline', 'Offline', 'Online') AS paymentMethod, 5 AS status, f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM huddil.booking_history b JOIN huddil.facility f ON f.id = b.facilityId JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName";
		SET @queryCompletedCount = "SELECT COUNT(DISTINCT b.bookingId) AS count FROM huddil.booking_history b JOIN huddil.facility f ON f.id = b.facilityId JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName";
        
		IF(v_userType = 7)THEN
			SET @queryBooking = CONCAT(@queryBooking,' JOIN huddil.user_pref p ON p.userId = b.userId AND f.spUserId = v_userId WHERE 1 = 1');
			SET @queryBookingCount = CONCAT(@queryBookingCount,' JOIN huddil.user_pref p ON p.userId = b.userId AND f.spUserId = v_userId WHERE 1 = 1');
			SET @queryCancellation = CONCAT(@queryCancellation,' JOIN huddil.user_pref p ON p.userId = b.bookedUserId AND f.spUserId = v_userId WHERE 1 = 1');
			SET @queryCancellationCount = CONCAT(@queryCancellationCount,' JOIN huddil.user_pref p ON p.userId = b.bookedUserId AND f.spUserId = v_userId WHERE 1 = 1');
			SET @queryCompleted = CONCAT(@queryCompleted,' JOIN huddil.user_pref p ON p.userId = b.userId AND f.spUserId = v_userId WHERE 1 = 1');
			SET @queryCompletedCount = CONCAT(@queryCompletedCount,' JOIN huddil.user_pref p ON p.userId = b.userId AND f.spUserId = v_userId WHERE 1 = 1');
        ELSEIF(v_userType = 6)THEN
			SET @queryBooking = CONCAT(@queryBooking,' JOIN huddil.user_pref p ON p.userId = b.userId WHERE 1 = 1');
			SET @queryBookingCount = CONCAT(@queryBookingCount,' JOIN huddil.user_pref p ON p.userId = b.userId WHERE 1 = 1');
			SET @queryCancellation = CONCAT(@queryCancellation,' JOIN huddil.user_pref p ON p.userId = b.bookedUserId WHERE 1 = 1');
			SET @queryCancellationCount = CONCAT(@queryCancellationCount,' JOIN huddil.user_pref p ON p.userId = b.bookedUserId WHERE 1 = 1');
			SET @queryCompleted = CONCAT(@queryCompleted,' JOIN huddil.user_pref p ON p.userId = b.userId WHERE 1 = 1');
			SET @queryCompletedCount = CONCAT(@queryCompletedCount,' JOIN huddil.user_pref p ON p.userId = b.userId WHERE 1 = 1');
		END IF;
        
		SET @queryBooking = CONCAT(@queryBooking,' AND month(b.bookedTime) = v_month AND t.id = v_type AND c.id = v_cityId AND l.id = v_localityId AND b.status != 0');
		SET @queryBookingCount = CONCAT(@queryBookingCount,' AND month(b.bookedTime) = v_month AND t.id = v_type AND c.id = v_cityId AND l.id = v_localityId AND b.status !=0');
		SET @queryCancellation = CONCAT(@queryCancellation,' AND month(b.bookedTime) = v_month AND t.id = v_type AND c.id = v_cityId AND l.id = v_localityId');
		SET @queryCancellationCount = CONCAT(@queryCancellationCount,' AND month(b.bookedTime) = v_month AND t.id = v_type AND c.id = v_cityId AND l.id = v_localityId');
		SET @queryCompleted = CONCAT(@queryCompleted,' AND month(b.bookedTime) = v_month AND t.id = v_type AND c.id = v_cityId AND l.id = v_localityId');
		SET @queryCompletedCount = CONCAT(@queryCompletedCount,' AND month(b.bookedTime) = v_month AND t.id = v_type AND c.id = v_cityId AND l.id = v_localityId');

		IF(v_month = 0 && v_type = 0 && v_cityId =0 && v_localityId = 0)THEN
			SET @queryBooking = REPLACE(@queryBooking, 'AND t.id= v_type AND c.id = v_cityId AND  l.id = v_localityId','');
			SET @queryBookingCount = REPLACE(@queryBookingCount, 'AND t.id= v_type AND c.id = v_cityId AND  l.id = v_localityId','');
            SET @queryCancellation = REPLACE(@queryCancellation, 'AND t.id= v_type AND c.id = v_cityId AND  l.id = v_localityId','');
			SET @queryCancellationCount = REPLACE(@queryCancellationCount, 'AND t.id= v_type AND c.id = v_cityId AND  l.id = v_localityId','');
			SET @queryCompleted = REPLACE(@queryCompleted, 'AND t.id= v_type AND c.id = v_cityId AND  l.id = v_localityId','');
			SET @queryCompletedCount = REPLACE(@queryCompletedCount, 'AND t.id= v_type AND c.id = v_cityId AND  l.id = v_localityId','');
		END IF;
		IF(v_cityId = 0)THEN
			SET @queryBooking = REPLACE(@queryBooking, ' AND c.id = v_cityId','');
			SET @queryBookingCount = REPLACE(@queryBookingCount, ' AND c.id = v_cityId','');
			SET @queryCancellation = REPLACE(@queryCancellation, ' AND c.id = v_cityId','');
			SET @queryCancellationCount = REPLACE(@queryCancellationCount, ' AND c.id = v_cityId','');
			SET @queryCompleted = REPLACE(@queryCompleted, ' AND c.id = v_cityId','');
			SET @queryCompletedCount = REPLACE(@queryCompletedCount, ' AND c.id = v_cityId','');
		END IF;
		IF(v_localityId = 0)THEN
			SET @queryBooking = REPLACE(@queryBooking, ' AND l.id = v_localityId','');
			SET @queryBookingCount = REPLACE(@queryBookingCount, ' AND l.id = v_localityId','');
			SET @queryCancellation = REPLACE(@queryCancellation, ' AND l.id = v_localityId','');
			SET @queryCancellationCount = REPLACE(@queryCancellationCount, ' AND l.id = v_localityId','');
			SET @queryCompleted = REPLACE(@queryCompleted, ' AND l.id = v_localityId','');
			SET @queryCompletedCount = REPLACE(@queryCompletedCount, ' AND l.id = v_localityId','');
		END IF;
		IF(v_type = 0)THEN
			SET @queryBooking = REPLACE(@queryBooking, ' AND t.id = v_type','');
			SET @queryBookingCount = REPLACE(@queryBookingCount, ' AND t.id = v_type','');
			SET @queryCancellation = REPLACE(@queryCancellation, ' AND t.id = v_type','');
			SET @queryCancellationCount = REPLACE(@queryCancellationCount, ' AND t.id = v_type','');
			SET @queryCompleted = REPLACE(@queryCompleted, ' AND t.id = v_type','');
			SET @queryCompletedCount = REPLACE(@queryCompletedCount, ' AND t.id = v_type','');
		END IF;
		IF(v_month = 0)THEN
            SET @queryBooking = REPLACE(@queryBooking, ' AND month(b.bookedTime) = v_month', '');
			SET @queryBookingCount = REPLACE(@queryBookingCount, ' AND month(b.bookedTime) = v_month', '');
            SET @queryCancellation = REPLACE(@queryCancellation, ' AND month(b.bookedTime) = v_month', '');
			SET @queryCancellationCount = REPLACE(@queryCancellationCount, ' AND month(b.bookedTime) = v_month', '');
            SET @queryCompleted = REPLACE(@queryCompleted, ' AND month(b.bookedTime) = v_month', '');
			SET @queryCompletedCount = REPLACE(@queryCompletedCount, ' AND month(b.bookedTime) = v_month', '');
		ELSE
			SET @queryBooking = REPLACE(@queryBooking, "v_month", v_month);
			SET @queryBookingCount = REPLACE(@queryBookingCount, "v_month", v_month);
			SET @queryCancellation = REPLACE(@queryCancellation, "v_month", v_month);
			SET @queryCancellationCount = REPLACE(@queryCancellationCount, "v_month", v_month);
			SET @queryCompleted = REPLACE(@queryCompleted, "v_month", v_month);
			SET @queryCompletedCount = REPLACE(@queryCompletedCount, "v_month", v_month);
		END IF;
		SET @queryBooking = REPLACE(@queryBooking, "v_cityId", v_cityId);
		SET @queryBooking = REPLACE(@queryBooking, "v_localityId", v_localityId);
		SET @queryBooking = REPLACE(@queryBooking, "v_type", v_type );
		SET @queryBooking = REPLACE(@queryBooking, "v_userId", v_userId);
		SET @queryCancellation = REPLACE(@queryCancellation, "v_cityId", v_cityId);
		SET @queryCancellation = REPLACE(@queryCancellation, "v_localityId", v_localityId);
		SET @queryCancellation = REPLACE(@queryCancellation, "v_type", v_type );
		SET @queryCancellation = REPLACE(@queryCancellation, "v_userId", v_userId);
		SET @queryCompleted = REPLACE(@queryCompleted, "v_cityId", v_cityId);
		SET @queryCompleted = REPLACE(@queryCompleted, "v_localityId", v_localityId);
		SET @queryCompleted = REPLACE(@queryCompleted, "v_type", v_type );
		SET @queryCompleted = REPLACE(@queryCompleted, "v_userId", v_userId);
		
		SET @queryBookingCount = REPLACE(@queryBookingCount, "v_cityId", v_cityId);
		SET @queryBookingCount = REPLACE(@queryBookingCount, "v_localityId", v_localityId);
		SET @queryBookingCount = REPLACE(@queryBookingCount, "v_type", v_type );
		SET @queryBookingCount = REPLACE(@queryBookingCount, "v_userId", v_userId);
		SET @queryCancellationCount = REPLACE(@queryCancellationCount, "v_cityId", v_cityId);
		SET @queryCancellationCount = REPLACE(@queryCancellationCount, "v_localityId", v_localityId);
		SET @queryCancellationCount = REPLACE(@queryCancellationCount, "v_type", v_type );
		SET @queryCancellationCount = REPLACE(@queryCancellationCount, "v_userId", v_userId);
		SET @queryCompletedCount = REPLACE(@queryCompletedCount, "v_cityId", v_cityId);
		SET @queryCompletedCount = REPLACE(@queryCompletedCount, "v_localityId", v_localityId);
		SET @queryCompletedCount = REPLACE(@queryCompletedCount, "v_type", v_type );
		SET @queryCompletedCount = REPLACE(@queryCompletedCount, "v_userId", v_userId);

		SET @queryBooking = CONCAT('SELECT * FROM (', CONCAT(@queryBooking, CONCAT(' UNION ALL ', CONCAT(@queryCancellation, CONCAT(' UNION ALL ', CONCAT(@queryCompleted, ') AS data ORDER BY bookingId DESC LIMIT LowerBound, v_count'))))));
		SET @queryBookingCount = CONCAT('SELECT  SUM(count) INTO @v_totalRecords FROM (', CONCAT(@queryBookingCount, CONCAT(' UNION ALL ', CONCAT(@queryCancellationCount, CONCAT(' UNION ALL ', CONCAT(@queryCompletedCount, ') AS data'))))));
		SET @queryBooking = REPLACE(@queryBooking, "LowerBound", LowerBound);
		SET @queryBooking = REPLACE(@queryBooking, "v_count", v_count);
		SET @queryCancellation = REPLACE(@queryCancellation, "LowerBound", LowerBound);
		SET @queryCancellation = REPLACE(@queryCancellation, "v_count", v_count);
		
        PREPARE stmt FROM @queryBooking;
		EXECUTE stmt;
        IF(v_pageNo = 1) THEN
			PREPARE stmt FROM @queryBookingCount;
			EXECUTE stmt;
			SET v_count = @v_totalRecords;
        ELSE
      		SET v_count = 0;
        END IF;
	END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `getCommissionByAdmin` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `getCommissionByAdmin`(IN p_Ids MEDIUMTEXT, IN p_month INT, IN p_year INT)
BEGIN

	DECLARE v_month INT;
	DECLARE v_months MEDIUMTEXT;
	SET v_month = p_month + 1;

	SELECT currentMonth.spUserId, currentMonthCommission, IF(nextMonthCommission IS NULL, currentMonthCommission, nextMonthCommission) AS nextMonthCommission FROM
	(SELECT spuserId, commission*100 as currentMonthCommission FROM huddil.sp_commission 
	WHERE FIND_IN_SET(p_month, month) AND YEAR = p_year AND FIND_IN_SET(spUserId, p_Ids)) AS currentMonth
	LEFT JOIN
	(SELECT spuserId, commission*100 as nextMonthCommission FROM huddil.sp_commission 
	WHERE FIND_IN_SET(v_month, month) AND YEAR = p_year AND FIND_IN_SET(spUserId, p_Ids)) AS nextMonth ON currentMonth.spuserId = nextMonth.spuserId;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `getDataForReminder` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `getDataForReminder`(IN p_sendMail BOOLEAN)
BEGIN

	DECLARE v_bookingId INT;
    DECLARE v_startTime VARCHAR(1);
    
	IF(p_sendMail = FALSE) THEN
		SELECT * FROM
			(SELECT id, fromTime AS time, 'y' AS startTime, TIMESTAMPDIFF(MINUTE, NOW(), fromTime) AS min FROM booking WHERE DATE(fromTime) = CURDATE()  AND TIME(fromTime) > NOW() AND TIMESTAMPDIFF(MINUTE, NOW(), fromTime) > 120
            UNION
			SELECT id, toTime AS time, 'n' AS startTime, TIMESTAMPDIFF(MINUTE, NOW(), toTime) AS min FROM booking WHERE DATE(toTime) = CURDATE()  AND TIME(toTime) > NOW() AND TIMESTAMPDIFF(MINUTE, NOW(), toTime) > 5)
            AS jobs ORDER BY time LIMIT 0, 1;
	ELSE
		SELECT b.id AS bookingId, b.startTime AS startTime, b.time, f.cityName, u.displayName AS spName, u.emailId AS spEmailId, u.mobileNo AS spMobileNo, u.mobileNoVerified AS spMobileVerified,
			p.displayName AS cName, p.emailId AS cEmailId, p.mobileNo AS cMobileNo, p.mobileNoVerified AS cMobileNoVerified FROM
			(SELECT id, 'y' AS startTime, fromTime AS time, userId, facilityId FROM booking WHERE DATE(fromTime) = CURDATE() AND TIME(fromTime) > NOW() AND TIMESTAMPDIFF(MINUTE, NOW(), fromTime) BETWEEN 121 AND 119
			UNION
			SELECT id, 'n' AS startTime, toTime AS time, userId, facilityId FROM booking WHERE DATE(toTime) = CURDATE() AND TIME(toTime) > NOW() AND TIMESTAMPDIFF(MINUTE, NOW(), toTime) < 6) b
			JOIN facility f ON f.id = b.facilityId
			JOIN user_pref u ON u.userId = f.spUserId
			JOIN user_pref p ON p.userId = b.userId;
	END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `getEvents` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `getEvents`(IN p_sessionId VARCHAR(128), IN p_no INT, OUT p_result INT, OUT p_count INT)
BEGIN

	/*
		p_result value after the procedure execution
        1 - invalid sessionId
        2 - invalid userType
        3 - get events successfull
    */
	
	DECLARE v_userId INT;
    DECLARE v_userType INT;
    DECLARE v_consumerTypeId INT;
	DECLARE v_spTypeId INT;
    DECLARE v_count INT;
    
    SET v_count = 10;
    SET p_no = (p_no * v_count);
    
   	SELECT userId, userType INTO v_userId, v_userType FROM user_pref WHERE sessionId = p_sessionId;
    SELECT id INTO v_consumerTypeId FROM user_Type WHERE name = 'advisor';
    SELECT id INTO v_spTypeId FROM user_Type WHERE name = 'service provider';
    
    SET p_count = 0;
	IF(v_userId IS NULL) THEN
		SET p_result = 1;
	ELSEIF(v_userType <> v_consumerTypeId AND v_userType <> v_spTypeId) THEN
		SET p_result = 2;
	ELSE
		SET p_result = 3;
		SELECT id, comments, status, dateTime FROM events WHERE forUserId = v_userId LIMIT p_no, v_count;
        IF(p_no = 0) THEN
			SELECT COUNT(id) INTO p_count FROM events WHERE forUserId = v_userId AND status = 0 ;
        END IF;
	END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `getTotalWorkingHours` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `getTotalWorkingHours`(IN p_fromDateTime TIMESTAMP, IN p_toDateTime TIMESTAMP, IN p_fId INT, 
OUT p_hour INT, OUT p_minute INT)
BEGIN
	DECLARE v_day INT;
    DECLARE v_extraFromTime TIME;
    DECLARE v_extraToTime TIME;
    DECLARE v_tempHour INT;
	DECLARE v_tempMinute INT;
    DECLARE v_fromDate DATE;
    DECLARE v_toDate DATE;
	DECLARE v_fromTime TIME;
    DECLARE v_toTime TIME;
    
    SELECT CAST(p_fromDateTime AS TIME), CAST(p_toDateTime AS TIME), CAST(p_fromDateTime AS DATE), 
		CAST(p_toDateTime AS DATE), DATEDIFF(v_toDate, v_fromDate) + 1 INTO v_fromTime, v_toTime, v_fromDate, v_toDate, v_day;

	IF(v_day > 6) THEN
		SELECT SUM(TIMESTAMPDIFF(HOUR, openingTime, closingTime)), SUM(TIMESTAMPDIFF(MINUTE, openingTime, closingTime) % 60) 
			INTO p_hour, p_minute FROM facility_timing WHERE facilityId = p_fId;
		SET p_minute = p_minute * (v_day DIV 7);
		SET p_hour = p_hour * (v_day DIV 7);
		SET v_day = v_day % 7;
		IF(v_day > 0) THEN
			call getWorkingHours(p_fId, v_toDate, 0 - (v_day-1), v_tempHour, v_tempMinute);
			SET p_hour = p_hour + v_tempHour;
			SET p_minute = p_minute + v_tempMinute;
		END IF;
	ELSE
		call getWorkingHours(p_fId, v_toDate, 0 - (v_day-1), v_tempHour, v_tempMinute);
		SET p_hour = v_tempHour;
		SET p_minute = v_tempMinute;
	END IF;
	IF(v_toDate <> v_fromDate) THEN
		SELECT TIMEDIFF(v_fromTime, openingTime) INTO v_extraFromTime FROM facility_timing WHERE facilityId = p_fId AND weekDay = DAYOFWEEK(v_fromDate);
		SELECT TIMEDIFF(closingTime, v_toTime) INTO v_extraToTime FROM facility_timing WHERE facilityId = p_fId AND weekDay = DAYOFWEEK(v_toDate);
        SET p_hour = p_hour - (HOUR(v_extraFromTime) + HOUR(v_extraToTime));
		SET p_minute = p_minute - (MINUTE(v_extraFromTime) + MINUTE(v_extraToTime));
	ELSE
	   	SELECT TIMESTAMPDIFF(MINUTE, p_fromDateTime, p_toDateTime) % 60, TIMESTAMPDIFF(HOUR, p_fromDateTime, p_toDateTime) 
			INTO p_minute, p_hour;
	END IF;
	IF(p_minute > 0) THEN
		SET p_hour = p_hour + (p_minute DIV 60);
		SET p_minute = p_minute % 60;
		IF(p_minute <> 0) THEN
			SET p_hour = p_hour + 1;
			SET p_minute = 0;
		END IF;
	END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `getWorkingHours` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `getWorkingHours`(IN p_fId INT, IN p_endDay DATE, IN p_days INT, OUT p_hour INT, OUT p_minute INT)
BEGIN
	DECLARE v_nextDay DATE;
    DECLARE v_hour INT;
    DECLARE v_minute INT;
	
    SET p_hour = 0;
    SET p_minute = 0;
    SET v_nextDay = DATE_ADD(p_endDay, INTERVAL p_days DAY);
    WHILE v_nextDay <= p_endDay DO
		SELECT TIMESTAMPDIFF(HOUR, openingTime, closingTime), TIMESTAMPDIFF(MINUTE, openingTime, closingTime) % 60 INTO v_hour, v_minute
			FROM facility_timing WHERE facilityId = p_fId AND weekDay = DAYOFWEEK(v_nextDay);
		SET p_hour = p_hour + v_hour;
        SET p_minute = p_minute + v_minute;
        SET v_nextDay = DATE_ADD(v_nextDay, INTERVAL 1 DAY);
	END WHILE;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `moveBookingData` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `moveBookingData`(IN p_bookingId MEDIUMTEXT)
BEGIN

	DELETE FROM booking WHERE status = 0 AND TIMESTAMPDIFF(MINUTE, bookedTime, NOW()) > 7;
	SELECT GROUP_CONCAT(id) INTO p_bookingId FROM booking WHERE TIMESTAMPDIFF(MINUTE, NOW(), toTime) < 6;
	INSERT INTO `huddil`.`booking_history`
		(`fromDateTime`, `toDateTime`, `bookedTime`, `price`, `paymentMethod`, `userId`, `facilityId`, `bookingId`, `paymentId`, `seats`, `approvedTime`)
		SELECT fromTime, toTime, bookedTime, totalPrice, paymentMethod, userId, facilityId, id, paymentId, seats, approvedTime FROM booking WHERE FIND_IN_SET(id, p_bookingId);
	DELETE FROM booking WHERE FIND_IN_SET(id, p_bookingId);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `paymentAdminDashboard` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `paymentAdminDashboard`(IN p_month INT, IN p_year INT, IN p_city VARCHAR(45), IN p_spName VARCHAR(45), IN p_spId INT, OUT p_online DOUBLE, 
OUT p_onlineCancel DOUBLE, OUT p_onlineCancelCharges DOUBLE, OUT p_offline DOUBLE, OUT p_offlineCancel DOUBLE, OUT p_tranCharge DOUBLE, OUT p_commission DOUBLE, OUT p_settlement DOUBLE)
BEGIN
	
    DECLARE v_transactionCharge DOUBLE;
    DECLARE v_spIds MEDIUMTEXT;
    DECLARE v_commission DOUBLE;
    DECLARE v_userType INT;

    SET v_transactionCharge = 0.02; /*2% should be denoted as 0.02*/
    SELECT id INTO v_userType FROM user_type WHERE name = 'service provider';
    IF(p_spId = -1) THEN
		SELECT SUM(price) INTO p_online FROM(
			SELECT totalPrice AS price, id FROM booking WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND paymentMethod <> 'offline' AND status = 3 UNION
			SELECT price, id FROM booking_history WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND paymentMethod <> 'offline') temp;
		SELECT SUM(price) INTO p_offline FROM(
			SELECT totalPrice AS price, id FROM booking WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND paymentMethod = 'offline' AND status = 3 UNION
			SELECT price, id FROM booking_history WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND paymentMethod = 'offline') temp;
		SELECT SUM(refundAmount) INTO p_onlineCancel FROM cancellation WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND paymentMethod <> 'offline';
		SELECT SUM(totalPrice) - SUM(refundAmount) INTO p_onlineCancelCharges FROM cancellation WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND paymentMethod <> 'offline';
		SELECT SUM(refundAmount) INTO p_offlineCancel FROM cancellation WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND paymentMethod = 'offline';
		IF(p_online IS NULL) THEN
			SET p_online = 0;
		END IF;
		IF(p_onlineCancel IS NULL) THEN
			SET p_onlineCancel = 0;
		END IF;
		IF(p_offline IS NULL) THEN
			SET p_offline = 0;
		END IF;
		IF(p_offlineCancel IS NULL) THEN
			SET p_offlineCancel = 0;
		END IF;
		IF(p_onlineCancelCharges IS NULL) THEN
			SET p_onlineCancelCharges = 0;
		END IF;

		SELECT SUM(commission) INTO p_commission FROM (SELECT SUM(totalPrice) * u.commission AS commission FROM booking b
			JOIN facility f ON f.id = b.facilityId
			JOIN sp_commission u ON u.spUserId = f.spUserId AND FIND_IN_SET(p_month, u.month) AND u.year = p_year WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND b.status = 3
			GROUP BY f.spUserId, u.commission
            UNION
            SELECT SUM(price) * u.commission AS commission FROM booking_history b
   			JOIN facility f ON f.id = b.facilityId
			JOIN sp_commission u ON u.spUserId = f.spUserId AND FIND_IN_SET(p_month, u.month) AND u.year = p_year WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year
			GROUP BY f.spUserId, u.commission
            UNION
            SELECT (SUM(totalPrice) - SUM(refundAmount)) * u.commission AS commission FROM cancellation b
			JOIN facility f ON f.id = b.facilityId
			JOIN sp_commission u ON u.spUserId = f.spUserId AND FIND_IN_SET(p_month, u.month) AND u.year = p_year WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year 
			GROUP BY f.spUserId, u.commission) AS temp;
		IF(p_commission IS NULL) THEN
			SET p_commission = 0;
		END IF;
		SET p_tranCharge = (p_online + p_onlineCancel + p_onlineCancelCharges) * v_transactionCharge;
		SET p_settlement = p_online - (p_commission + p_tranCharge);
    ELSEIF(p_spId = 0) THEN
		IF(p_city <> '0' AND p_spName <> '') THEN
			SELECT GROUP_CONCAT(DISTINCT u.userId) INTO v_spIds FROM facility f JOIN user_pref u ON f.spUserId = u.userId WHERE f.cityName = p_city AND u.emailId LIKE CONCAT('%', CONCAT(p_spName, '%')) AND u.userType = v_userType;
		ELSEIF(p_city <> '0') THEN
			SELECT GROUP_CONCAT(DISTINCT u.userId) INTO v_spIds FROM facility f JOIN user_pref u ON f.spUserId = u.userId WHERE f.cityName = p_city;
		ELSEIF(p_spName <> '') THEN
			SELECT GROUP_CONCAT(DISTINCT u.userId) INTO v_spIds FROM facility f JOIN user_pref u ON f.spUserId = u.userId WHERE u.emailId LIKE CONCAT('%', CONCAT(p_spName, '%')) AND u.userType = v_userType;
		ELSE 
			SET v_spIds = '';
		END IF;
		IF(v_spIds = '') THEN
			SELECT SUM(CASE WHEN paymentMethod <> 'offline' THEN total ELSE 0 END), 
					SUM(CASE WHEN paymentMethod = 'offline' THEN total ELSE 0 END) INTO p_online, p_offline FROM(
				SELECT totalPrice AS total, paymentMethod, id FROM booking WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year 
					AND status = 3 UNION
				SELECT price AS total, paymentMethod, id FROM booking_history WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year) AS temp;
			SELECT SUM(CASE WHEN paymentMethod <> 'offline' THEN refundAmount ELSE 0 END), 
					SUM(CASE WHEN paymentMethod = 'offline' THEN refundAmount ELSE 0 END), 
					SUM(CASE WHEN paymentMethod <> 'offline' THEN totalPrice - refundAmount ELSE 0 END) 
                    INTO p_onlineCancel, p_offlineCancel, p_onlineCancelCharges
				FROM cancellation WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year;
			IF(p_online IS NULL) THEN
				SET p_online = 0;
			END IF;
			IF(p_onlineCancel IS NULL) THEN
				SET p_onlineCancel = 0;
			END IF;
			IF(p_offline IS NULL) THEN
				SET p_offline = 0;
			END IF;
			IF(p_offlineCancel IS NULL) THEN
				SET p_offlineCancel = 0;
			END IF;
			IF(p_onlineCancelCharges IS NULL) THEN
				SET p_onlineCancelCharges = 0;
			END IF;
			SELECT SUM(commission) INTO p_commission FROM (SELECT SUM(totalPrice) * u.commission AS commission FROM booking b
				JOIN facility f ON f.id = b.facilityId
				JOIN sp_commission u ON u.spUserId = f.spUserId AND FIND_IN_SET(p_month, u.month) AND u.year = p_year 
                WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND b.status = 3 GROUP BY f.spUserId, u.commission
                UNION
				SELECT SUM(price) * u.commission AS commission FROM booking_history b
				JOIN facility f ON f.id = b.facilityId
				JOIN sp_commission u ON u.spUserId = f.spUserId AND FIND_IN_SET(p_month, u.month) AND u.year = p_year 
                WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year GROUP BY f.spUserId, u.commission
                UNION
				SELECT (SUM(totalPrice) - SUM(refundAmount)) * u.commission AS commission FROM cancellation b
				JOIN facility f ON f.id = b.facilityId
				JOIN sp_commission u ON u.spUserId = f.spUserId AND FIND_IN_SET(p_month, u.month) AND u.year = p_year 
                WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year GROUP BY f.spUserId, u.commission) AS temp;
			IF(p_commission IS NULL) THEN
				SET p_commission = 0;
			END IF;
			SET p_tranCharge = (p_online + p_onlineCancel + p_onlineCancelCharges) * v_transactionCharge;
			SET p_settlement = p_online - (p_commission + p_tranCharge);
			
			DROP TABLE IF EXISTS paymentAmt;
			DROP TABLE IF EXISTS refundAmt;
			
            CREATE TABLE IF NOT EXISTS paymentAmt AS 
				SELECT spUserId AS pUserId, displayName AS pDName, commission AS pPercentage, 
					SUM(CASE WHEN paymentMethod <> 'offline' THEN total ELSE 0 END) AS onlinePay, 
                    SUM(CASE WHEN paymentMethod = 'offline' THEN total ELSE 0 END) AS offlinePay FROM
					(SELECT b.totalPrice AS total, f.spUserId, u.displayName, s.commission, b.paymentMethod, b.id FROM booking b
						JOIN facility f ON f.id = b.facilityId
						JOIN user_pref u ON u.userId = f.spUserId
                        JOIN sp_commission s ON s.spUserId = f.spUserId AND FIND_IN_SET(p_month, s.month) AND s.year = p_year 
						WHERE MONTH(b.bookedTime) = p_month AND YEAR(b.bookedTime) = p_year AND b.status = 3 UNION
					SELECT price AS total, f.spUserId, u.displayName, s.commission, b.paymentMethod, b.id FROM booking_history b
						JOIN facility f ON f.id = b.facilityId
						JOIN user_pref u ON u.userId = f.spUserId
                        JOIN sp_commission s ON s.spUserId = f.spUserId AND FIND_IN_SET(p_month, s.month) AND s.year = p_year 
						WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year) AS temp GROUP BY pUserId, displayName, commission;
    
            CREATE TABLE IF NOT EXISTS refundAmt AS 
            SELECT f.spUserId AS rUserId, u.displayName AS rDName, s.commission AS rPercentage, 
            SUM(CASE WHEN c.paymentMethod <> 'offline' THEN c.refundAmount ELSE 0 END) AS onlineRef, 
            SUM(CASE WHEN c.paymentMethod = 'offline' THEN c.refundAmount ELSE 0 END) AS offlineRef,
            SUM(CASE WHEN c.paymentMethod <> 'offline' THEN c.totalPrice - c.refundAmount ELSE 0 END) AS onlineCancel FROM cancellation c
				JOIN facility f ON f.id = c.facilityId
				JOIN user_pref u ON u.userId = f.spUserId
                JOIN sp_commission s ON s.spUserId = f.spUserId AND FIND_IN_SET(p_month, s.month) AND s.year = p_year 
				WHERE MONTH(c.bookedTime) = p_month AND YEAR(c.bookedTime) = p_year GROUP BY rUserId, u.displayName, s.commission;

			SELECT userId, dName, '' AS fName, '' AS lName, '' AS cName, 
            @onlinePay := IF(onlinePay IS NULL, 0 , onlinePay) AS onlinePay, 
            @onlineRef := IF(onlineRef IS NULL, 0 , onlineRef) AS onlineRef,
            @onlineCancelCharge := IF(onlineCancel IS NULL, 0, onlineCancel) AS onlineCancelCharge,
			@offlinePay := IF(offlinePay IS NULL, 0 , offlinePay) AS offlinePay, 
            @offlineRef := IF(offlineRef IS NULL, 0 , offlineRef) AS offlineRef, 
            ROUND(@tran := (@onlinePay + @onlineRef + @onlineCancelCharge) * v_transactionCharge, 2) AS tranCharge,
			ROUND(@commission := (@onlinePay + @offlinePay + @onlineCancelCharge) * percentage, 2) AS commission, ROUND(@onlinePay - (@tran + @commission), 2) AS settlement  FROM 
				(SELECT pUserId AS userId, pDName AS dName, pPercentage AS percentage, onlinePay, onlineRef, onlineCancel, offlinePay, offlineRef FROM paymentAmt p
				JOIN refundAmt r ON p.puserId = r.ruserId
				UNION
				SELECT pUserId AS userId, pDName AS dName, pPercentage AS percentage, onlinePay, onlineRef, onlineCancel, offlinePay, offlineRef FROM paymentAmt p
				LEFT JOIN refundAmt r ON p.puserId = r.ruserId
				UNION
				SELECT rUserId AS userId, rDName AS dName, rPercentage AS percentage, onlinePay, onlineRef, onlineCancel, offlinePay, offlineRef FROM paymentAmt p
				RIGHT JOIN refundAmt r ON p.puserId = r.ruserId) AS paymentReport;
		ELSE
			SELECT SUM(CASE WHEN paymentMethod <> 'offline' THEN total ELSE 0 END), 
				   SUM(CASE WHEN paymentMethod = 'offline' THEN total ELSE 0 END) INTO p_online, p_offline FROM(
				SELECT b.totalPrice AS total, b.paymentMethod, b.id FROM booking b JOIN facility f ON b.facilityId = f.id 
					WHERE MONTH(b.bookedTime) = p_month AND YEAR(b.bookedTime) = p_year AND b.status = 3 AND FIND_IN_SET(f.spUserId, v_spIds) 
				UNION
				SELECT b.price AS total, b.paymentMethod, b.id FROM booking_history b JOIN facility f ON b.facilityId = f.id 
					WHERE MONTH(b.bookedTime) = p_month AND YEAR(b.bookedTime) = p_year AND FIND_IN_SET(f.spUserId, v_spIds)) AS temp;

			SELECT  SUM(CASE WHEN c.paymentMethod <> 'offline' THEN c.refundAmount ELSE 0 END), 
					SUM(CASE WHEN c.paymentMethod = 'offline' THEN c.refundAmount ELSE 0 END),
 					SUM(CASE WHEN c.paymentMethod <> 'offline' THEN c.totalPrice - c.refundAmount ELSE 0 END) 
                    INTO p_onlineCancel, p_offlineCancel, p_onlineCancelCharges
				FROM cancellation c JOIN facility f ON c.facilityId = f.id 
                WHERE MONTH(c.bookedTime) = p_month AND YEAR(c.bookedTime) = p_year AND FIND_IN_SET(f.spUserId, v_spIds);
			IF(p_online IS NULL) THEN
				SET p_online = 0;
			END IF;
			IF(p_onlineCancel IS NULL) THEN
				SET p_onlineCancel = 0;
			END IF;
			IF(p_offline IS NULL) THEN
				SET p_offline = 0;
			END IF;
			IF(p_offlineCancel IS NULL) THEN
				SET p_offlineCancel = 0;
			END IF;
			IF(p_onlineCancelCharges IS NULL) THEN
				SET p_onlineCancelCharges = 0;
			END IF;

			SELECT SUM(commission) INTO p_commission FROM (
				SELECT SUM(totalPrice) * s.commission AS commission FROM booking b
					JOIN facility f ON f.id = b.facilityId
					JOIN sp_commission s ON s.spUserId = f.spUserId AND FIND_IN_SET(p_month, s.month) AND s.year = p_year 
						WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND FIND_IN_SET(s.spUserId, v_spIds) AND b.status = 3
						GROUP BY f.spUserId, s.commission 
				UNION
				SELECT SUM(price) * s.commission AS commission FROM booking_history b
					JOIN facility f ON f.id = b.facilityId
					JOIN sp_commission s ON s.spUserId = f.spUserId AND FIND_IN_SET(p_month, s.month) AND s.year = p_year 
                    WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND FIND_IN_SET(s.spUserId, v_spIds) GROUP BY f.spUserId, s.commission 
				UNION
				SELECT (SUM(totalPrice) - SUM(refundAmount)) * u.commission AS commission FROM cancellation b
					JOIN facility f ON f.id = b.facilityId
					JOIN sp_commission u ON u.spUserId = f.spUserId AND FIND_IN_SET(p_month, u.month) AND u.year = p_year 
					WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND FIND_IN_SET(u.spUserId, v_spIds) GROUP BY f.spUserId, u.commission) AS temp;
			IF(p_commission IS NULL) THEN
				SET p_commission = 0;
			END IF;
			SET p_tranCharge = (p_online + p_onlineCancel + p_onlineCancelCharges) * v_transactionCharge;
			SET p_settlement = p_online - (p_commission + p_tranCharge);

			DROP TABLE IF EXISTS paymentAmt;
			DROP TABLE IF EXISTS refundAmt;

            CREATE TABLE IF NOT EXISTS paymentAmt AS 
				SELECT spUserId AS pUserId, displayName AS pDName, commission AS pPercentage, 
                SUM(CASE WHEN paymentMethod <> 'offline' THEN total ELSE 0 END) AS onlinePay, 
                SUM(CASE WHEN paymentMethod = 'offline' THEN total ELSE 0 END) AS offlinePay FROM
					(SELECT b.totalPrice AS total, f.spUserId, u.displayName, s.commission, b.paymentMethod, b.id FROM booking b
						JOIN facility f ON f.id = b.facilityId
						JOIN user_pref u ON u.userId = f.spUserId
                        JOIN sp_commission s ON s.spUserId = f.spUserId AND FIND_IN_SET(p_month, s.month) AND s.year = p_year
						WHERE MONTH(b.bookedTime) = p_month AND YEAR(b.bookedTime) = p_year AND b.status = 3  AND FIND_IN_SET(u.userId, v_spIds) UNION
					SELECT price AS total, f.spUserId, u.displayName, s.commission, b.paymentMethod, b.id FROM booking_history b
						JOIN facility f ON f.id = b.facilityId
						JOIN user_pref u ON u.userId = f.spUserId
                        JOIN sp_commission s ON s.spUserId = f.spUserId AND FIND_IN_SET(p_month, s.month) AND s.year = p_year
						WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND FIND_IN_SET(u.userId, v_spIds)) AS temp 
				GROUP BY pUserId, displayName, commission;

			CREATE TABLE IF NOT EXISTS refundAmt AS 
				SELECT f.spUserId AS rUserId, u.displayName AS rDName, s.commission AS rPercentage, 
                SUM(CASE WHEN c.paymentMethod <> 'offline' THEN c.refundAmount ELSE 0 END) AS onlineRef, 
                SUM(CASE WHEN c.paymentMethod = 'offline' THEN c.refundAmount ELSE 0 END) AS offlineRef,
				SUM(CASE WHEN c.paymentMethod <> 'offline' THEN c.totalPrice - c.refundAmount ELSE 0 END) AS onlineCancel FROM cancellation c
					JOIN facility f ON f.id = c.facilityId
					JOIN location l ON l.id = f.locationId
					JOIN user_pref u ON u.userId = f.spUserId
					JOIN sp_commission s ON s.spUserId = f.spUserId AND FIND_IN_SET(p_month, s.month) AND s.year = p_year
					WHERE MONTH(c.bookedTime) = p_month AND YEAR(c.bookedTime) = p_year AND FIND_IN_SET(u.userId, v_spIds) 
                GROUP BY rUserId, s.commission;

			SELECT userId, dName, '' AS fName, '' AS lName, '' AS cName, 
            @onlinePay := IF(onlinePay IS NULL, 0 , onlinePay) AS onlinePay, 
            @onlineRef := IF(onlineRef IS NULL, 0 , onlineRef) AS onlineRef,
            @onlineCancelCharge := IF(onlineCancel IS NULL, 0, onlineCancel) AS onlineCancelCharge,
			@offlinePay := IF(offlinePay IS NULL, 0 , offlinePay) AS offlinePay, 
            @offlineRef := IF(offlineRef IS NULL, 0 , offlineRef) AS offlineRef, 
            ROUND(@tran := (@onlinePay + @onlineRef + @onlineCancelCharge) * v_transactionCharge, 2) AS tranCharge,
			ROUND(@commission := (@onlinePay + @offlinePay + @onlineCancelCharge) * percentage, 2) AS commission, 
            ROUND(@onlinePay - (@tran + @commission), 2) AS settlement  FROM 
				(SELECT pUserId AS userId, pDName AS dName, pPercentage AS percentage, onlinePay, onlineRef, onlineCancel, offlinePay, offlineRef FROM paymentAmt p
				JOIN refundAmt r ON p.puserId = r.ruserId
				UNION
				SELECT pUserId AS userId, pDName AS dName, pPercentage AS percentage, onlinePay, onlineRef, onlineCancel, offlinePay, offlineRef FROM paymentAmt p
				LEFT JOIN refundAmt r ON p.puserId = r.ruserId
				UNION
				SELECT rUserId AS userId, rDName AS dName, rPercentage AS percentage, onlinePay, onlineRef, onlineCancel, offlinePay, offlineRef FROM paymentAmt p
				RIGHT JOIN refundAmt r ON p.puserId = r.ruserId) AS paymentReport;

			DROP TABLE IF EXISTS paymentAmt;
			DROP TABLE IF EXISTS refundAmt;        
		END IF;
    ELSE
		SELECT commission INTO v_commission FROM sp_commission WHERE spUserId = p_spId AND FIND_IN_SET(p_month, month) AND year = p_year;
		SELECT SUM(CASE WHEN paymentMethod <> 'offline' THEN total ELSE 0 END), 
				SUM(CASE WHEN paymentMethod = 'offline' THEN total ELSE 0 END) INTO p_online, p_offline FROM(
			SELECT b.totalPrice AS total, b.paymentMethod, b.id FROM booking b JOIN facility f ON b.facilityId = f.id 
				WHERE MONTH(b.bookedTime) = p_month AND YEAR(b.bookedTime) = p_year AND b.status = 3 AND f.spUserId = p_spId UNION
			SELECT b.price AS total, b.paymentMethod, b.id FROM booking_history b JOIN facility f ON b.facilityId = f.id 
				WHERE MONTH(b.bookedTime) = p_month AND YEAR(b.bookedTime) = p_year AND f.spUserId = p_spId) AS temp;
		
        SELECT SUM(CASE WHEN c.paymentMethod <> 'offline' THEN c.refundAmount ELSE 0 END), 
				SUM(CASE WHEN c.paymentMethod = 'offline' THEN c.refundAmount ELSE 0 END),
                SUM(CASE WHEN c.paymentMethod <> 'offline' THEN c.totalPrice - c.refundAmount ELSE 0 END) 
                INTO p_onlineCancel, p_offlineCancel, p_onlineCancelCharges
			FROM cancellation c JOIN facility f ON c.facilityId = f.id WHERE MONTH(c.bookedTime) = p_month AND YEAR(c.bookedTime) = p_year AND f.spUserId = p_spId;
 		IF(p_online IS NULL) THEN
			SET p_online = 0;
		END IF;
		IF(p_onlineCancel IS NULL) THEN
			SET p_onlineCancel = 0;
		END IF;
		IF(p_offline IS NULL) THEN
			SET p_offline = 0;
		END IF;
		IF(p_offlineCancel IS NULL) THEN
			SET p_offlineCancel = 0;
		END IF;
		IF(p_onlineCancelCharges IS NULL) THEN
			SET p_onlineCancelCharges = 0;
		END IF;
        SET p_commission = (p_online + p_offline + p_onlineCancelCharges) * v_commission;
		IF(p_commission IS NULL) THEN
			SET p_commission = 0;
		END IF;
        SET p_tranCharge = (p_online + p_onlineCancel + p_onlineCancelCharges) * v_transactionCharge;
		SET p_settlement = p_online - (p_commission + p_tranCharge);
		
        DROP TABLE IF EXISTS paymentAmt;
		DROP TABLE IF EXISTS refundAmt;

		CREATE TABLE IF NOT EXISTS paymentAmt AS 
		SELECT pId, pTitle, pName, pCity, pUserId, 
				SUM(CASE WHEN paymentMethod <> 'offline' THEN total ELSE 0 END) AS onlinePay, 
                SUM(CASE WHEN paymentMethod = 'offline' THEN total ELSE 0 END) AS offlinePay FROM
			(SELECT f.title AS pTitle, l.name AS pName, b.paymentMethod, b.totalPrice AS total, f.id AS pId, 
				f.cityName AS pCity, f.spUserId AS pUserId, b.id FROM booking b
				JOIN facility f ON f.id = b.facilityId
				JOIN location l ON l.id = f.locationId
				WHERE MONTH(b.bookedTime) = p_month AND YEAR(b.bookedTime) = p_year AND b.status = 3 AND f.spUserId = p_spId UNION
			SELECT f.title AS pTitle, l.name AS pName, b.paymentMethod, b.price AS total, f.id AS pId, 
				f.cityName AS pCity, f.spUserId AS pUserId, b.id FROM booking_history b
				JOIN facility f ON f.id = b.facilityId
				JOIN location l ON l.id = f.locationId
				WHERE MONTH(bookedTime) = p_month AND YEAR(bookedTime) = p_year AND f.spUserId = p_spId) AS temp 
		GROUP BY pId, pTitle, pName, pCity, pUserId;

		CREATE TABLE IF NOT EXISTS refundAmt AS 
		SELECT f.id AS rId, f.title AS rTitle, l.name AS rName, f.cityName AS rCity, f.spUserId AS rUserId, 
				SUM(CASE WHEN c.paymentMethod <> 'offline' THEN c.refundAmount ELSE 0 END) AS onlineRef, 
                SUM(CASE WHEN c.paymentMethod = 'offline' THEN c.refundAmount ELSE 0 END) AS offlineRef,
				SUM(CASE WHEN c.paymentMethod <> 'offline' THEN c.totalPrice - c.refundAmount ELSE 0 END) AS onlineCancel FROM cancellation c
					JOIN facility f ON f.id = c.facilityId
					JOIN location l ON l.id = f.locationId
				WHERE MONTH(c.bookedTime) = p_month AND YEAR(c.bookedTime) = p_year AND f.spUserId = p_spId 
			GROUP BY f.id, f.title, l.name, f.cityName, f.spUserId;
            
		SELECT p_spId AS userId, '' AS dName, fName, lName, cName, 
        @onlinePay := IF(onlinePay IS NULL, 0 , onlinePay) AS onlinePay, 
        @onlineRef := IF(onlineRef IS NULL, 0 , onlineRef) AS onlineRef,
        @onlineCancelCharge := IF(onlineCancel IS NULL, 0, onlineCancel) AS onlineCancelCharge,
		@offlinePay := IF(offlinePay IS NULL, 0 , offlinePay) AS offlinePay, 
        @offlineRef := IF(offlineRef IS NULL, 0 , offlineRef) AS offlineRef, 
        ROUND(@tran := (@onlinePay + @onlineRef + @onlineCancelCharge) * v_transactionCharge, 2) AS tranCharge,
		ROUND(@commission := (@onlinePay + @offlinePay + @onlineCancelCharge) * v_commission, 2) AS commission, 
        ROUND(@onlinePay - (@tran + @commission), 2) AS settlement  FROM 
			(SELECT pTitle AS fName, pName AS lName, pCity AS cName, onlinePay, onlineRef, onlineCancel, offlinePay, offlineRef FROM paymentAmt p
			JOIN refundAmt r ON p.pId = r.rID
			UNION
			SELECT pTitle AS fName, pName AS lName, pCity AS cName, onlinePay, onlineRef, onlineCancel, offlinePay, offlineRef FROM paymentAmt p
			LEFT JOIN refundAmt r ON p.pId = r.rID
			UNION
			SELECT rTitle AS fName, rName AS lName, rCity AS cName, onlinePay, onlineRef, onlineCancel, offlinePay, offlineRef FROM paymentAmt p
			RIGHT JOIN refundAmt r ON p.pId = r.rID) AS paymentReport;

        DROP TABLE IF EXISTS paymentAmt;
		DROP TABLE IF EXISTS refundAmt;
    END IF;
    SET p_online = ROUND(p_online, 2);
    SET p_onlineCancel = ROUND(p_onlineCancel, 2);
    SET p_offline = ROUND(p_offline, 2);
    SET p_offlineCancel = ROUND(p_offlineCancel, 2);
    SET p_tranCharge = ROUND(p_tranCharge, 2);
    SET p_commission = ROUND(p_commission, 2);
    SET p_settlement = ROUND(p_settlement, 2);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `paymentReport` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `paymentReport`(IN v_sessionId VARCHAR(255), IN v_cityId INT, IN v_localityId INT, IN v_type INT, IN v_month INT, IN v_selection INT, OUT v_result INT)
BEGIN

    DECLARE v_userType INT;
    SET v_result= 0;
   SELECT userType INTO v_userType FROM user_pref WHERE sessionId = v_sessionId;
   IF(v_userType IS NULL) THEN
        SET v_result = -1;
    ELSEIF(v_userType <> (SELECT id FROM user_type WHERE name = 'service provider')) THEN
        SET v_result = -2;
    ELSE
        IF(v_selection = 1)THEN
            SET @query = "SELECT CAST(b.bookedTime AS DATE) AS date, f.title, f.typeName as facilityType, lo.name as buildingName, c.name as city, l.name as locality, SUM(b.price) as payment, k.displayName as consumerName, p.displayName as serviceProvider FROM huddil.booking b 
JOIN huddil.facility f ON b.facilityId = f.id JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l ON l.name = f.localityName
JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON f.typeName = t.name JOIN huddil.user_pref p ON f.spUserId = p.userId
JOIN huddil.user_pref k ON k.userId = b.userId 
WHERE p.sessionId = 'v_sessionId' AND month(b.bookedTime) = v_month AND c.id = v_cityId AND l.id = v_localityId AND t.id = v_type AND b.status = 3
GROUP BY CAST(b.bookedTime AS DATE), f.typeName, lo.name, l.name, c.name, k.displayName, p.displayName
UNION
SELECT CAST(b.bookedTime AS DATE) AS date, f.title, f.typeName as facilityType, lo.name as buildingName, c.name as city, l.name as locality, SUM(b.price) as payment, k.displayName as consumerName, p.displayName as serviceProvider 
FROM huddil.booking_history b JOIN huddil.facility f ON b.facilityId = f.id JOIN huddil.city c ON c.name = f.cityName
JOIN huddil.locality l ON l.name = f.localityName JOIN huddil.location lo ON lo.id = f.locationId JOIN huddil.facility_type t ON f.typeName = t.name
JOIN huddil.user_pref p ON f.spUserId = p.userId JOIN huddil.user_pref k ON k.userId = b.userId 
WHERE p.sessionId = 'v_sessionId' AND month(b.bookedTime) = v_month AND c.id = v_cityId AND l.id = v_localityId AND t.id = v_type
GROUP BY CAST(b.bookedTime AS DATE), f.title, f.typeName, lo.name, l.name, c.name, k.displayName, p.displayName;";
        ELSEIF(v_selection = 0)THEN
            SET @query = "SELECT CAST(b.bookedTime AS DATE) AS date, f.title, f.typeName as facilityType, lo.name as buildingName, c.name as city, l.name as locality, SUM(b.refundAmount) as payment, k.displayName as consumerName, p.displayName as serviceProvider FROM huddil.cancellation b 
JOIN huddil.facility f ON b.facilityId = f.id 
JOIN huddil.city c ON c.name = f.cityName
JOIN huddil.locality l ON l.name = f.localityName
JOIN huddil.location lo ON lo.id = f.locationId
JOIN huddil.facility_type t ON f.typeName = t.name
JOIN huddil.user_pref p ON f.spUserId = p.userId
JOIN huddil.user_pref k ON k.userId = b.bookedUserId
WHERE p.sessionId = 'v_sessionId' AND month(b.bookedTime) = v_month AND c.id = v_cityId AND l.id = v_localityId AND t.id = v_type
GROUP BY CAST(b.bookedTime AS DATE), f.title, f.typeName, lo.name, l.name, c.name, k.displayName, p.displayName";
		END IF;
        SET @query = REPLACE(@query, 'v_sessionId', v_sessionId);

        IF(v_month = 0)THEN
            SET @query = REPLACE(@query, "AND month(b.bookedTime) = v_month ","");
        ELSE
            SET @query = REPLACE(@query, "v_month", v_month);
        END IF;

		IF(v_cityId = 0) THEN
			SET @query = REPLACE(@query, "AND c.id = v_cityId", '');
		ELSE
			SET @query = REPLACE(@query, "v_cityId", v_cityId);
        END IF;
        IF(v_localityId = 0) THEN
			SET @query = REPLACE(@query, " AND l.id = v_localityId ", '');
        ELSE
			SET @query = REPLACE(@query, "v_localityId", v_localityId);
        END IF;
        IF(v_type = 0) THEN
			SET @query = REPLACE(@query, "AND t.id = v_type", '');
        ELSE
			SET @query = REPLACE(@query, "v_type", v_type);
        END IF;

        PREPARE stmt FROM @query;
        EXECUTE stmt;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `performCancellation` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `performCancellation`(IN p_type INT, IN p_bookingId INT, IN p_facilityId INT, IN p_sessionId VARCHAR(128), IN p_reason VARCHAR(255), 
		IN p_operation INT, IN p_fromDateTime TIMESTAMP, IN p_toDateTime TIMESTAMP, OUT p_cancel INT, OUT p_result INT, OUT p_refund DOUBLE, OUT p_cancellationPrice DOUBLE, 
        OUT p_totalPrice DOUBLE, OUT p_count INT)
BEGIN

	/*
		p_type - operation performed
        1 - Cancel a booking
        2 - Add a facility under maintenance
        3 - Stop a facility
        
        p_operation - activity needs to be performed
        1 - calculate refund for a single booking
        2 - confirm and cancel a single booking
        3 - check for bookings before scheduling for maintenance
        4 - calculate refund before scheduling for maintenance
        5 - confirm, cancel all bookings and schedule for maintenance
        
        p_result will contain the result of the procdure execution
		1 - invalid sessionId
        2 - invalid userType
        3 - invalid bookingId
        4 - invalid facilityId
        5 - invalid input type
        6 - paymnet in-process
        7 - meeting is in progress, cannot cancel the booking
        8 - booking status is already cancelled
        9 - user does not permisson to cancel the booking
        10 - payment mode is offline, so no refund
        11 - single ofline booking is cancelled
		12 - paymnet mode is not offline, refund amount is calculated
		13 - single online booking is cancelled
		14 - specified facility is not in approved or verified status
		15 - current user id not the owner of the facility
		16 - there are no online bookings for the give time period, hence no refund will be made
		17 - there are online bookings for the give time period, hence refund will be made
		18 - single/ multiple cancellations are made and facility is marked for maintenace for the specified period
    */
    
    DECLARE v_userId INT;
    DECLARE v_userType INT;
    DECLARE v_consumerTypeId INT;
    DECLARE v_spTypeId INT;
    DECLARE v_facilityTd INT;
    DECLARE v_bookedUserId INT;
    DECLARE v_days INT;
    DECLARE v_cancellationPolicyId INT;
    DECLARE v_cancellationCharge DOUBLE;
	DECLARE v_bookingIds MEDIUMTEXT;
    DECLARE v_approvedStatus INT;
    DECLARE v_verifiedStatus INT;
    DECLARE v_pendStatus INT;
    DECLARE v_deactivateStatus INT;
    DECLARE v_veriAndDeacStatus INT;
    DECLARE v_spUserId INT;
    DECLARE v_paymentMode VARCHAR(45);
    DECLARE v_confirmedStatus INT;
    DECLARE v_pendingStatus INT;
    DECLARE v_basePrice DOUBLE;
    DECLARE v_bookingStatus INT;
    
	SELECT userId, userType INTO v_userId, v_userType FROM user_pref WHERE sessionId = p_sessionId;
    SELECT id INTO v_consumerTypeId FROM user_type WHERE name = 'consumer';
    SELECT id INTO v_spTypeId FROM user_type WHERE name = 'service provider';
    SELECT id INTO v_confirmedStatus FROM booking_status WHERE name = 'confirmed';
    SELECT id INTO v_pendingStatus FROM booking_status WHERE name = 'pending';
	IF(p_bookingId <> 0) THEN
		SELECT facilityId, status INTO v_facilityTd, v_bookingStatus FROM booking WHERE id = p_bookingId;
    ELSE
		SET v_facilityTd = p_facilityId;
    END IF;
    IF(v_userId IS NULL) THEN
		SET p_result = 1;
	ELSEIF(v_userType <> v_consumerTypeId AND v_userType <> v_spTypeId) THEN
		SET p_result = 2;
	ELSEIF(p_type = 1 AND (SELECT id FROM booking WHERE id = p_bookingId) IS NULL) THEN
		SET p_result = 3;
	ELSEIF(p_type <> 4 AND v_facilityTd IS NULL) THEN
		SET p_result = 4;
	ELSEIF(p_type = 1 AND (SELECT status FROM booking WHERE id = p_bookingId) = 0) THEN
		SET p_result = 6;
	ELSEIF((SELECT COUNT(id) FROM booking WHERE fromTime <= NOW() AND toTime > NOW() AND id = p_bookingId AND status = 1) <> 0)THEN
		SET p_result = 7;
	ELSEIF(p_type <> 4 AND v_bookingStatus <> v_confirmedStatus AND v_bookingStatus <> v_pendingStatus) THEN
		SET p_result = 8;
	ELSE
		IF(p_type = 1 AND (v_userType = v_consumerTypeId OR v_userType = v_spTypeId)) THEN
			SELECT userId INTO v_bookedUserId FROM booking WHERE id = p_bookingId;
            SELECT f.spUserId INTO v_spUserId FROM facility f JOIN booking b ON f.id = b.facilityId WHERE b.id = p_bookingId;
			IF(v_bookedUserId <> v_userId AND v_spUserId <> v_userId) THEN
				SET p_result = 9;
            ELSE
				SELECT paymentMethod INTO v_paymentMode FROM booking WHERE id = p_bookingId AND (status = v_confirmedStatus OR status = v_pendingStatus);
				IF(p_operation = 1 AND v_paymentMode = 'Offline') THEN
					SET p_result = 10;
				ELSEIF( p_operation = 2 AND v_paymentMode = 'Offline') THEN
					SET p_result = 11;
				ELSEIF(p_operation = 1 AND v_paymentMode <> 'Offline') THEN
					SET p_result = 12;
				ELSEIF(p_operation = 2 AND v_paymentMode <> 'Offline') THEN
					SET p_result = 13;
				END IF;
                IF(p_result = 12 OR p_result = 13) THEN
					SELECT price, totalPrice, HOUR(TIMEDIFF(fromTime, NOW())) / 24, cancellationPolicyId INTO 
						v_basePrice, p_totalPrice, v_days, v_cancellationPolicyId FROM booking WHERE id = p_bookingId;
					IF(v_bookedUserId = v_userId) THEN
						SELECT IF(v_days >= duration1, percentage1, IF(v_days >= duration2, percentage2, percentage3)) INTO v_cancellationCharge FROM facility_cancellation_charges WHERE id = v_cancellationPolicyId;
						IF(v_cancellationCharge = 0) THEN
							SET p_refund = 0;
						ELSE
							SET p_refund = v_basePrice - (v_basePrice * v_cancellationCharge / 100) + p_totalPrice - v_basePrice;
                        END IF;
					ELSEIF(v_spUserId = v_userId) THEN
						SET p_refund = p_totalPrice;
                    END IF;
                    SET p_cancellationPrice = p_totalPrice - p_refund;
				ELSEIF(p_result = 11) THEN
					SELECT totalPrice INTO p_refund FROM booking WHERE id = p_bookingId;
				END IF;
				IF(p_result = 11 OR p_result = 13) THEN
					INSERT INTO `huddil`.`cancellation` (`bookedFrom`, `bookedTo`, `bookedTime`, `seats`, `price`, `totalPrice`, `refundAmount`, `paymentId`, `paymentMethod`, `cancellationPolicyId`, `facilityId`, 
						`bookedUserId`, `cancelledUserId`, `bookingId`, `bookedStatus`, `approvedTime`)
					SELECT fromTime, toTime, bookedTime, seats, price, totalPrice, TRUNCATE(p_refund, 2), paymentId, paymentMethod, cancellationPolicyId, facilityId, userId, v_userId, id, status, 
						approvedTime FROM booking WHERE id = p_bookingId;
                    IF((SELECT typeName from facility WHERE id = v_facilityTd) = 'Co-Working Space' AND v_userType = v_spTypeId) THEN 
						UPDATE cancellation SET bookedStatus = 4 WHERE bookingId = p_bookingId;
                    END IF;
					SET p_cancel = LAST_INSERT_ID();
					SELECT u.displayName AS spName, u.emailId AS spEmailId, u.mobileNo AS spMobileNo, u.mobileNoVerified AS spMobileVerified, 
							p.displayName AS cName, p.emailId AS cEmailId, p.mobileNo AS cMobileNo, p.mobileNoVerified  AS cMobileVerified,
							c.duration1, c.percentage1, c.duration2, c.percentage2, c.duration3, c.percentage3, b.id AS bookingId, b.fromTime, b.paymentId, TRUNCATE(p_refund, 2) AS totalPrice, f.cityName 
						FROM user_pref u 
						JOIN facility f ON f.spUserId = u.userId 
						JOIN facility_cancellation_charges c ON c.id = f.cancellationPolicyId
						JOIN booking b ON b.facilityId = f.id 
						JOIN user_pref p ON p.userId = b.userId
						WHERE b.id = p_bookingId;
                    DELETE FROM booking WHERE id = p_bookingId;
                    SET p_count = 0;
                END IF;
            END IF;
		ELSEIF((p_type = 2 OR p_type = 3) AND v_userType = v_spTypeId) THEN
            SELECT id INTO v_pendStatus FROM status WHERE name = 'Verify request';
			SELECT id INTO v_approvedStatus FROM status WHERE name = 'Approved and Not Verified';
			SELECT id INTO v_verifiedStatus FROM status WHERE name = 'Approved and Verified';
			SELECT id INTO v_deactivateStatus FROM status WHERE name = 'Deactivated by SP';
			SELECT id INTO v_veriAndDeacStatus FROM status WHERE name = 'Verified And Deactivated by SP';
			SELECT status INTO v_days FROM facility WHERE id = p_facilityId;
            IF(v_days <> v_approvedStatus AND v_days <> v_verifiedStatus AND v_days <> v_pendStatus) THEN
				SET p_result = 14;
			ELSEIF((SELECT spUserId FROM facility WHERE id = p_facilityId) <> v_userId) THEN
				SET p_result = 15;
			ELSE
				IF(p_type = 2) THEN
					SELECT GROUP_CONCAT(id), COUNT(id) INTO v_bookingIds, p_count FROM booking WHERE (
											p_fromDateTime BETWEEN fromTime AND toTime OR 
											p_toDateTime BETWEEN fromTime AND toTime OR 
											fromTime BETWEEN p_fromDateTime AND p_toDateTime) 
											AND facilityId = p_facilityId AND (status = 1 OR status = 3) AND paymentMethod <> 'Offline';
				ELSE
					SELECT GROUP_CONCAT(id), COUNT(id) INTO v_bookingIds, p_count FROM booking WHERE fromTime >= NOW() AND facilityId = p_facilityId AND (status = 1 OR status = 3) AND paymentMethod <> 'Offline';
                END IF;
				IF((p_operation = 3 OR p_operation = 4) AND p_count = 0) THEN
					SET p_result = 16;
					IF(p_type = 3 AND p_operation = 4)THEN
						IF(v_days = v_verifiedStatus) THEN
							UPDATE facility SET status = v_veriAndDeacStatus WHERE id = p_facilityId;
                            INSERT INTO huddil.facility_history(`oldStatus`, `comments`, `facilityId`, `userId`)values(v_days, p_reason, p_facilityId, v_userId);
						ELSE
							UPDATE facility SET status = v_deactivateStatus WHERE id = p_facilityId;
                            INSERT INTO huddil.facility_history(`oldStatus`, `comments`, `facilityId`, `userId`)values(v_days, p_reason, p_facilityId, v_userId);
						END IF;						
                    END IF;
				ELSEIF(p_operation = 3 AND p_count <> 0) THEN
					SET p_result = 17;
					SELECT SUM(totalPrice) INTO p_totalPrice FROM booking WHERE FIND_IN_SET(id, v_bookingIds);
				ELSEIF(p_operation = 4 AND p_count <> 0) THEN
					SET p_result = 18;
					SELECT SUM(totalPrice) INTO p_totalPrice FROM booking WHERE FIND_IN_SET(id, v_bookingIds);
					INSERT INTO `huddil`.`cancellation`
						(`bookedFrom`, `bookedTo`, `bookedTime`, `seats`, `price`, `totalPrice`, `refundAmount`, `paymentId`, `paymentMethod`, `cancellationPolicyId`, `facilityId`, `bookedUserId`, `cancelledUserId`, `bookingId`, `bookedStatus`, `approvedTime`)
							SELECT fromTime, toTime, bookedTime, seats, price, totalPrice, totalPrice, paymentId, paymentMethod, cancellationPolicyId, facilityId, userId, v_userId, id, status, approvedTime FROM booking WHERE FIND_IN_SET(id, v_bookingIds);
					IF((SELECT typeName from facility WHERE id = p_facilityId) = 'Co-Working Space') THEN 
						UPDATE cancellation SET bookedStatus = 4 WHERE FIND_IN_SET(bookingId, v_bookingIds);
                    END IF;
					IF(p_type = 2) THEN
						INSERT INTO `huddil`.`facility_under_maintenance` (`fromDateTime`, `toDateTime`, `reason`, `facilityId`)
							VALUES (p_fromDateTime, p_toDateTime, p_reason, p_facilityId);
					ELSE
						IF(v_days = v_verifiedStatus) THEN
							UPDATE facility SET status = v_veriAndDeacStatus WHERE id = p_facilityId;
                            INSERT INTO huddil.facility_history(`oldStatus`, `comments`, `facilityId`, `userId`)values(v_days, p_reason, p_facilityId, v_userId);
						ELSE
							UPDATE facility SET status = v_deactivateStatus WHERE id = p_facilityId;
                            INSERT INTO huddil.facility_history(oldStatus, comments, facilityId, userId)values(v_days, p_reason, p_facilityId, v_userId);
                        END IF;
                    END IF;
                    SET p_cancel = LAST_INSERT_ID();
					SELECT u.displayName AS spName, u.emailId AS spEmailId, u.mobileNo AS spMobileNo, u.mobileNoVerified AS spMobileVerified, 
							p.displayName AS cName, p.emailId AS cEmailId, p.mobileNo AS cMobileNo, p.mobileNoVerified  AS cMobileVerified,
							c.duration1, c.percentage1, c.duration2, c.percentage2, c.duration3, c.percentage3, b.id AS bookingId, b.fromTime, b.paymentId, b.totalPrice, f.cityName 
						FROM user_pref u 
						JOIN facility f ON f.spUserId = u.userId 
						JOIN facility_cancellation_charges c ON c.id = f.cancellationPolicyId
						JOIN booking b ON b.facilityId = f.id 
						JOIN user_pref p ON p.userId = b.userId
						WHERE FIND_IN_SET(b.id, v_bookingIds);
					DELETE FROM booking WHERE FIND_IN_SET(id, v_bookingIds);
				END IF;
                SET p_cancellationPrice = p_totalPrice;
            END IF;
		ELSEIF(p_type = 4) THEN
			INSERT INTO `huddil`.`booking`
			(`id`, `fromTime`, `toTime`, `seats`, `price`, `totalPrice`, `cancellationPolicyId`, `paymentMethod`, `paymentId`, `userId`, `facilityId`, `bookedTime`, `status`, `approvedTime`)
				SELECT bookingId, bookedFrom, bookedTo, seats, price, totalPrice, cancellationPolicyId, paymentMethod, paymentId, bookedUserId, facilityId, bookedTime, bookedStatus, approvedTime FROM cancellation WHERE bookingId = p_bookingId;
			UPDATE booking SET status = 1 WHERE id = p_bookingId;
            DELETE FROM cancellation WHERE bookingId = p_bookingId;
			SET p_result = 19;
            IF(p_operation = 5)THEN
				SELECT oldStatus INTO v_bookingStatus FROM facility_history WHERE facilityId = p_facilityId order by dateTime desc LIMIT 1;
                UPDATE facility SET status = v_bookingStatus WHERE id = p_facilityId;
			END IF;            
        ELSE
			SET p_result = 5;
		END IF;
	END IF;
	SET p_refund = TRUNCATE(p_refund, 2);
	SET p_cancellationPrice = TRUNCATE(p_cancellationPrice, 2);
	SET p_totalPrice = TRUNCATE(p_totalPrice, 2);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `populateLeastCost` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `populateLeastCost`(IN populate BOOLEAN)
BEGIN

    DECLARE v_approverd INT;
    DECLARE v_verified INT;
    DECLARE v_pendingVerification INT;
    DECLARE v_verificationRejected INT;

	SELECT id INTO v_approverd FROM status WHERE name = 'Approved and Not Verified';
	SELECT id INTO v_verified FROM status WHERE name = 'Approved and Verified';
	SELECT id INTO v_pendingVerification FROM status WHERE name = 'Verify request';
	SELECT id INTO v_verificationRejected FROM status WHERE name = 'Reject Verify Request';

	IF(populate = TRUE) THEN
		UPDATE least_cost SET cost = 
			(SELECT costPerDay FROM facility f
				JOIN facility_type t ON f.typeName = t.name AND t.id = 1 AND (
                f.status = v_approverd OR f.status = v_verified OR f.status = v_pendingVerification OR f.status = v_verificationRejected) 
                AND costPerDay <> 0 ORDER BY costPerDay LIMIT 0, 1) WHERE id = 1;
		UPDATE least_cost SET cost = 
			(SELECT costPerDay FROM facility f
				JOIN facility_type t ON f.typeName = t.name AND t.id = 2 AND (
                f.status = v_approverd OR f.status = v_verified OR f.status = v_pendingVerification OR f.status = v_verificationRejected) 
                AND costPerDay <> 0 ORDER BY costPerDay LIMIT 0, 1) WHERE id = 2;
		UPDATE least_cost SET cost = 
			(SELECT costPerDay FROM facility f
				JOIN facility_type t ON f.typeName = t.name AND t.id = 3 AND (
                f.status = v_approverd OR f.status = v_verified OR f.status = v_pendingVerification OR f.status = v_verificationRejected) 
                AND costPerDay <> 0 ORDER BY costPerDay LIMIT 0, 1) WHERE id = 3;
		UPDATE least_cost SET cost = 
			(SELECT costPerDay FROM facility f
				JOIN facility_type t ON f.typeName = t.name AND t.id = 4 AND (
                f.status = v_approverd OR f.status = v_verified OR f.status = v_pendingVerification OR f.status = v_verificationRejected) 
                AND costPerDay <> 0 ORDER BY costPerDay LIMIT 0, 1) WHERE id = 4;
	ELSE
		SELECT * FROM least_cost;
	END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `schedulerHelper` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `schedulerHelper`()
BEGIN

    DECLARE v_ids MEDIUMTEXT;
    DECLARE v_spIds MEDIUMTEXT;
    DECLARE v_presentMonth INT;
    DECLARE v_month VARCHAR(90);
    DECLARE v_presentYear INT;

    SELECT group_concat(id) INTO v_ids FROM facility_offers  WHERE endDate < now();
    DELETE from facility_offers where FIND_IN_SET(id,v_ids);    
    IF(DAY(CURDATE()) = 1) THEN
       SET v_presentMonth = MONTH(CURRENT_DATE());
       SET v_presentYear = YEAR(CURRENT_DATE());

       IF(v_presentMonth <> 1) THEN
           SELECT GROUP_CONCAT(spUserId) INTO v_spIds FROM sp_commission WHERE year = v_presentYear AND FIND_IN_SET(v_presentMonth, month);
           IF(v_spIds IS NULL) THEN
               SELECT GROUP_CONCAT(spUserId) INTO v_spIds FROM sp_commission;
           ELSE
               SELECT GROUP_CONCAT(spUserId) INTO v_spIds FROM sp_commission WHERE NOT FIND_IN_SET(spUserId, v_spIds);
           END IF;
     
           UPDATE sp_commission SET month = CONCAT(month, ',', v_presentMonth)
          WHERE year = v_presentYear AND FIND_IN_SET(v_presentMonth - 1, month) AND FIND_IN_SET(spUserId, v_spIds);
       ELSE
           SELECT GROUP_CONCAT(spUserId) INTO v_spIds FROM sp_commission WHERE year = v_presentYear - 1 AND FIND_IN_SET(12, month);
           IF(v_spIds IS NULL) THEN
               SELECT GROUP_CONCAT(spUserId) INTO v_spIds FROM sp_commission;
           ELSE
               SELECT GROUP_CONCAT(spUserId) INTO v_spIds FROM sp_commission WHERE NOT FIND_IN_SET(spUserId, v_spIds);
           END IF;
     
           INSERT INTO `huddil`.`sp_commission`(`spUserId`, `month`, `year`, `commission`)
          SELECT spUserId, 1, v_presentYear, commission FROM sp_commission
           WHERE year = v_presentYear - 1 AND FIND_IN_SET(12, month) AND FIND_IN_SET(spUserId, v_spIds);
       END IF;
   END IF;    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `showAvailableFacilities` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `showAvailableFacilities`(IN v_sessionId VARCHAR(100),IN v_operation INT, IN v_fromDateTime TIMESTAMP, 
IN v_toDateTime TIMESTAMP, IN v_minCost DOUBLE, IN v_maxCost DOUBLE, IN v_maxCapacity INT, IN v_typeId INT, IN v_cityId INT, IN v_localityId INT, 
IN v_offers INT, IN v_amenity VARCHAR(50), IN v_pageNo INT, IN v_sortBy INT, IN v_orderBy INT, INOUT v_counting INT, OUT v_result INT)
BEGIN
    
/*v_operation = 1 -> Show Available Facilities for Consumer*/
/*v_operation = 2 -> Show all Facilities of SP*/
/*v_operation = 3 -> Getting Favorite Facilities of Consumer*/
/*v_operation = 4 -> Getting All the Facilities For Advisor*/

DECLARE p_fromDateTime TIMESTAMP;
DECLARE p_toDateTime TIMESTAMP;
DECLARE v_lowerBound INT;
DECLARE v_count INT;
DECLARE v_totalRecords INT;
DECLARE v_minCapacity INT;
DECLARE v_userType INT;
DECLARE v_fromTime TIME;
DECLARE v_toTime TIME;
DECLARE v_fromDay INT;
DECLARE v_toDay INT;
DECLARE v_Ids MEDIUMTEXT;

SET v_totalRecords = 0;
SET v_result = 0;
SET v_lowerBound = (v_pageNo - 1) * v_counting;

SET v_minCapacity = v_maxCapacity;
SET v_maxCapacity = v_minCapacity * 1.5;

SELECT userType INTO v_userType FROM user_pref WHERE sessionId = v_sessionId;
    IF(v_operation <> 1 AND v_userType IS NULL) THEN
		SET v_result = -1;
	ELSEIF(v_operation = 1)THEN
SELECT DATE_ADD(v_fromDateTime, INTERVAL 1 SECOND), DATE_SUB(v_toDateTime, INTERVAL 1 SECOND) INTO p_fromDateTime, p_toDateTime;

	SET @queryOne = "SELECT COUNT(DISTINCT f.id) INTO @v_totalRecords FROM huddil.facility f JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l on l.name = f.localityName JOIN huddil.location lo on lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName JOIN huddil.facility_photo p ON p.facilityId = f.id JOIN huddil.facility_amenity a ON a.facilityId = f.id _join";
    SET @query = "SELECT DISTINCT f.id, f.title, f.description,f.capacity, f.latitude, f.longtitude, f.costPerHour, f.costPerDay, f.costPerMonth, f.averageRating, f.size, f.status, f.contactNo, f.alternateContactNo, f.emailId, f.alternateEmailId, f.thumbnail, f.typeName, f.cityName as city, f.localityName as locality, lo.name as locationName, lo.landmark, lo.address, lo.nearBy, GROUP_CONCAT(DISTINCT a.amenityId) as Amenities, GROUP_CONCAT(DISTINCT p.imgPath) as imgPath FROM huddil.facility f JOIN huddil.city c ON c.name = f.cityName JOIN huddil.locality l on l.name = f.localityName JOIN huddil.location lo on lo.id = f.locationId JOIN huddil.facility_type t ON t.name = f.typeName JOIN huddil.facility_photo p ON p.facilityId = f.id JOIN huddil.facility_amenity a ON a.facilityId = f.id _join";
	
    IF(v_offers != 0)THEN
		SET @queryOne = REPLACE(@queryOne, ' _join','JOIN huddil.facility_offers o ON o.facilityId = f.id');
		SET @query = REPLACE(@query, ' _join','JOIN huddil.facility_offers o ON o.facilityId = f.id');
	ELSE
		SET @queryOne = REPLACE(@queryOne, ' _join', '');
		SET @query = REPLACE(@query, ' _join', '');
	END IF;
    
    IF(p_fromDateTime <> '' && p_toDateTime <> '')THEN	
		SET @queryOne = CONCAT(@queryOne, ' WHERE f.id NOT IN(SELECT b.facilityId FROM huddil.booking b WHERE (b.toTime >= \'',p_fromDateTime,'\'','  && b.fromTime <= \'',p_toDateTime,'\'',')) AND f.id NOT IN(SELECT m.facilityId FROM huddil.facility_under_maintenance m WHERE (m.toDateTime >= CAST(\'',p_fromDateTime,'\'',' AS DATE) && m.fromDateTime <= CAST(\'',p_toDateTime,'\'',' AS DATE)))');
		SET @query = CONCAT(@query, ' WHERE f.id NOT IN(SELECT b.facilityId FROM huddil.booking b WHERE (b.toTime >= \'',p_fromDateTime,'\'','  && b.fromTime <= \'',p_toDateTime,'\'',')) AND f.id NOT IN(SELECT m.facilityId FROM huddil.facility_under_maintenance m WHERE (m.toDateTime >= CAST(\'',p_fromDateTime,'\'',' AS DATE) && m.fromDateTime <= CAST(\'',p_toDateTime,'\'',' AS DATE)))');
	END IF;
    IF(v_cityId != 0 OR v_localityId != 0)THEN
		
		SET @queryOne = CONCAT(@queryOne, ' AND c.id = v_cityId');
		SET @query = CONCAT(@query, ' AND c.id = v_cityId');
	END IF;
    IF(v_localityId != 0)THEN
		
		SET @queryOne = CONCAT(@queryOne, ' AND l.id = v_localityId');
		SET @query = CONCAT(@query, ' AND l.id = v_localityId');
	END IF;
    
    IF(v_amenity = '')THEN
		
        SET @queryOne = CONCAT(@queryOne, ' ');
		SET @query = CONCAT(@query, ' ');
	ELSE
		SELECT (LENGTH(v_amenity) - LENGTH(REPLACE(v_amenity, ',', '')) + 1 ) INTO v_count;
        
        SET @queryOne = CONCAT(@queryOne, ' AND f.id IN (SELECT facilityId FROM huddil.facility_amenity WHERE amenityId IN(v_amenity) group by facilityId having count(facilityId) = v_count)');
		SET @query = CONCAT(@query, ' AND f.id IN (SELECT facilityId FROM huddil.facility_amenity WHERE amenityId IN(v_amenity) group by facilityId having count(facilityId) = v_count)');
	END IF;
    
    IF(v_maxCapacity !=0)THEN
    
		SET @queryOne = CONCAT(@queryOne, ' AND f.capacity BETWEEN v_minCapacity AND v_maxCapacity');
		SET @query = CONCAT(@query, ' AND f.capacity BETWEEN v_minCapacity AND v_maxCapacity');
	END IF;
	
    IF(v_maxCost !=0)THEN
    
		SET @queryOne = CONCAT(@queryOne, ' AND f.costPerDay BETWEEN v_minCost AND v_maxCost');
		SET @query = CONCAT(@query, ' AND f.costPerDay BETWEEN v_minCost AND v_maxCost');
	ELSEIF(v_minCost != 0) THEN
		SET @queryOne = CONCAT(@queryOne, ' AND f.costPerDay > v_minCost');
		SET @query = CONCAT(@query, ' AND f.costPerDay > v_minCost');
	END IF;
    
    IF(v_typeId !=0)THEN
    
		SET @queryOne = CONCAT(@queryOne, ' AND t.id = v_typeId');
		SET @query = CONCAT(@query, ' AND t.id = v_typeId');
        
    END IF;
    
    SET @queryOne = CONCAT(@queryOne, ' AND (f.status = 7 OR f.status = 8 OR f.status = 5)');
    SET @query = CONCAT(@query, ' AND (f.status = 7 OR f.status = 8 OR f.status = 5) GROUP by f.id order by condition LIMIT v_lowerBound, v_counting');
	
    IF(p_fromDateTime !=  '1970-11-01 00:00:02' && p_toDateTime != '1970-11-01 00:00:00')THEN
		
		SELECT TIME(v_fromDateTime), TIME(v_toDateTime) INTO v_fromTime, v_toTime;
		SELECT DAYOFWEEK(v_fromDateTime) INTO v_fromDay;
		SELECT DAYOFWEEK(v_toDateTime) INTO v_toDay;
				
        IF(v_fromDay = v_toDay)THEN
			
			SELECT GROUP_CONCAT(facilityId) INTO v_Ids FROM facility_timing t WHERE (t.closingTime >= v_toTime AND t.openingTime <= v_fromTime AND t.weekDay IN(v_fromDay));
            IF(v_Ids IS NULL) THEN
				SET v_Ids = 0;
			END IF;
			

		ELSE
			SELECT DISTINCT GROUP_CONCAT(facilityId) INTO v_Ids FROM (
				SELECT t.facilityId FROM facility_timing t WHERE 
				(t.openingTime <= v_fromTime AND t.closingTime >= v_fromTime AND t.weekDay IN (v_fromDay))) AS t1
				INNER JOIN (
				SELECT t.facilityId FROM facility_timing t WHERE
				(t.closingTime >= v_toTime AND t.openingTime <= v_toTime AND t.weekDay IN (v_toDay))) AS t2 USING(facilityId);
		END IF;	
        IF(v_Ids IS NOT NULL) THEN
			SET @query = REPLACE(@query, ' GROUP by f.id order by condition LIMIT v_lowerBound, v_counting', '');
			SET @query = CONCAT(@query, ' AND f.id IN (v_Ids) GROUP by f.id order by condition LIMIT v_lowerBound, v_counting');
			SET @queryOne = CONCAT(@queryOne, ' AND f.id IN (v_Ids)');
			SET @query = REPLACE(@query, 'v_Ids', v_Ids);
			SET @queryOne = REPLACE(@queryOne, 'v_Ids', v_Ids);
		END IF;
	END IF;
    
		
    IF(p_fromDateTime <> '' && p_toDateTime <> '')THEN
		
        SET @queryOne = REPLACE(@queryOne, 'p_fromDateTime', p_fromDateTime);
        SET @queryOne = REPLACE(@queryOne, 'p_toDateTime', p_toDateTime);
        
		SET @query = REPLACE(@query, 'p_fromDateTime', p_fromDateTime);
		SET @query = REPLACE(@query, 'p_toDateTime', p_toDateTime);
	END IF;
	
    IF(v_maxCost != 0)THEN
    
		SET @queryOne = REPLACE(@queryOne, 'v_minCost', v_minCost);
		SET @queryOne = REPLACE(@queryOne, 'v_maxCost', v_maxCost);
        
		SET @query = REPLACE(@query, 'v_minCost', v_minCost);
		SET @query = REPLACE(@query, 'v_maxCost', v_maxCost);
	ELSEIF(v_minCost != 0) THEN
		SET @queryOne = REPLACE(@queryOne, 'v_minCost', v_minCost);
		SET @query = REPLACE(@query, 'v_minCost', v_minCost);
	END IF;
    
    
	IF(v_sortBy = 0 && v_orderBy = 1) THEN
	  	 SET @query = REPLACE(@query, 'order by condition', 'order by f.averageRating asc');
	  ELSEIF(v_sortBy = 0 && v_orderBy = 0)THEN
	  	 SET @query = REPLACE(@query, 'order by condition', 'order by f.averageRating desc');
	END IF;
    
    IF(v_sortBy = 1 && v_orderBy = 1) THEN
       		SET @query = REPLACE(@query, 'GROUP by f.id order by condition', 'AND f.costPerHour !=0 GROUP by f.id order by f.costPerHour asc, f.averageRating desc');
            SET @queryOne = CONCAT(@queryOne, ' AND f.costPerHour !=0');
		ELSEIF(v_sortBy = 2 && v_orderBy = 1)THEN
	   		SET @query = REPLACE(@query, 'GROUP by f.id order by condition', 'AND f.costPerDay !=0 GROUP by f.id order by f.costPerDay asc, f.averageRating desc');
            SET @queryOne = CONCAT(@queryOne, ' AND f.costPerDay !=0');
		ELSEIF(v_sortBy =3 && v_orderBy = 1)THEN
			SET @query = REPLACE(@query, 'GROUP by f.id order by condition', 'AND f.costPerMonth !=0 GROUP by f.id order by f.costPerMonth asc, f.averageRating desc');
            SET @queryOne = CONCAT(@queryOne, ' AND f.costPerMonth !=0');
		ELSEIF(v_sortBy = 1 && v_orderBy = 0)THEN
			SET @query = REPLACE(@query, 'GROUP by f.id order by condition', 'AND f.costPerHour !=0 GROUP by f.id order by f.costPerHour desc, f.averageRating desc');
            SET @queryOne = CONCAT(@queryOne, ' AND f.costPerHour !=0');
		ELSEIF(v_sortBy = 2 && v_orderBy = 0)THEN
			SET @query= REPLACE(@query, 'GROUP by f.id order by condition', 'AND f.costPerDay !=0 GROUP by f.id order by f.costPerDay desc, f.averageRating desc');
            SET @queryOne = CONCAT(@queryOne, ' AND f.costPerDay !=0');
		ELSEIF(v_sortBy = 3 && v_orderBy = 0)THEN
			SET @query = REPLACE(@query, 'GROUP by f.id order by condition', 'AND f.costPerMonth !=0 GROUP by f.id order by f.costPerMonth desc, f.averageRating desc');
            SET @queryOne = CONCAT(@queryOne, ' AND f.costPerMonth !=0');
		ELSE
			SET @query = REPLACE(@query, 'order by condition', 'order by f.averageRating desc');
		END IF;
	
		    
    SET @queryOne = REPLACE(@queryOne, 'v_minCapacity', v_minCapacity);
    SET @queryOne = REPLACE(@queryOne, 'v_maxCapacity', v_maxCapacity);
    SET @queryOne = REPLACE(@queryOne, 'v_cityId', v_cityId);
	SET @queryOne = REPLACE(@queryOne, 'v_localityId', v_localityId);
    
	SET @query = REPLACE(@query, 'v_minCapacity', v_minCapacity);
    SET @query = REPLACE(@query, 'v_maxCapacity', v_maxCapacity);
    SET @query = REPLACE(@query, 'v_cityId', v_cityId);
	SET @query = REPLACE(@query, 'v_localityId', v_localityId);

	SET @query = REPLACE(@query, 'v_counting', v_counting);
    
    IF(v_amenity <> '')THEN
		
        SET @queryOne = REPLACE(@queryOne, 'v_amenity', v_amenity);
		SET @queryOne = REPLACE(@queryOne, 'v_count', v_count);
        
		SET @query = REPLACE(@query, 'v_amenity', v_amenity);
		SET @query = REPLACE(@query, 'v_count', v_count);
	END IF;
    
    SET @queryOne = REPLACE(@queryOne, 'v_typeId', v_typeId);
    SET @query = REPLACE(@query, 'v_typeId', v_typeId);
    
    SET @query = REPLACE(@query, 'v_lowerBound', v_lowerBound);

	PREPARE stmt FROM @query;
    EXECUTE stmt;
	
    PREPARE stmt FROM @queryOne;
    EXECUTE stmt;
    SET v_counting = @v_totalRecords;
    


/*Facility Listing for Service Provider*/
ELSEIF(v_operation = 2)THEN
    
    SELECT DISTINCT f.id, f.spUserId, f.title, f.description,f.capacity, f.latitude, f.longtitude, f.costPerHour, f.costPerDay, 
	f.costPerMonth, f.averageRating, f.size, f.status, f.contactNo, f.alternateContactNo, f.emailId, f.alternateEmailId, f.thumbnail, f.typeName, f.cityName as city, 
	f.localityName as locality, lo.name as locationName, lo.landmark, lo.address, lo.nearBy, GROUP_CONCAT(DISTINCT am.id) as Amenities, 
	GROUP_CONCAT(DISTINCT ph.imgPath) as imgPath FROM huddil.facility f 
		JOIN huddil.facility_photo ph ON ph.facilityId = f.id 
		JOIN huddil.facility_amenity a ON a.facilityId = f.id 
		JOIN huddil.amenity am ON am.id = a.amenityId 
		JOIN huddil.city c ON c.name = f.cityName 
		JOIN huddil.locality l ON l.name = f.localityName 
		JOIN huddil.location lo ON lo.id = f.locationId
		JOIN huddil.user_pref p ON p.userId = f.spUserId 
		WHERE p.sessionId = v_sessionId AND f.status > -1 group by f.id LIMIT v_lowerBound, v_counting;
        
        IF(v_pageNo = 1)THEN
			SELECT COUNT(DISTINCT f.id) INTO v_counting FROM huddil.facility f 
				JOIN huddil.facility_photo ph ON ph.facilityId = f.id 
				JOIN huddil.facility_amenity a ON a.facilityId = f.id 
				JOIN huddil.amenity am ON am.id = a.amenityId 
				JOIN huddil.city c ON c.name = f.cityName 
				JOIN huddil.locality l ON l.name = f.localityName 
				JOIN huddil.location lo ON lo.id = f.locationId
				JOIN huddil.user_pref p ON p.userId = f.spUserId 
					WHERE p.sessionId = v_sessionId AND f.status >-1;
		END IF;

/*Favorites Facility Listing for Consumer*/
ELSEIF(v_operation = 3)THEN

	SELECT f.id, f.title, f.description, f.capacity, f.latitude, f.longtitude, f.costPerHour, f.costPerDay, 
    f.costPerMonth, f.averageRating, f.size, f.status, f.contactNo, f.alternateContactNo, f.emailId, f.alternateEmailId, f.thumbnail, f.typeName, f.cityName as city, 
    f.localityName as locality, lo.name as locationName, lo.landmark, lo.address, lo.nearBy, GROUP_CONCAT(DISTINCT am.id) as Amenities, 
    GROUP_CONCAT(DISTINCT ph.imgPath) as imgPath FROM huddil.facility f 
		JOIN huddil.facility_photo ph ON ph.facilityId = f.id 
		JOIN huddil.facility_amenity a ON a.facilityId = f.id 
		JOIN huddil.amenity am ON am.id = a.amenityId 
		JOIN huddil.city c ON c.name = f.cityName 
		JOIN huddil.locality l ON l.name = f.localityName 
		JOIN huddil.location lo ON lo.id = f.locationId 
		RIGHT JOIN huddil.favorites fa ON fa.facilityId = f.id 
		JOIN huddil.user_pref p ON p.userId = fa.userId
			WHERE p.sessionId = v_sessionId AND f.status > -1 group by f.id LIMIT v_lowerBound, v_counting;
    
    IF(v_pageNo =1)THEN
		SELECT COUNT(DISTINCT f.id) INTO v_counting FROM huddil.facility f 
			JOIN huddil.facility_photo ph ON ph.facilityId = f.id 
			JOIN huddil.facility_amenity a ON a.facilityId = f.id 
			JOIN huddil.amenity am ON am.id = a.amenityId 
			JOIN huddil.city c ON c.name = f.cityName 
			JOIN huddil.locality l ON l.name = f.localityName 
			JOIN huddil.location lo ON lo.id = f.locationId 
			RIGHT JOIN huddil.favorites fa ON fa.facilityId = f.id 
			JOIN huddil.user_pref p ON p.userId = fa.userId
				WHERE p.sessionId = v_sessionId AND f.status > -1;
	END IF;

/*Facility Listing for Advisor*/
ELSEIF(v_operation = 4)THEN
		
    SELECT f.id, f.title, f.description,f.capacity, f.latitude, f.longtitude, f.costPerHour, f.costPerDay, 
    f.costPerMonth, f.averageRating, f.size, f.status, f.contactNo, f.alternateContactNo, f.emailId, f.alternateEmailId, f.thumbnail, f.typeName, f.cityName as city, 
    f.localityName as locality, lo.name as locationName, lo.landmark, lo.address, lo.nearBy, GROUP_CONCAT(DISTINCT am.id) as Amenities, 
    GROUP_CONCAT(DISTINCT ph.imgPath) as imgPath FROM huddil.facility f 
		JOIN huddil.facility_photo ph ON ph.facilityId = f.id 
		JOIN huddil.user_pref p 
		JOIN huddil.facility_amenity a ON a.facilityId = f.id 
		JOIN huddil.amenity am ON am.id = a.amenityId 
		JOIN huddil.city c ON c.name = f.cityName 
		JOIN huddil.locality l ON l.name = f.localityName 
		JOIN huddil.location lo ON lo.id = f.locationId 
					WHERE p.sessionId = v_sessionId AND (f.status = 1 OR f.status = 2 OR f.status = 5 OR f.status =6) group by f.id order by f.dateTime desc LIMIT v_lowerBound, v_counting;
    
    IF(v_pageNo = 1)THEN
		
		SELECT COUNT(DISTINCT f.id) INTO v_counting FROM huddil.facility f 
			JOIN huddil.facility_photo ph ON ph.facilityId = f.id 
			JOIN huddil.user_pref p 
			JOIN huddil.facility_amenity a ON a.facilityId = f.id 
			JOIN huddil.amenity am ON am.id = a.amenityId 
			JOIN huddil.city c ON c.name = f.cityName 
			JOIN huddil.locality l ON l.name = f.localityName 
			JOIN huddil.location lo ON lo.id = f.locationId 
						WHERE p.sessionId = v_sessionId AND (f.status = 1 OR f.status = 2 OR f.status = 5 OR f.status =6);
	END IF;
		
		END IF;
END;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `updateBookingStatusBySP` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `updateBookingStatusBySP`(IN p_sessionId VARCHAR(90), IN p_bookingId INT, IN p_status BOOLEAN, OUT p_flag INT)
BEGIN

	/*
		p_flag out param value
        1 - invalid session id
        2 - invalid user type
        3 - invalid booking id
        4 - invalid facility id
        5 - facility is not active
        6 - user not owner of facility
        7 - booking confirmed successsfully
        8 - invalid input status
        9 - booking is not in pending status
        10 - facility type is not co-working space
    */
    
	DECLARE v_userId INT;
	DECLARE v_userType INT;
    DECLARE v_facilityId INT;
	DECLARE v_facilityType VARCHAR(50);
	DECLARE v_facilityStatus INT;
    DECLARE v_spUserId INT;
	DECLARE v_approverd INT;
    DECLARE v_verified INT;
	DECLARE v_oldStatus INT;
	DECLARE v_confirmBooking INT;
    DECLARE v_cancelBooking INT;

	SELECT userId, userType INTO v_userId, v_userType FROM user_pref WHERE sessionId = p_sessionId;
    SELECT f.id, f.typeName, f.spUserId, f.status, b.id, b.status INTO v_facilityId, v_facilityType, v_spUserId, v_facilityStatus, p_bookingId, v_oldStatus
		FROM booking b JOIN facility f ON b.facilityId = f.id WHERE b.id = p_bookingId;
	SELECT id INTO v_approverd FROM status WHERE name = 'approved';
	SELECT id INTO v_verified FROM status WHERE name = 'verified';
	SELECT id INTO v_confirmBooking FROM booking_status WHERE name = 'confirmed';
	SELECT id INTO v_cancelBooking FROM booking_status WHERE name = 'cancelled';

    IF(v_userId IS NULL) THEN
		SET p_flag = 1;
	ELSEIF((SELECT id FROM user_type WHERE name = 'service provider') <> v_userType) THEN
		SET p_flag = 2;
	ELSEIF(p_bookingId IS NULL) THEN
		SET p_flag = 3;
	ELSEIF(v_facilityId IS NULL) THEN
		SET p_flag = 4;
	ELSEIF((v_facilityStatus <> v_approverd) AND (v_facilityStatus <> v_verified)) THEN
		SET p_flag = 5;
	ELSEIF(v_spUserId <> v_userId) THEN
		SET p_flag = 6;
	ELSEIF(v_facilityType = 'Co-Working Space') THEN
		IF(v_oldStatus = (SELECT id FROM booking_status WHERE name = 'pending')) THEN
			IF(p_status = 1) THEN
				UPDATE booking SET status = v_confirmBooking WHERE id = p_bookingId;
                SET p_flag = 7;
			ELSE
				SET p_flag = 8;
			END IF;
		ELSE
			SET p_flag = 9;
        END IF;
	ELSE
		SET p_flag = 10;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `updateFacilityPrice` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `updateFacilityPrice`(IN p_sessionId VARCHAR(90), IN p_facilityId INT, IN p_costPerHour DOUBLE, IN p_costPerDay DOUBLE, IN p_costPerMonth DOUBLE, OUT p_result INT)
BEGIN

DECLARE v_userId INT;
DECLARE v_facilityId INT;
DECLARE v_costPerHour DOUBLE;
DECLARE v_costPerDay DOUBLE;
DECLARE v_costPerMonth DOUBLE;

SELECT userId INTO v_userId FROM user_pref WHERE sessionId = p_sessionId;

	IF(v_userId IS NULL)THEN
		SET p_result = -1;
	ELSE
		SELECT id INTO v_facilityId FROM facility f JOIN user_pref p ON p.userId = f.spUserId WHERE p.sessionId = p_sessionId AND f.id = p_facilityId;
        
        IF(v_facilityId IS NULL)THEN
			SET p_result = -2;
		ELSE
			SELECT costPerHour, costPerDay, costPerMonth INTO v_costPerHour, v_costPerDay, v_costPerMonth FROM facility f WHERE id = p_facilityId;
			IF(p_costPerHour != 0.0 AND p_costPerHour != v_costPerHour)THEN
				SET v_costPerHour = p_costPerHour;
			END IF;
            IF(p_costPerDay != 0.0 AND p_costPerDay != v_costPerDay)THEN
				SET v_costPerDay = p_costPerDay;
			END IF;
            IF(p_costPerMonth != 0.0 AND p_costPerMonth != v_costPerMonth)THEN
				SET v_costPerMonth = p_costPerMonth;
			END IF;
            UPDATE facility SET costPerHour = v_costPerHour, costPerDay = v_costPerDay, costPerMonth = v_costPerMonth WHERE id = p_facilityId;
            SET p_result = 1;
		END IF;
	END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `updateSPCommission` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `updateSPCommission`(IN p_sessionId VARCHAR(100), IN p_spUserId INT, IN p_month VARCHAR(2), IN p_year INT, IN p_commission DOUBLE, OUT p_result INT)
BEGIN

   DECLARE v_Id INT;    
   DECLARE v_month MEDIUMTEXT;
   DECLARE v_Id_Exist MEDIUMTEXT;
   DECLARE v_commission DOUBLE;
   
   SET p_commission = p_commission/100;

   SELECT id, commission INTO v_Id, v_commission FROM sp_commission WHERE spUserId = p_spUserId AND year = p_year AND FIND_IN_SET(p_month, month);
   
   IF(v_Id IS NULL) THEN
       SELECT id, month, commission INTO v_Id, v_month, v_commission FROM sp_commission WHERE spUserId = p_spUserId AND year = p_year AND commission = p_commission;
		IF(v_commission IS NULL) THEN
           INSERT INTO sp_commission (spUserId, month, year, commission) VALUES (p_spUserId, p_month, p_year, p_commission);
           SET p_result = 1;
		ELSE
			SET v_month = CONCAT(v_month, ',', p_month);
			UPDATE sp_commission SET month = v_month WHERE id = v_Id;
			SET p_result = 1;
		END IF;
  ELSE
      IF(v_commission = p_commission) THEN
          SET p_result = 3;
      ELSE
          SELECT month INTO v_month FROM sp_commission WHERE id = v_Id;
           IF(v_month = p_month) THEN
               SELECT month, commission INTO v_month, v_commission FROM sp_commission WHERE spUserId = p_spUserId AND year = p_year AND commission = p_commission;
               IF(v_commission IS NOT NULL) THEN
                   UPDATE sp_commission SET commission = p_commission WHERE id = v_id;
                   SET p_result = 1;
               ELSE
					SET v_month = CONCAT(v_month, ',', p_month);
					UPDATE sp_commission SET month = v_month WHERE spUserId = p_spUserId AND year = p_year AND commission = p_commission;
					/*DELETE FROM sp_commission WHERE spUserId = p_spUserId AND year = p_year AND month = p_month;*/
					SET p_result = 1;
              END IF;
           ELSE
               SET v_month = REPLACE(REPLACE(v_month, CONCAT(',', p_month), ''), CONCAT(p_month, ','), '');
              UPDATE sp_commission SET month = v_month WHERE id = v_Id;
               INSERT INTO sp_commission (spUserId, month, year, commission) VALUES (p_spUserId, p_month, p_year, p_commission);            
              SET p_result = 1;
          END IF;
      END IF;
 END IF;                  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `searchBooking` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `searchBooking`(IN p_bookingId INT, IN p_cityId INT, 
IN p_localityId INT, IN p_status INT, IN p_month INT, IN p_typeId INT, IN p_sessionId VARCHAR(128), OUT p_result INT)
BEGIN

DECLARE v_flag INT;
DECLARE p_userId INT;
DECLARE p_userType INT;

SELECT p.userId, p.userType INTO p_userId, p_userType FROM user_pref p WHERE p.sessionId = p_sessionId;

IF(p_userId IS NOT NULL)THEN
	IF(p_userType = 6 OR p_userType = 7)THEN
		
		IF(p_status = 1 OR p_status = 3)THEN
			
			SET @query ="SELECT DISTINCT b.id as bookingId, b.fromTime as bookedFrom, b.toTime as bookedTo, b.bookedTime, b.approvedTime, b.totalPrice, 
						b.paymentMethod, b.status, f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM 
						booking b JOIN facility f ON f.id = b.facilityId JOIN location lo ON lo.id = f.locationId 
						JOIN user_pref p ON b.userId = p.userId _join WHERE b.id = p_bookingId AND f.spUserId = p_userId AND b.status <> 0 _add";
		ELSEIF(p_status = 2 OR p_status = 4)THEN
			
			SET @query = "SELECT DISTINCT b.bookingId, b.bookedFrom, b.bookedTo, b.bookedTime, b.approvedTime, b.totalPrice, 
						b.paymentMethod, IF(b.bookedStatus = 4, 4, 2) as status , f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM 
						cancellation b JOIN facility f ON f.id = b.facilityId JOIN location lo ON lo.id = f.locationId 
						JOIN user_pref p ON b.bookedUserId = p.userId _join WHERE b.bookingId = p_bookingId AND f.spUserId = p_userId _add";
		ELSEIF(p_status = 5)THEN
			
			SET @query = "SELECT DISTINCT b.bookingId, b.fromDateTime as bookedFrom, b.toDateTime as bookedTo, b.bookedTime, b.approvedTime, b.price as totalPrice, 
						b.paymentMethod, 5 as status, f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM 
						booking_history b JOIN facility f ON f.id = b.facilityId JOIN location lo ON lo.id = f.locationId 
						JOIN user_pref p ON b.userId = p.userId _join WHERE b.bookingId = p_bookingId AND f.spUserId = p_userId _add";
		ELSEIF(p_status = 0)THEN
			
			SET @query = "SELECT DISTINCT b.id as bookingId, b.fromTime as bookedFrom, b.toTime as bookedTo, b.bookedTime, b.approvedTime, b.totalPrice, 
						b.paymentMethod, b.status, f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM 
						booking b JOIN facility f ON f.id = b.facilityId JOIN location lo ON lo.id = f.locationId 
						JOIN user_pref p ON b.userId = p.userId _join WHERE b.id = p_bookingId AND f.spUserId = p_userId AND b.status <> 0 _add1 UNION SELECT DISTINCT b.bookingId, b.bookedFrom, b.bookedTo, b.bookedTime, b.approvedTime, b.totalPrice, 
						b.paymentMethod, IF(b.bookedStatus = 4, 4, 2) as status , f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM 
						cancellation b JOIN facility f ON f.id = b.facilityId JOIN location lo ON lo.id = f.locationId 
						JOIN user_pref p ON b.bookedUserId = p.userId _join WHERE b.bookingId = p_bookingId AND f.spUserId = p_userId _add2 UNION SELECT DISTINCT b.bookingId, b.fromDateTime as bookedFrom, b.toDateTime as bookedTo, b.bookedTime, b.approvedTime, b.price as totalPrice, 
						b.paymentMethod, 5 as status, f.title, f.typeName, lo.name, lo.address, p.displayName, p.emailId, p.mobileNo, b.seats FROM 
						booking_history b JOIN facility f ON f.id = b.facilityId JOIN location lo ON lo.id = f.locationId 
						JOIN user_pref p ON b.userId = p.userId _join WHERE b.bookingId = p_bookingId AND f.spUserId = p_userId _add3";
		END IF;
			IF(p_userType = 6)THEN
				SET @query = REPLACE(@query, ' AND f.spUserId = p_userId', '');
			END IF;
			IF(p_cityId <> 0)THEN
				SET @query = REPLACE(@query, '_join', 'JOIN city c ON c.name = f.cityName append');
				SET v_flag = 1;
			END IF;
			IF(p_localityId <> 0)THEN
				IF(v_flag = 1)THEN
					SET @query = REPLACE(@query, 'append', 'JOIN locality l ON l.name = f.localityName append');
				ELSE
					SET @query = REPLACE(@query, '_join', 'JOIN locality l ON l.name = f.localityName append');
					SET v_flag =1;
				END IF;
			END IF;
			IF(p_typeId <> 0)THEN
				IF(v_flag =1)THEN
					SET @query = REPLACE(@query, 'append', 'JOIN facility_type t ON t.name = f.typeName ');
				ELSE
					SET @query = REPLACE(@query, '_join', 'JOIN facility_type t ON t.name = f.typeName ');
					SET v_flag =1;
				END IF;
			END IF;
			IF(p_status = 1 OR p_status = 3)THEN
				SET @query = REPLACE(@query, 'b.status <> 0', 'b.status = p_status');
				SET @query = REPLACE(@query, 'p_status', p_status);
			END IF;
			IF(p_month <> 0 AND (p_status = 1 OR p_status =3))THEN
					SET @query = REPLACE(@query, '_add', 'AND month(b.bookedTime) = p_month');
				ELSEIF(p_month <> 0 AND (p_status = 5))THEN
					SET @query = REPLACE(@query, '_add', 'AND month(b.bookedTime) = p_month');
				ELSEIF(p_month <> 0 AND (p_status = 2 OR p_status = 4))THEN
					SET @query = REPLACE(@query, '_add', 'AND month(b.cancelledDateTime) = p_month');
				ELSEIF(p_month <> 0 AND p_status = 0)THEN
					SET @query = REPLACE(@query, '_add1', 'AND month(b.bookedTime) = p_month');
					SET @query = REPLACE(@query, '_add2', 'AND month(b.cancelledDateTime) = p_month');
					SET @query = REPLACE(@query, '_add3', 'AND month(b.bookedTime) = p_month');
				ELSEIF(p_month = 0 AND p_status = 0)THEN
					SET @query = REPLACE(@query, '_add1', '');
					SET @query = REPLACE(@query, '_add2', '');
					SET @query = REPLACE(@query, '_add3', '');
			END IF;
			IF(p_cityId = 0 AND p_localityId = 0 AND p_typeId =0)THEN
				SET @query = REPLACE(@query, '_join', '');
				SET @query = REPLACE(@query, '_add', '');
			END IF;		
			IF(p_cityId <> 0)THEN
				/*SET @query = REPLACE(@query, 'p_cityId', p_cityId);*/
				SET @query = REPLACE(@query, '_add', 'AND c.id= p_cityId _add');
				SET @query = REPLACE(@query, 'p_cityId', p_cityId);
			END IF;
			IF(p_localityId <> 0)THEN
				SET @query = REPLACE(@query, '_add', 'AND l.id = p_localityId _add');
				SET @query = REPLACE(@query, 'p_localityId', p_localityId);
			END IF;
			IF(p_bookingId <> 0)THEN
				SET @query = REPLACE(@query, 'p_bookingId', p_bookingId);
			END IF;
			IF(p_typeId <> 0)THEN
				SET @query = REPLACE(@query, '_add', 'AND t.id = p_typeId');
				SET @query = REPLACE(@query, 'p_typeId', p_typeId);
			END IF;
			IF(p_userId <> 0)THEN
				SET @query = REPLACE(@query, 'p_userId', p_userId);
			END IF;
			IF(p_month <> 0)THEN
				SET @query = REPLACE(@query, 'p_month', p_month);
			END IF;
		PREPARE stmt FROM @query;
		EXECUTE stmt;
		SET p_result = 1;
	ELSE
		SET p_result = -2;
	END IF;
ELSE
	SET p_result =-1;
END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;